<!DOCTYPE HTML>
<html lang>
<head>
<!-- Generated by javadoc (21) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: org.biojava.nbio.structure.secstruc, class: SecStrucCalc">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">/*</span>
<span class="source-line-no">002</span><span id="line-2"> *                    BioJava development code</span>
<span class="source-line-no">003</span><span id="line-3"> *</span>
<span class="source-line-no">004</span><span id="line-4"> * This code may be freely distributed and modified under the</span>
<span class="source-line-no">005</span><span id="line-5"> * terms of the GNU Lesser General Public Licence.  This should</span>
<span class="source-line-no">006</span><span id="line-6"> * be distributed with the code.  If you do not have a copy,</span>
<span class="source-line-no">007</span><span id="line-7"> * see:</span>
<span class="source-line-no">008</span><span id="line-8"> *</span>
<span class="source-line-no">009</span><span id="line-9"> *      http://www.gnu.org/copyleft/lesser.html</span>
<span class="source-line-no">010</span><span id="line-10"> *</span>
<span class="source-line-no">011</span><span id="line-11"> * Copyright for this code is held jointly by the individual</span>
<span class="source-line-no">012</span><span id="line-12"> * authors.  These should be listed in @author doc comments.</span>
<span class="source-line-no">013</span><span id="line-13"> *</span>
<span class="source-line-no">014</span><span id="line-14"> * For more information on the BioJava project and its aims,</span>
<span class="source-line-no">015</span><span id="line-15"> * or to join the biojava-l mailing list, visit the home page</span>
<span class="source-line-no">016</span><span id="line-16"> * at:</span>
<span class="source-line-no">017</span><span id="line-17"> *</span>
<span class="source-line-no">018</span><span id="line-18"> *      http://www.biojava.org/</span>
<span class="source-line-no">019</span><span id="line-19"> *</span>
<span class="source-line-no">020</span><span id="line-20"> */</span>
<span class="source-line-no">021</span><span id="line-21">package org.biojava.nbio.structure.secstruc;</span>
<span class="source-line-no">022</span><span id="line-22"></span>
<span class="source-line-no">023</span><span id="line-23">import org.biojava.nbio.structure.*;</span>
<span class="source-line-no">024</span><span id="line-24">import org.biojava.nbio.structure.contact.AtomContact;</span>
<span class="source-line-no">025</span><span id="line-25">import org.biojava.nbio.structure.contact.AtomContactSet;</span>
<span class="source-line-no">026</span><span id="line-26">import org.biojava.nbio.structure.contact.Grid;</span>
<span class="source-line-no">027</span><span id="line-27">import org.biojava.nbio.structure.contact.Pair;</span>
<span class="source-line-no">028</span><span id="line-28">import org.slf4j.Logger;</span>
<span class="source-line-no">029</span><span id="line-29">import org.slf4j.LoggerFactory;</span>
<span class="source-line-no">030</span><span id="line-30"></span>
<span class="source-line-no">031</span><span id="line-31">import java.util.ArrayList;</span>
<span class="source-line-no">032</span><span id="line-32">import java.util.Arrays;</span>
<span class="source-line-no">033</span><span id="line-33">import java.util.Collections;</span>
<span class="source-line-no">034</span><span id="line-34">import java.util.Comparator;</span>
<span class="source-line-no">035</span><span id="line-35">import java.util.HashMap;</span>
<span class="source-line-no">036</span><span id="line-36">import java.util.Iterator;</span>
<span class="source-line-no">037</span><span id="line-37">import java.util.List;</span>
<span class="source-line-no">038</span><span id="line-38">import java.util.Map;</span>
<span class="source-line-no">039</span><span id="line-39"></span>
<span class="source-line-no">040</span><span id="line-40">/**</span>
<span class="source-line-no">041</span><span id="line-41"> * Calculate and assign the secondary structure (SS) to the</span>
<span class="source-line-no">042</span><span id="line-42"> * Groups of a Structure object. This object also stores the result</span>
<span class="source-line-no">043</span><span id="line-43"> * of the calculation.</span>
<span class="source-line-no">044</span><span id="line-44"> * &lt;p&gt;</span>
<span class="source-line-no">045</span><span id="line-45"> * The rules for SS calculation are the ones defined by DSSP:</span>
<span class="source-line-no">046</span><span id="line-46"> * Kabsch,W. and Sander,C. (1983) Biopolymers 22, 2577-2637.</span>
<span class="source-line-no">047</span><span id="line-47"> * Original DSSP article see at:</span>
<span class="source-line-no">048</span><span id="line-48"> * &lt;a href="http://www.cmbi.kun.nl/gv/dssp/dssp.pdf"&gt;dssp.pdf&lt;/a&gt;.</span>
<span class="source-line-no">049</span><span id="line-49"> * Some parts are also taken from: T.E.Creighton, Proteins -</span>
<span class="source-line-no">050</span><span id="line-50"> * Structure and Molecular Properties, 2nd Edition, Freeman 1994.</span>
<span class="source-line-no">051</span><span id="line-51"> *</span>
<span class="source-line-no">052</span><span id="line-52"> * @author Andreas Prlic</span>
<span class="source-line-no">053</span><span id="line-53"> * @author Aleix Lafita</span>
<span class="source-line-no">054</span><span id="line-54"> * @author Anthony Bradley</span>
<span class="source-line-no">055</span><span id="line-55"> *</span>
<span class="source-line-no">056</span><span id="line-56"> */</span>
<span class="source-line-no">057</span><span id="line-57">public class SecStrucCalc {</span>
<span class="source-line-no">058</span><span id="line-58"></span>
<span class="source-line-no">059</span><span id="line-59">        /**</span>
<span class="source-line-no">060</span><span id="line-60">         * DSSP assigns helices one residue shorter at each end, because the</span>
<span class="source-line-no">061</span><span id="line-61">         * residues at (i-1) and (i+n+1) are not assigned helix type although</span>
<span class="source-line-no">062</span><span id="line-62">         * they contain a consistent turn (H-bond). If this parameter</span>
<span class="source-line-no">063</span><span id="line-63">         * is true, the helices will be the length of the original DSSP</span>
<span class="source-line-no">064</span><span id="line-64">         * convention. If it is false, they will be two residue longer.</span>
<span class="source-line-no">065</span><span id="line-65">         */</span>
<span class="source-line-no">066</span><span id="line-66">        private static final boolean DSSP_HELICES = true;</span>
<span class="source-line-no">067</span><span id="line-67"></span>
<span class="source-line-no">068</span><span id="line-68">        private static final Logger logger =</span>
<span class="source-line-no">069</span><span id="line-69">                        LoggerFactory.getLogger(SecStrucCalc.class);</span>
<span class="source-line-no">070</span><span id="line-70"></span>
<span class="source-line-no">071</span><span id="line-71">        /** min distance between two residues */</span>
<span class="source-line-no">072</span><span id="line-72">        public static final double MINDIST = 0.5;</span>
<span class="source-line-no">073</span><span id="line-73"></span>
<span class="source-line-no">074</span><span id="line-74">        /** min distance of two CA atoms if H-bonds are allowed to form */</span>
<span class="source-line-no">075</span><span id="line-75">        public static final double CA_MIN_DIST = 9.0;</span>
<span class="source-line-no">076</span><span id="line-76"></span>
<span class="source-line-no">077</span><span id="line-77">        /** max distance CA atoms in peptide bond (backbone discontinuity) */</span>
<span class="source-line-no">078</span><span id="line-78">        public static final double MAX_PEPTIDE_BOND_LENGTH = 2.5;</span>
<span class="source-line-no">079</span><span id="line-79"></span>
<span class="source-line-no">080</span><span id="line-80">        /** Minimal H-bond energy in cal/mol */</span>
<span class="source-line-no">081</span><span id="line-81">        public static final int HBONDLOWENERGY  = -9900;</span>
<span class="source-line-no">082</span><span id="line-82"></span>
<span class="source-line-no">083</span><span id="line-83">        /** higher limit for H-bond energy */</span>
<span class="source-line-no">084</span><span id="line-84">        public static final double HBONDHIGHENERGY = -500.0;</span>
<span class="source-line-no">085</span><span id="line-85"></span>
<span class="source-line-no">086</span><span id="line-86">        /**</span>
<span class="source-line-no">087</span><span id="line-87">         * constant for electrostatic energy</span>
<span class="source-line-no">088</span><span id="line-88">         * &lt;pre&gt;</span>
<span class="source-line-no">089</span><span id="line-89">         *      f  *  q1 *   q2  *  scale</span>
<span class="source-line-no">090</span><span id="line-90">         * Q = -332 * 0.42 * 0.20 * 1000.0</span>
<span class="source-line-no">091</span><span id="line-91">         *&lt;/pre&gt;</span>
<span class="source-line-no">092</span><span id="line-92">         *</span>
<span class="source-line-no">093</span><span id="line-93">         * q1 and q2 are partial charges which are placed on the C,O</span>
<span class="source-line-no">094</span><span id="line-94">         * (+q1,-q1) and N,H (-q2,+q2)</span>
<span class="source-line-no">095</span><span id="line-95">         */</span>
<span class="source-line-no">096</span><span id="line-96">        public static final double Q = -27888.0;</span>
<span class="source-line-no">097</span><span id="line-97"></span>
<span class="source-line-no">098</span><span id="line-98">        // Three lists</span>
<span class="source-line-no">099</span><span id="line-99">        private SecStrucGroup[] groups;</span>
<span class="source-line-no">100</span><span id="line-100">        private List&lt;Ladder&gt; ladders;</span>
<span class="source-line-no">101</span><span id="line-101">        private List&lt;BetaBridge&gt; bridges;</span>
<span class="source-line-no">102</span><span id="line-102">        private Atom[] atoms;</span>
<span class="source-line-no">103</span><span id="line-103">        // Added by Anthony - to speed up intergroup calculations</span>
<span class="source-line-no">104</span><span id="line-104">        private AtomContactSet contactSet;</span>
<span class="source-line-no">105</span><span id="line-105">        private Map&lt;ResidueNumber, Integer&gt; indResMap;</span>
<span class="source-line-no">106</span><span id="line-106">        public SecStrucCalc(){</span>
<span class="source-line-no">107</span><span id="line-107">                ladders = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">108</span><span id="line-108">                bridges = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">109</span><span id="line-109">        }</span>
<span class="source-line-no">110</span><span id="line-110"></span>
<span class="source-line-no">111</span><span id="line-111"></span>
<span class="source-line-no">112</span><span id="line-112">        /**</span>
<span class="source-line-no">113</span><span id="line-113">         * Predicts the secondary structure of this Structure object,</span>
<span class="source-line-no">114</span><span id="line-114">         * using a DSSP implementation.</span>
<span class="source-line-no">115</span><span id="line-115">         *</span>
<span class="source-line-no">116</span><span id="line-116">         * @param s Structure to predict the SS</span>
<span class="source-line-no">117</span><span id="line-117">         * @param assign sets the SS information to the Groups of s</span>
<span class="source-line-no">118</span><span id="line-118">         * @return a List of SS annotation objects</span>
<span class="source-line-no">119</span><span id="line-119">         */</span>
<span class="source-line-no">120</span><span id="line-120">        public List&lt;SecStrucState&gt; calculate(Structure s, boolean assign)</span>
<span class="source-line-no">121</span><span id="line-121">                        throws StructureException {</span>
<span class="source-line-no">122</span><span id="line-122"></span>
<span class="source-line-no">123</span><span id="line-123">                List&lt;SecStrucState&gt; secstruc = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">124</span><span id="line-124">                for(int i=0; i&lt;s.nrModels(); i++) {</span>
<span class="source-line-no">125</span><span id="line-125">                        // Reinitialise the global vars</span>
<span class="source-line-no">126</span><span id="line-126">                        ladders = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">127</span><span id="line-127">                        bridges = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">128</span><span id="line-128">                        groups = initGroupArray(s, i);</span>
<span class="source-line-no">129</span><span id="line-129">                        // Initialise the contact set for this structure</span>
<span class="source-line-no">130</span><span id="line-130">                        initContactSet();</span>
<span class="source-line-no">131</span><span id="line-131">                        if (groups.length &lt; 5) {</span>
<span class="source-line-no">132</span><span id="line-132">                                // not enough groups to do anything</span>
<span class="source-line-no">133</span><span id="line-133">                                throw new StructureException("Not enough backbone groups in the"</span>
<span class="source-line-no">134</span><span id="line-134">                                                + " Structure to calculate the secondary structure ("</span>
<span class="source-line-no">135</span><span id="line-135">                                                + groups.length+" given, minimum 5)" );</span>
<span class="source-line-no">136</span><span id="line-136">                        }</span>
<span class="source-line-no">137</span><span id="line-137"></span>
<span class="source-line-no">138</span><span id="line-138">                        calculateHAtoms();</span>
<span class="source-line-no">139</span><span id="line-139">                        calculateHBonds();</span>
<span class="source-line-no">140</span><span id="line-140">                        calculateDihedralAngles();</span>
<span class="source-line-no">141</span><span id="line-141">                        calculateTurns();</span>
<span class="source-line-no">142</span><span id="line-142">                        buildHelices();</span>
<span class="source-line-no">143</span><span id="line-143">                        detectBends();</span>
<span class="source-line-no">144</span><span id="line-144">                        detectStrands();</span>
<span class="source-line-no">145</span><span id="line-145"></span>
<span class="source-line-no">146</span><span id="line-146">                        for (SecStrucGroup sg : groups){</span>
<span class="source-line-no">147</span><span id="line-147">                                SecStrucState ss = (SecStrucState)</span>
<span class="source-line-no">148</span><span id="line-148">                                                sg.getProperty(Group.SEC_STRUC);</span>
<span class="source-line-no">149</span><span id="line-149">                                // Add to return list and assign to original if flag is true</span>
<span class="source-line-no">150</span><span id="line-150">                                secstruc.add(ss);</span>
<span class="source-line-no">151</span><span id="line-151">                                if (assign) sg.getOriginal().setProperty(Group.SEC_STRUC, ss);</span>
<span class="source-line-no">152</span><span id="line-152">                        }</span>
<span class="source-line-no">153</span><span id="line-153">                }</span>
<span class="source-line-no">154</span><span id="line-154">                return secstruc;</span>
<span class="source-line-no">155</span><span id="line-155">        }</span>
<span class="source-line-no">156</span><span id="line-156"></span>
<span class="source-line-no">157</span><span id="line-157">        /**</span>
<span class="source-line-no">158</span><span id="line-158">         * Function to generate the contact sets</span>
<span class="source-line-no">159</span><span id="line-159">         */</span>
<span class="source-line-no">160</span><span id="line-160">        private void initContactSet() {</span>
<span class="source-line-no">161</span><span id="line-161"></span>
<span class="source-line-no">162</span><span id="line-162">                // Initialise an array of atoms</span>
<span class="source-line-no">163</span><span id="line-163">                atoms = new Atom[groups.length];</span>
<span class="source-line-no">164</span><span id="line-164">                // Remake this local var</span>
<span class="source-line-no">165</span><span id="line-165">                indResMap = new HashMap&lt;&gt;();</span>
<span class="source-line-no">166</span><span id="line-166">                for (int i=0 ; i &lt; groups.length ; i++){</span>
<span class="source-line-no">167</span><span id="line-167">                        SecStrucGroup one = groups[i];</span>
<span class="source-line-no">168</span><span id="line-168">                        indResMap.put(one.getResidueNumber(), i);</span>
<span class="source-line-no">169</span><span id="line-169">                        atoms[i] = one.getCA();</span>
<span class="source-line-no">170</span><span id="line-170">                }</span>
<span class="source-line-no">171</span><span id="line-171">                Grid grid = new Grid(CA_MIN_DIST);</span>
<span class="source-line-no">172</span><span id="line-172">                if(atoms.length==0){</span>
<span class="source-line-no">173</span><span id="line-173">                        contactSet = new AtomContactSet(CA_MIN_DIST);</span>
<span class="source-line-no">174</span><span id="line-174">                }</span>
<span class="source-line-no">175</span><span id="line-175">                else{</span>
<span class="source-line-no">176</span><span id="line-176">                        grid.addAtoms(atoms);</span>
<span class="source-line-no">177</span><span id="line-177">                        contactSet = grid.getAtomContacts();</span>
<span class="source-line-no">178</span><span id="line-178">                }</span>
<span class="source-line-no">179</span><span id="line-179">        }</span>
<span class="source-line-no">180</span><span id="line-180"></span>
<span class="source-line-no">181</span><span id="line-181">        /**</span>
<span class="source-line-no">182</span><span id="line-182">         * Updated code to detect strands</span>
<span class="source-line-no">183</span><span id="line-183">         */</span>
<span class="source-line-no">184</span><span id="line-184">        private void detectStrands() {</span>
<span class="source-line-no">185</span><span id="line-185"></span>
<span class="source-line-no">186</span><span id="line-186">                //Find all the beta bridges of the structure</span>
<span class="source-line-no">187</span><span id="line-187">                findBridges();</span>
<span class="source-line-no">188</span><span id="line-188">                //Create Ladders</span>
<span class="source-line-no">189</span><span id="line-189">                createLadders();</span>
<span class="source-line-no">190</span><span id="line-190"></span>
<span class="source-line-no">191</span><span id="line-191">                //Detect beta bulges between ladders</span>
<span class="source-line-no">192</span><span id="line-192">                connectLadders();</span>
<span class="source-line-no">193</span><span id="line-193"></span>
<span class="source-line-no">194</span><span id="line-194">                //AND store SS assignments for Sheets, Strands and Bridges</span>
<span class="source-line-no">195</span><span id="line-195">                updateSheets();</span>
<span class="source-line-no">196</span><span id="line-196">        }</span>
<span class="source-line-no">197</span><span id="line-197"></span>
<span class="source-line-no">198</span><span id="line-198"></span>
<span class="source-line-no">199</span><span id="line-199">        private void createLadders(){</span>
<span class="source-line-no">200</span><span id="line-200"></span>
<span class="source-line-no">201</span><span id="line-201">                for (BetaBridge b : bridges){</span>
<span class="source-line-no">202</span><span id="line-202">                        boolean found = false;</span>
<span class="source-line-no">203</span><span id="line-203">                        for (Ladder ladder : ladders){</span>
<span class="source-line-no">204</span><span id="line-204">                                if (shouldExtendLadder(ladder, b)) {</span>
<span class="source-line-no">205</span><span id="line-205">                                        found = true;</span>
<span class="source-line-no">206</span><span id="line-206">                                        ladder.to++; //we go forward in this direction</span>
<span class="source-line-no">207</span><span id="line-207">                                        switch(b.type){</span>
<span class="source-line-no">208</span><span id="line-208">                                        case parallel:</span>
<span class="source-line-no">209</span><span id="line-209">                                                ladder.lto++; //increment second strand</span>
<span class="source-line-no">210</span><span id="line-210">                                                break;</span>
<span class="source-line-no">211</span><span id="line-211">                                        case antiparallel:</span>
<span class="source-line-no">212</span><span id="line-212">                                                ladder.lfrom--; //decrement second strand</span>
<span class="source-line-no">213</span><span id="line-213">                                                break;</span>
<span class="source-line-no">214</span><span id="line-214">                                        }</span>
<span class="source-line-no">215</span><span id="line-215">                                        break;</span>
<span class="source-line-no">216</span><span id="line-216">                                }</span>
<span class="source-line-no">217</span><span id="line-217">                        }</span>
<span class="source-line-no">218</span><span id="line-218">                        if (!found){</span>
<span class="source-line-no">219</span><span id="line-219">                                //Create new ladder with a single Bridge</span>
<span class="source-line-no">220</span><span id="line-220">                                Ladder l = new Ladder();</span>
<span class="source-line-no">221</span><span id="line-221">                                l.from = b.partner1;</span>
<span class="source-line-no">222</span><span id="line-222">                                l.to = b.partner1;</span>
<span class="source-line-no">223</span><span id="line-223">                                l.lfrom = b.partner2;</span>
<span class="source-line-no">224</span><span id="line-224">                                l.lto = b.partner2;</span>
<span class="source-line-no">225</span><span id="line-225">                                l.btype = b.type;</span>
<span class="source-line-no">226</span><span id="line-226">                                ladders.add(l);</span>
<span class="source-line-no">227</span><span id="line-227">                        }</span>
<span class="source-line-no">228</span><span id="line-228">                }</span>
<span class="source-line-no">229</span><span id="line-229">        }</span>
<span class="source-line-no">230</span><span id="line-230"></span>
<span class="source-line-no">231</span><span id="line-231"></span>
<span class="source-line-no">232</span><span id="line-232">        private void updateSheets() {</span>
<span class="source-line-no">233</span><span id="line-233"></span>
<span class="source-line-no">234</span><span id="line-234">                logger.debug(" got {} ladders!", ladders.size());</span>
<span class="source-line-no">235</span><span id="line-235"></span>
<span class="source-line-no">236</span><span id="line-236">                for (Ladder ladder : ladders){</span>
<span class="source-line-no">237</span><span id="line-237">                        logger.debug(ladder.toString());</span>
<span class="source-line-no">238</span><span id="line-238"></span>
<span class="source-line-no">239</span><span id="line-239">                        for (int lcount = ladder.from; lcount &lt;= ladder.to; lcount++) {</span>
<span class="source-line-no">240</span><span id="line-240"></span>
<span class="source-line-no">241</span><span id="line-241">                                SecStrucState state = getSecStrucState(lcount);</span>
<span class="source-line-no">242</span><span id="line-242">                                SecStrucType stype = state.getType();</span>
<span class="source-line-no">243</span><span id="line-243"></span>
<span class="source-line-no">244</span><span id="line-244">                                int diff = ladder.from - lcount;</span>
<span class="source-line-no">245</span><span id="line-245">                                int l2count = ladder.lfrom - diff ;</span>
<span class="source-line-no">246</span><span id="line-246"></span>
<span class="source-line-no">247</span><span id="line-247">                                SecStrucState state2 = getSecStrucState(l2count);</span>
<span class="source-line-no">248</span><span id="line-248">                                SecStrucType stype2 = state2.getType();</span>
<span class="source-line-no">249</span><span id="line-249"></span>
<span class="source-line-no">250</span><span id="line-250">                                if ( ladder.from != ladder.to ) {</span>
<span class="source-line-no">251</span><span id="line-251">                                        setSecStrucType(lcount, SecStrucType.extended);</span>
<span class="source-line-no">252</span><span id="line-252">                                        setSecStrucType(l2count, SecStrucType.extended);</span>
<span class="source-line-no">253</span><span id="line-253">                                }</span>
<span class="source-line-no">254</span><span id="line-254">                                else {</span>
<span class="source-line-no">255</span><span id="line-255">                                        if ( !stype.isHelixType() &amp;&amp;</span>
<span class="source-line-no">256</span><span id="line-256">                                                        ( !stype.equals(SecStrucType.extended)))</span>
<span class="source-line-no">257</span><span id="line-257">                                                setSecStrucType(lcount,SecStrucType.bridge);</span>
<span class="source-line-no">258</span><span id="line-258"></span>
<span class="source-line-no">259</span><span id="line-259">                                        if ( ! stype2.isHelixType() &amp;&amp;</span>
<span class="source-line-no">260</span><span id="line-260">                                                        (! stype2.equals(SecStrucType.extended)))</span>
<span class="source-line-no">261</span><span id="line-261">                                                setSecStrucType(l2count,SecStrucType.bridge);</span>
<span class="source-line-no">262</span><span id="line-262">                                }</span>
<span class="source-line-no">263</span><span id="line-263">                        }</span>
<span class="source-line-no">264</span><span id="line-264"></span>
<span class="source-line-no">265</span><span id="line-265">                        // Check if two ladders are connected. both sides are 'E'</span>
<span class="source-line-no">266</span><span id="line-266"></span>
<span class="source-line-no">267</span><span id="line-267">                        if (ladder.connectedTo == 0) continue;</span>
<span class="source-line-no">268</span><span id="line-268">                        Ladder conladder = ladders.get(ladder.connectedTo);</span>
<span class="source-line-no">269</span><span id="line-269"></span>
<span class="source-line-no">270</span><span id="line-270">                        if (ladder.btype.equals(BridgeType.antiparallel)) {</span>
<span class="source-line-no">271</span><span id="line-271">                                /* set one side */</span>
<span class="source-line-no">272</span><span id="line-272">                                for (int lcount = ladder.from; lcount &lt;= conladder.to;</span>
<span class="source-line-no">273</span><span id="line-273">                                                lcount++) {</span>
<span class="source-line-no">274</span><span id="line-274">                                        setSecStrucType(lcount, SecStrucType.extended);</span>
<span class="source-line-no">275</span><span id="line-275"></span>
<span class="source-line-no">276</span><span id="line-276">                                }</span>
<span class="source-line-no">277</span><span id="line-277">                                /* set other side */</span>
<span class="source-line-no">278</span><span id="line-278">                                for (int lcount = conladder.lto;</span>
<span class="source-line-no">279</span><span id="line-279">                                                lcount &lt;= ladder.lfrom;</span>
<span class="source-line-no">280</span><span id="line-280">                                                lcount++) {</span>
<span class="source-line-no">281</span><span id="line-281">                                        setSecStrucType(lcount, SecStrucType.extended);</span>
<span class="source-line-no">282</span><span id="line-282">                                }</span>
<span class="source-line-no">283</span><span id="line-283"></span>
<span class="source-line-no">284</span><span id="line-284">                        } else {</span>
<span class="source-line-no">285</span><span id="line-285">                                /* set one side */</span>
<span class="source-line-no">286</span><span id="line-286">                                for ( int lcount = ladder.from;</span>
<span class="source-line-no">287</span><span id="line-287">                                                lcount &lt;= conladder.to;</span>
<span class="source-line-no">288</span><span id="line-288">                                                lcount++) {</span>
<span class="source-line-no">289</span><span id="line-289"></span>
<span class="source-line-no">290</span><span id="line-290">                                        setSecStrucType(lcount, SecStrucType.extended);</span>
<span class="source-line-no">291</span><span id="line-291">                                }</span>
<span class="source-line-no">292</span><span id="line-292">                                /* set other side */</span>
<span class="source-line-no">293</span><span id="line-293">                                for ( int lcount =  ladder.lfrom;</span>
<span class="source-line-no">294</span><span id="line-294">                                                lcount &lt;= conladder.lto;</span>
<span class="source-line-no">295</span><span id="line-295">                                                lcount++) {</span>
<span class="source-line-no">296</span><span id="line-296"></span>
<span class="source-line-no">297</span><span id="line-297">                                        setSecStrucType(lcount, SecStrucType.extended);</span>
<span class="source-line-no">298</span><span id="line-298">                                }</span>
<span class="source-line-no">299</span><span id="line-299">                        }</span>
<span class="source-line-no">300</span><span id="line-300">                }</span>
<span class="source-line-no">301</span><span id="line-301">        }</span>
<span class="source-line-no">302</span><span id="line-302"></span>
<span class="source-line-no">303</span><span id="line-303">        private void connectLadders() {</span>
<span class="source-line-no">304</span><span id="line-304"></span>
<span class="source-line-no">305</span><span id="line-305">                for (int i = 0 ; i &lt; ladders.size(); i++) {</span>
<span class="source-line-no">306</span><span id="line-306">                        for ( int j = i ; j &lt; ladders.size(); j++){</span>
<span class="source-line-no">307</span><span id="line-307">                                Ladder l1 = ladders.get(i);</span>
<span class="source-line-no">308</span><span id="line-308">                                Ladder l2 = ladders.get(j);</span>
<span class="source-line-no">309</span><span id="line-309">                                if (hasBulge(l1,l2)) {</span>
<span class="source-line-no">310</span><span id="line-310">                                        l1.connectedTo = j;</span>
<span class="source-line-no">311</span><span id="line-311">                                        l2.connectedFrom = i;</span>
<span class="source-line-no">312</span><span id="line-312">                                        logger.debug("Bulge from {} to {}", i, j);</span>
<span class="source-line-no">313</span><span id="line-313">                                }</span>
<span class="source-line-no">314</span><span id="line-314">                        }</span>
<span class="source-line-no">315</span><span id="line-315">                }</span>
<span class="source-line-no">316</span><span id="line-316"></span>
<span class="source-line-no">317</span><span id="line-317"></span>
<span class="source-line-no">318</span><span id="line-318">        }</span>
<span class="source-line-no">319</span><span id="line-319"></span>
<span class="source-line-no">320</span><span id="line-320">        /**</span>
<span class="source-line-no">321</span><span id="line-321">         * For beta structures, we define explicitly: a bulge-linked</span>
<span class="source-line-no">322</span><span id="line-322">         * ladder consists of two (perfect) ladder or bridges of the</span>
<span class="source-line-no">323</span><span id="line-323">         * same type connected by at most one extra residue on one</span>
<span class="source-line-no">324</span><span id="line-324">         * strand and at most four extra residues on the other strand,</span>
<span class="source-line-no">325</span><span id="line-325">         * all residues in bulge-linked ladders are marked "E,"</span>
<span class="source-line-no">326</span><span id="line-326">         * including the extra residues.</span>
<span class="source-line-no">327</span><span id="line-327">         */</span>
<span class="source-line-no">328</span><span id="line-328">        private boolean hasBulge(Ladder l1, Ladder l2) {</span>
<span class="source-line-no">329</span><span id="line-329"></span>
<span class="source-line-no">330</span><span id="line-330">                boolean bulge = ((l1.btype.equals(l2.btype)) &amp;&amp;</span>
<span class="source-line-no">331</span><span id="line-331">                                (l2.from - l1.to &lt; 6) &amp;&amp;</span>
<span class="source-line-no">332</span><span id="line-332">                                (l1.to &lt; l2.from) &amp;&amp;</span>
<span class="source-line-no">333</span><span id="line-333">                                (l2.connectedTo == 0));</span>
<span class="source-line-no">334</span><span id="line-334"></span>
<span class="source-line-no">335</span><span id="line-335">                if (!bulge) return bulge;</span>
<span class="source-line-no">336</span><span id="line-336"></span>
<span class="source-line-no">337</span><span id="line-337">                switch(l1.btype){</span>
<span class="source-line-no">338</span><span id="line-338">                case parallel:</span>
<span class="source-line-no">339</span><span id="line-339">                        bulge = ( (l2.lfrom - l1.lto &gt; 0) &amp;&amp;</span>
<span class="source-line-no">340</span><span id="line-340">                                        ((( l2.lfrom -l1.lto &lt; 6) &amp;&amp;</span>
<span class="source-line-no">341</span><span id="line-341">                                                        (l2.from - l1.to &lt; 3)) ||</span>
<span class="source-line-no">342</span><span id="line-342">                                                        ( l2.lfrom - l1.lto &lt;3)));</span>
<span class="source-line-no">343</span><span id="line-343"></span>
<span class="source-line-no">344</span><span id="line-344">                        break;</span>
<span class="source-line-no">345</span><span id="line-345"></span>
<span class="source-line-no">346</span><span id="line-346">                case antiparallel:</span>
<span class="source-line-no">347</span><span id="line-347">                        bulge = ( (l1.lfrom - l2.lto &gt; 0) &amp;&amp;</span>
<span class="source-line-no">348</span><span id="line-348">                                        (((l1.lfrom -l2.lto &lt; 6) &amp;&amp;</span>
<span class="source-line-no">349</span><span id="line-349">                                                        ( l2.from - l1.to &lt; 3)) ||</span>
<span class="source-line-no">350</span><span id="line-350">                                                        (l1.lfrom - l2.lto &lt; 3)));</span>
<span class="source-line-no">351</span><span id="line-351"></span>
<span class="source-line-no">352</span><span id="line-352">                        break;</span>
<span class="source-line-no">353</span><span id="line-353">                }</span>
<span class="source-line-no">354</span><span id="line-354"></span>
<span class="source-line-no">355</span><span id="line-355">                return bulge;</span>
<span class="source-line-no">356</span><span id="line-356">        }</span>
<span class="source-line-no">357</span><span id="line-357"></span>
<span class="source-line-no">358</span><span id="line-358">        private void registerBridge(int i, int j, BridgeType btype) {</span>
<span class="source-line-no">359</span><span id="line-359"></span>
<span class="source-line-no">360</span><span id="line-360">                BetaBridge bridge = new BetaBridge(i,j,btype);</span>
<span class="source-line-no">361</span><span id="line-361"></span>
<span class="source-line-no">362</span><span id="line-362">                boolean b1 = getSecStrucState(i).addBridge(bridge);</span>
<span class="source-line-no">363</span><span id="line-363">                boolean b2 = getSecStrucState(j).addBridge(bridge);</span>
<span class="source-line-no">364</span><span id="line-364"></span>
<span class="source-line-no">365</span><span id="line-365">                if (!b1 &amp;&amp; !b2)</span>
<span class="source-line-no">366</span><span id="line-366">                        logger.warn("Ignoring Bridge between residues {} and {}. DSSP assignment might differ.", i, j);</span>
<span class="source-line-no">367</span><span id="line-367"></span>
<span class="source-line-no">368</span><span id="line-368">                bridges.add(bridge);</span>
<span class="source-line-no">369</span><span id="line-369">        }</span>
<span class="source-line-no">370</span><span id="line-370"></span>
<span class="source-line-no">371</span><span id="line-371">        /**</span>
<span class="source-line-no">372</span><span id="line-372">         * Conditions to extend a ladder with a given beta Bridge:</span>
<span class="source-line-no">373</span><span id="line-373">         * &lt;li&gt;The bridge and ladder are of the same type.</span>
<span class="source-line-no">374</span><span id="line-374">         * &lt;li&gt;The smallest bridge residue is sequential to the first</span>
<span class="source-line-no">375</span><span id="line-375">         *              strand ladder.</span>
<span class="source-line-no">376</span><span id="line-376">         * &lt;li&gt;The second bridge residue is either sequential (parallel)</span>
<span class="source-line-no">377</span><span id="line-377">         *              or previous (antiparallel) to the second strand of the ladder</span>
<span class="source-line-no">378</span><span id="line-378">         * &lt;/li&gt;</span>
<span class="source-line-no">379</span><span id="line-379">         * @param ladder the ladder candidate to extend</span>
<span class="source-line-no">380</span><span id="line-380">         * @param b the beta bridge that would extend the ladder</span>
<span class="source-line-no">381</span><span id="line-381">         * @return true if the bridge b extends the ladder</span>
<span class="source-line-no">382</span><span id="line-382">         */</span>
<span class="source-line-no">383</span><span id="line-383">        private boolean shouldExtendLadder(Ladder ladder, BetaBridge b) {</span>
<span class="source-line-no">384</span><span id="line-384"></span>
<span class="source-line-no">385</span><span id="line-385">                //Only extend if they are of the same type</span>
<span class="source-line-no">386</span><span id="line-386">                boolean sameType = b.type.equals(ladder.btype);</span>
<span class="source-line-no">387</span><span id="line-387">                if (!sameType) return false;</span>
<span class="source-line-no">388</span><span id="line-388"></span>
<span class="source-line-no">389</span><span id="line-389">                //Only extend if residue 1 is sequential to ladder strand</span>
<span class="source-line-no">390</span><span id="line-390">                boolean sequential = (b.partner1 == ladder.to+1);</span>
<span class="source-line-no">391</span><span id="line-391">                if (!sequential) return false;</span>
<span class="source-line-no">392</span><span id="line-392"></span>
<span class="source-line-no">393</span><span id="line-393">                switch(b.type){</span>
<span class="source-line-no">394</span><span id="line-394">                case parallel:</span>
<span class="source-line-no">395</span><span id="line-395">                        //Residue 2 should be sequential to second strand</span>
<span class="source-line-no">396</span><span id="line-396">                        if (b.partner2 == ladder.lto+1) return true;</span>
<span class="source-line-no">397</span><span id="line-397">                        break;</span>
<span class="source-line-no">398</span><span id="line-398">                case antiparallel:</span>
<span class="source-line-no">399</span><span id="line-399">                        //Residue 2 should be previous to second strand</span>
<span class="source-line-no">400</span><span id="line-400">                        if (b.partner2 == ladder.lfrom-1) return true;</span>
<span class="source-line-no">401</span><span id="line-401">                        break;</span>
<span class="source-line-no">402</span><span id="line-402">                }</span>
<span class="source-line-no">403</span><span id="line-403">                return false;</span>
<span class="source-line-no">404</span><span id="line-404">        }</span>
<span class="source-line-no">405</span><span id="line-405"></span>
<span class="source-line-no">406</span><span id="line-406"></span>
<span class="source-line-no">407</span><span id="line-407"></span>
<span class="source-line-no">408</span><span id="line-408"></span>
<span class="source-line-no">409</span><span id="line-409">        /**</span>
<span class="source-line-no">410</span><span id="line-410">         * Two nonoverlapping stretches of three residues each, i-1,i,i+1 and</span>
<span class="source-line-no">411</span><span id="line-411">         * j-1,j,j+1, form either a parallel or antiparallel bridge, depending on</span>
<span class="source-line-no">412</span><span id="line-412">         * which of two basic patterns is matched. We assign a bridge between</span>
<span class="source-line-no">413</span><span id="line-413">         * residues i and j if there are two H bonds characteristic of beta-</span>
<span class="source-line-no">414</span><span id="line-414">         * structure; in particular:</span>
<span class="source-line-no">415</span><span id="line-415">         * &lt;p&gt;</span>
<span class="source-line-no">416</span><span id="line-416">         * Parallel Bridge(i,j) =: [Hbond(i-1,j) and Hbond(j,i+1)]</span>
<span class="source-line-no">417</span><span id="line-417">         *                                                      or [Hbond(j-1,i) and Hbond(i,j+1)]</span>
<span class="source-line-no">418</span><span id="line-418">         * &lt;p&gt;</span>
<span class="source-line-no">419</span><span id="line-419">         * Antiparallel Bridge(i,j) =: [Hbond(i,j) and Hbond(j,i)]</span>
<span class="source-line-no">420</span><span id="line-420">         *                                                              or [Hbond(i-1,j+1) and Hbond(j-1,i+1)]</span>
<span class="source-line-no">421</span><span id="line-421">         *</span>
<span class="source-line-no">422</span><span id="line-422">         * Optimised to use the contact set</span>
<span class="source-line-no">423</span><span id="line-423">         */</span>
<span class="source-line-no">424</span><span id="line-424">        private void findBridges() {</span>
<span class="source-line-no">425</span><span id="line-425">                // Get the interator of contacts</span>
<span class="source-line-no">426</span><span id="line-426">                Iterator&lt;AtomContact&gt; myIter = contactSet.iterator();</span>
<span class="source-line-no">427</span><span id="line-427">                List&lt;Pair&lt;Integer&gt;&gt; outList = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">428</span><span id="line-428"></span>
<span class="source-line-no">429</span><span id="line-429">                // Now iterate through this</span>
<span class="source-line-no">430</span><span id="line-430">                while(myIter.hasNext()){</span>
<span class="source-line-no">431</span><span id="line-431">                        // Get the next atom contact</span>
<span class="source-line-no">432</span><span id="line-432">                        AtomContact ac = myIter.next();</span>
<span class="source-line-no">433</span><span id="line-433">                        Group g1 = ac.getPair().getFirst().getGroup();</span>
<span class="source-line-no">434</span><span id="line-434">                        Group g2 = ac.getPair().getSecond().getGroup();</span>
<span class="source-line-no">435</span><span id="line-435">                        // Get the indices</span>
<span class="source-line-no">436</span><span id="line-436">                        int i = indResMap.get(g1.getResidueNumber());</span>
<span class="source-line-no">437</span><span id="line-437">                        int j = indResMap.get(g2.getResidueNumber());</span>
<span class="source-line-no">438</span><span id="line-438">                        // If i&gt;j switch them over</span>
<span class="source-line-no">439</span><span id="line-439">                        if(i&gt;j){</span>
<span class="source-line-no">440</span><span id="line-440">                                // Switch them over</span>
<span class="source-line-no">441</span><span id="line-441">                                int old = i;</span>
<span class="source-line-no">442</span><span id="line-442">                                i = j;</span>
<span class="source-line-no">443</span><span id="line-443">                                j = old;</span>
<span class="source-line-no">444</span><span id="line-444">                        }</span>
<span class="source-line-no">445</span><span id="line-445">                        // Only these</span>
<span class="source-line-no">446</span><span id="line-446">                        if(j&lt;i+3){</span>
<span class="source-line-no">447</span><span id="line-447">                                continue;</span>
<span class="source-line-no">448</span><span id="line-448">                        }</span>
<span class="source-line-no">449</span><span id="line-449">                        // If it's the first</span>
<span class="source-line-no">450</span><span id="line-450">                        if(i==0){</span>
<span class="source-line-no">451</span><span id="line-451">                                continue;</span>
<span class="source-line-no">452</span><span id="line-452">                        }</span>
<span class="source-line-no">453</span><span id="line-453">                        if(j==0){</span>
<span class="source-line-no">454</span><span id="line-454">                                continue;</span>
<span class="source-line-no">455</span><span id="line-455">                        }</span>
<span class="source-line-no">456</span><span id="line-456">                        // If it's the last</span>
<span class="source-line-no">457</span><span id="line-457">                        if(i==groups.length-1){</span>
<span class="source-line-no">458</span><span id="line-458">                                continue;</span>
<span class="source-line-no">459</span><span id="line-459">                        }</span>
<span class="source-line-no">460</span><span id="line-460">                        if(j==groups.length-1){</span>
<span class="source-line-no">461</span><span id="line-461">                                continue;</span>
<span class="source-line-no">462</span><span id="line-462">                        }</span>
<span class="source-line-no">463</span><span id="line-463"></span>
<span class="source-line-no">464</span><span id="line-464">                        Pair&lt;Integer&gt; thisPair = new Pair&lt;&gt;(i,j);</span>
<span class="source-line-no">465</span><span id="line-465">                        outList.add(thisPair);</span>
<span class="source-line-no">466</span><span id="line-466">                }</span>
<span class="source-line-no">467</span><span id="line-467">                //</span>
<span class="source-line-no">468</span><span id="line-468">                Collections.sort(outList, new Comparator&lt;Pair&lt;Integer&gt;&gt;() {</span>
<span class="source-line-no">469</span><span id="line-469">                        @Override</span>
<span class="source-line-no">470</span><span id="line-470">                        public int compare(Pair&lt;Integer&gt; o1, Pair&lt;Integer&gt; o2) {</span>
<span class="source-line-no">471</span><span id="line-471">                                if(o1.getFirst()&lt;o2.getFirst()){</span>
<span class="source-line-no">472</span><span id="line-472">                                        return -1;</span>
<span class="source-line-no">473</span><span id="line-473">                                }</span>
<span class="source-line-no">474</span><span id="line-474">                                else if(o1.getFirst()&gt;o2.getFirst()){</span>
<span class="source-line-no">475</span><span id="line-475">                                        return +1;</span>
<span class="source-line-no">476</span><span id="line-476">                                }</span>
<span class="source-line-no">477</span><span id="line-477">                                else{</span>
<span class="source-line-no">478</span><span id="line-478">                                        if(o1.getSecond()&lt;o2.getSecond()){</span>
<span class="source-line-no">479</span><span id="line-479">                                                return -1;</span>
<span class="source-line-no">480</span><span id="line-480">                                        }</span>
<span class="source-line-no">481</span><span id="line-481">                                        else if(o1.getSecond()&gt;o2.getSecond()){</span>
<span class="source-line-no">482</span><span id="line-482">                                                return 1;</span>
<span class="source-line-no">483</span><span id="line-483">                                        }</span>
<span class="source-line-no">484</span><span id="line-484">                                        else{</span>
<span class="source-line-no">485</span><span id="line-485">                                                return 0;</span>
<span class="source-line-no">486</span><span id="line-486">                                        }</span>
<span class="source-line-no">487</span><span id="line-487">                                }</span>
<span class="source-line-no">488</span><span id="line-488">                        }</span>
<span class="source-line-no">489</span><span id="line-489">                });</span>
<span class="source-line-no">490</span><span id="line-490"></span>
<span class="source-line-no">491</span><span id="line-491"></span>
<span class="source-line-no">492</span><span id="line-492"></span>
<span class="source-line-no">493</span><span id="line-493">                for(Pair&lt;Integer&gt; p: outList){</span>
<span class="source-line-no">494</span><span id="line-494">                        int i = p.getFirst();</span>
<span class="source-line-no">495</span><span id="line-495">                        int j = p.getSecond();</span>
<span class="source-line-no">496</span><span id="line-496">                        BridgeType btype = null;</span>
<span class="source-line-no">497</span><span id="line-497">                        // Now do the bonding</span>
<span class="source-line-no">498</span><span id="line-498">                        if ((isBonded(i-1,j) &amp;&amp; isBonded(j,i+1)) ||</span>
<span class="source-line-no">499</span><span id="line-499">                                        (isBonded(j-1,i) &amp;&amp; isBonded(i,j+1))) {</span>
<span class="source-line-no">500</span><span id="line-500">                                btype = BridgeType.parallel;</span>
<span class="source-line-no">501</span><span id="line-501">                        }</span>
<span class="source-line-no">502</span><span id="line-502">                        else if ((isBonded(i,j) &amp;&amp; isBonded(j,i)) ||</span>
<span class="source-line-no">503</span><span id="line-503">                                        (isBonded(i-1,j+1) &amp;&amp; (isBonded(j-1,i+1)))) {</span>
<span class="source-line-no">504</span><span id="line-504">                                btype = BridgeType.antiparallel;</span>
<span class="source-line-no">505</span><span id="line-505">                        }</span>
<span class="source-line-no">506</span><span id="line-506">                        if (btype != null){</span>
<span class="source-line-no">507</span><span id="line-507">                                registerBridge(i, j, btype);</span>
<span class="source-line-no">508</span><span id="line-508">                        }</span>
<span class="source-line-no">509</span><span id="line-509">                }</span>
<span class="source-line-no">510</span><span id="line-510"></span>
<span class="source-line-no">511</span><span id="line-511"></span>
<span class="source-line-no">512</span><span id="line-512">        }</span>
<span class="source-line-no">513</span><span id="line-513"></span>
<span class="source-line-no">514</span><span id="line-514">        private void detectBends() {</span>
<span class="source-line-no">515</span><span id="line-515"></span>
<span class="source-line-no">516</span><span id="line-516">                for (int i = 2 ; i &lt; groups.length-2 ;i++){</span>
<span class="source-line-no">517</span><span id="line-517"></span>
<span class="source-line-no">518</span><span id="line-518">                        //Check if all atoms form peptide bonds (backbone discontinuity)</span>
<span class="source-line-no">519</span><span id="line-519">                        boolean bonded = true;</span>
<span class="source-line-no">520</span><span id="line-520">                        for (int k=0; k&lt;4; k++){</span>
<span class="source-line-no">521</span><span id="line-521">                                int index = i+k-2;</span>
<span class="source-line-no">522</span><span id="line-522">                                Atom C = groups[index].getC();</span>
<span class="source-line-no">523</span><span id="line-523">                                Atom N = groups[index+1].getN();</span>
<span class="source-line-no">524</span><span id="line-524">                                //Peptide bond C-N</span>
<span class="source-line-no">525</span><span id="line-525">                                if (Calc.getDistance(C, N) &gt; MAX_PEPTIDE_BOND_LENGTH){</span>
<span class="source-line-no">526</span><span id="line-526">                                        bonded = false;</span>
<span class="source-line-no">527</span><span id="line-527">                                        break;</span>
<span class="source-line-no">528</span><span id="line-528">                                }</span>
<span class="source-line-no">529</span><span id="line-529">                        }</span>
<span class="source-line-no">530</span><span id="line-530">                        if (!bonded) continue;</span>
<span class="source-line-no">531</span><span id="line-531"></span>
<span class="source-line-no">532</span><span id="line-532">                        SecStrucGroup im2 = groups[i-2];</span>
<span class="source-line-no">533</span><span id="line-533">                        SecStrucGroup g = groups[i];</span>
<span class="source-line-no">534</span><span id="line-534">                        SecStrucGroup ip2 = groups[i+2];</span>
<span class="source-line-no">535</span><span id="line-535"></span>
<span class="source-line-no">536</span><span id="line-536">                        Atom caim2 = im2.getCA();</span>
<span class="source-line-no">537</span><span id="line-537">                        Atom cag   = g.getCA();</span>
<span class="source-line-no">538</span><span id="line-538">                        Atom caip2 = ip2.getCA();</span>
<span class="source-line-no">539</span><span id="line-539"></span>
<span class="source-line-no">540</span><span id="line-540">                        //Create vectors ( Ca i to Ca i-2 ) ; ( Ca i to CA i + 2 )</span>
<span class="source-line-no">541</span><span id="line-541">                        Atom caminus2 = Calc.subtract(caim2,cag);</span>
<span class="source-line-no">542</span><span id="line-542">                        Atom caplus2  = Calc.subtract(cag,caip2);</span>
<span class="source-line-no">543</span><span id="line-543"></span>
<span class="source-line-no">544</span><span id="line-544">                        double angle = Calc.angle(caminus2, caplus2);</span>
<span class="source-line-no">545</span><span id="line-545"></span>
<span class="source-line-no">546</span><span id="line-546">                        SecStrucState state = getSecStrucState(i);</span>
<span class="source-line-no">547</span><span id="line-547">                        state.setKappa((float) angle);</span>
<span class="source-line-no">548</span><span id="line-548"></span>
<span class="source-line-no">549</span><span id="line-549">                        //Angles = 360 should be discarded</span>
<span class="source-line-no">550</span><span id="line-550">                        if (angle &gt; 70.0 &amp;&amp; angle &lt; 359.99) {</span>
<span class="source-line-no">551</span><span id="line-551">                                setSecStrucType(i, SecStrucType.bend);</span>
<span class="source-line-no">552</span><span id="line-552">                                state.setBend(true);</span>
<span class="source-line-no">553</span><span id="line-553">                        }</span>
<span class="source-line-no">554</span><span id="line-554">                }</span>
<span class="source-line-no">555</span><span id="line-555">        }</span>
<span class="source-line-no">556</span><span id="line-556"></span>
<span class="source-line-no">557</span><span id="line-557">        private void calculateDihedralAngles()  {</span>
<span class="source-line-no">558</span><span id="line-558"></span>
<span class="source-line-no">559</span><span id="line-559">                // dihedral angles</span>
<span class="source-line-no">560</span><span id="line-560">                // phi: C-N-CA-C</span>
<span class="source-line-no">561</span><span id="line-561">                // psi: N-CA-C-N</span>
<span class="source-line-no">562</span><span id="line-562">                // Chi1: N-CA-CB-CG, N-CA-CB-OG(SER),N-CA-CB-OG1(Thr),</span>
<span class="source-line-no">563</span><span id="line-563">                // N-CA-CB-CG1(ILE/VAL), N-CA-CB-SG(CYS)</span>
<span class="source-line-no">564</span><span id="line-564">                // Omega: CA-C-N-CA</span>
<span class="source-line-no">565</span><span id="line-565"></span>
<span class="source-line-no">566</span><span id="line-566">                for (int i=0 ; i &lt; groups.length-1 ;  i++){</span>
<span class="source-line-no">567</span><span id="line-567"></span>
<span class="source-line-no">568</span><span id="line-568">                        SecStrucGroup a = groups[i];</span>
<span class="source-line-no">569</span><span id="line-569">                        SecStrucGroup b = groups[i+1];</span>
<span class="source-line-no">570</span><span id="line-570"></span>
<span class="source-line-no">571</span><span id="line-571">                        Atom a_N   = a.getN();</span>
<span class="source-line-no">572</span><span id="line-572">                        Atom a_CA  = a.getCA();</span>
<span class="source-line-no">573</span><span id="line-573">                        Atom a_C  = a.getC();</span>
<span class="source-line-no">574</span><span id="line-574"></span>
<span class="source-line-no">575</span><span id="line-575">                        Atom b_N  = b.getN();</span>
<span class="source-line-no">576</span><span id="line-576">                        Atom b_CA = b.getCA();</span>
<span class="source-line-no">577</span><span id="line-577">                        Atom b_C  = b.getC();</span>
<span class="source-line-no">578</span><span id="line-578"></span>
<span class="source-line-no">579</span><span id="line-579">                        double phi = Calc.torsionAngle(a_C,b_N,b_CA,b_C);</span>
<span class="source-line-no">580</span><span id="line-580">                        double psi = Calc.torsionAngle(a_N,a_CA,a_C,b_N);</span>
<span class="source-line-no">581</span><span id="line-581">                        double omega = Calc.torsionAngle(a_CA,a_C,b_N,b_CA);</span>
<span class="source-line-no">582</span><span id="line-582"></span>
<span class="source-line-no">583</span><span id="line-583">                        SecStrucState state1 = (SecStrucState)</span>
<span class="source-line-no">584</span><span id="line-584">                                        a.getProperty(Group.SEC_STRUC);</span>
<span class="source-line-no">585</span><span id="line-585">                        SecStrucState state2 = (SecStrucState)</span>
<span class="source-line-no">586</span><span id="line-586">                                        b.getProperty(Group.SEC_STRUC);</span>
<span class="source-line-no">587</span><span id="line-587"></span>
<span class="source-line-no">588</span><span id="line-588">                        state2.setPhi(phi);</span>
<span class="source-line-no">589</span><span id="line-589">                        state1.setPsi(psi);</span>
<span class="source-line-no">590</span><span id="line-590">                        state1.setOmega(omega);</span>
<span class="source-line-no">591</span><span id="line-591">                }</span>
<span class="source-line-no">592</span><span id="line-592">        }</span>
<span class="source-line-no">593</span><span id="line-593"></span>
<span class="source-line-no">594</span><span id="line-594">        @Override</span>
<span class="source-line-no">595</span><span id="line-595">        public String toString() {</span>
<span class="source-line-no">596</span><span id="line-596">                return printDSSP();</span>
<span class="source-line-no">597</span><span id="line-597">        }</span>
<span class="source-line-no">598</span><span id="line-598"></span>
<span class="source-line-no">599</span><span id="line-599">        /**</span>
<span class="source-line-no">600</span><span id="line-600">         * Generate a DSSP file format ouput String of this SS prediction.</span>
<span class="source-line-no">601</span><span id="line-601">         * @return String in DSSP output file format</span>
<span class="source-line-no">602</span><span id="line-602">         */</span>
<span class="source-line-no">603</span><span id="line-603">        public String printDSSP() {</span>
<span class="source-line-no">604</span><span id="line-604"></span>
<span class="source-line-no">605</span><span id="line-605">                StringBuffer buf = new StringBuffer();</span>
<span class="source-line-no">606</span><span id="line-606">                String nl = System.getProperty("line.separator");</span>
<span class="source-line-no">607</span><span id="line-607"></span>
<span class="source-line-no">608</span><span id="line-608">                //Header Line</span>
<span class="source-line-no">609</span><span id="line-609">                buf.append("==== Secondary Structure Definition by BioJava"</span>
<span class="source-line-no">610</span><span id="line-610">                                + " DSSP implementation, Version October 2015 ===="+nl);</span>
<span class="source-line-no">611</span><span id="line-611"></span>
<span class="source-line-no">612</span><span id="line-612">                //First line with column definition</span>
<span class="source-line-no">613</span><span id="line-613">                buf.append("  #  RESIDUE AA STRUCTURE BP1 BP2  ACC     "</span>
<span class="source-line-no">614</span><span id="line-614">                                + "N-H--&gt;O    O--&gt;H-N    N-H--&gt;O    O--&gt;H-N    "</span>
<span class="source-line-no">615</span><span id="line-615">                                + "TCO  KAPPA ALPHA  PHI    PSI    "</span>
<span class="source-line-no">616</span><span id="line-616">                                + "X-CA   Y-CA   Z-CA ");</span>
<span class="source-line-no">617</span><span id="line-617"></span>
<span class="source-line-no">618</span><span id="line-618">                for (int i =0 ; i &lt; groups.length ;i++){</span>
<span class="source-line-no">619</span><span id="line-619">                        buf.append(nl);</span>
<span class="source-line-no">620</span><span id="line-620">                        SecStrucState ss = getSecStrucState(i);</span>
<span class="source-line-no">621</span><span id="line-621">                        buf.append(ss.printDSSPline(i));</span>
<span class="source-line-no">622</span><span id="line-622">                }</span>
<span class="source-line-no">623</span><span id="line-623"></span>
<span class="source-line-no">624</span><span id="line-624">                return buf.toString();</span>
<span class="source-line-no">625</span><span id="line-625">        }</span>
<span class="source-line-no">626</span><span id="line-626"></span>
<span class="source-line-no">627</span><span id="line-627">        /**</span>
<span class="source-line-no">628</span><span id="line-628">         * Generate a summary of this SS prediction with information about</span>
<span class="source-line-no">629</span><span id="line-629">         * the three types of helix turns in different row sequences.</span>
<span class="source-line-no">630</span><span id="line-630">         * &lt;p&gt;</span>
<span class="source-line-no">631</span><span id="line-631">         * This is similar to the summary output of Jmol, and useful to visualize</span>
<span class="source-line-no">632</span><span id="line-632">         * the helix patterns.</span>
<span class="source-line-no">633</span><span id="line-633">         *</span>
<span class="source-line-no">634</span><span id="line-634">         * @return String helix summary</span>
<span class="source-line-no">635</span><span id="line-635">         */</span>
<span class="source-line-no">636</span><span id="line-636">        public String printHelixSummary() {</span>
<span class="source-line-no">637</span><span id="line-637"></span>
<span class="source-line-no">638</span><span id="line-638">                StringBuffer g = new StringBuffer(); //3-10 helix</span>
<span class="source-line-no">639</span><span id="line-639">                StringBuffer h = new StringBuffer(); //alpha helix</span>
<span class="source-line-no">640</span><span id="line-640">                StringBuffer i = new StringBuffer(); //pi-helix</span>
<span class="source-line-no">641</span><span id="line-641">                StringBuffer ss = new StringBuffer(); //SS summary</span>
<span class="source-line-no">642</span><span id="line-642">                StringBuffer aa = new StringBuffer(); //AA one-letter</span>
<span class="source-line-no">643</span><span id="line-643">                String nl = System.getProperty("line.separator");</span>
<span class="source-line-no">644</span><span id="line-644"></span>
<span class="source-line-no">645</span><span id="line-645">                g.append(       "3 turn: ");</span>
<span class="source-line-no">646</span><span id="line-646">                h.append(       "4 turn: ");</span>
<span class="source-line-no">647</span><span id="line-647">                i.append(       "5 turn: ");</span>
<span class="source-line-no">648</span><span id="line-648">                ss.append(      "SS:     ");</span>
<span class="source-line-no">649</span><span id="line-649">                aa.append(      "AA:     ");</span>
<span class="source-line-no">650</span><span id="line-650"></span>
<span class="source-line-no">651</span><span id="line-651">                for (int k = 0; k &lt; groups.length; k++){</span>
<span class="source-line-no">652</span><span id="line-652"></span>
<span class="source-line-no">653</span><span id="line-653">                        SecStrucState state = getSecStrucState(k);</span>
<span class="source-line-no">654</span><span id="line-654">                        g.append(state.getTurn()[0]);</span>
<span class="source-line-no">655</span><span id="line-655">                        h.append(state.getTurn()[1]);</span>
<span class="source-line-no">656</span><span id="line-656">                        i.append(state.getTurn()[2]);</span>
<span class="source-line-no">657</span><span id="line-657">                        ss.append(state.getType());</span>
<span class="source-line-no">658</span><span id="line-658">                        aa.append(StructureTools.get1LetterCode(groups[k].getPDBName()));</span>
<span class="source-line-no">659</span><span id="line-659">                }</span>
<span class="source-line-no">660</span><span id="line-660"></span>
<span class="source-line-no">661</span><span id="line-661">                return g.toString()+nl+h.toString()+nl+</span>
<span class="source-line-no">662</span><span id="line-662">                                i.toString()+nl+ss.toString()+nl+aa.toString();</span>
<span class="source-line-no">663</span><span id="line-663">        }</span>
<span class="source-line-no">664</span><span id="line-664"></span>
<span class="source-line-no">665</span><span id="line-665">        /**</span>
<span class="source-line-no">666</span><span id="line-666">         * Generate a FASTA sequence with the SS annotation letters in the</span>
<span class="source-line-no">667</span><span id="line-667">         * aminoacid sequence order.</span>
<span class="source-line-no">668</span><span id="line-668">         * @return String in FASTA sequence format</span>
<span class="source-line-no">669</span><span id="line-669">         */</span>
<span class="source-line-no">670</span><span id="line-670">        public String printFASTA() {</span>
<span class="source-line-no">671</span><span id="line-671"></span>
<span class="source-line-no">672</span><span id="line-672">                StringBuffer buf = new StringBuffer();</span>
<span class="source-line-no">673</span><span id="line-673">                String nl = System.getProperty("line.separator");</span>
<span class="source-line-no">674</span><span id="line-674">                buf.append("&gt;"+groups[0].getChain().getStructure().getIdentifier()+nl);</span>
<span class="source-line-no">675</span><span id="line-675"></span>
<span class="source-line-no">676</span><span id="line-676">                for (int g = 0; g &lt; groups.length; g++){</span>
<span class="source-line-no">677</span><span id="line-677">                        buf.append(getSecStrucState(g).getType());</span>
<span class="source-line-no">678</span><span id="line-678">                }</span>
<span class="source-line-no">679</span><span id="line-679">                return buf.toString();</span>
<span class="source-line-no">680</span><span id="line-680">        }</span>
<span class="source-line-no">681</span><span id="line-681"></span>
<span class="source-line-no">682</span><span id="line-682">        @Override</span>
<span class="source-line-no">683</span><span id="line-683">        public int hashCode() {</span>
<span class="source-line-no">684</span><span id="line-684">            final int prime = 31;</span>
<span class="source-line-no">685</span><span id="line-685">            int result = 1;</span>
<span class="source-line-no">686</span><span id="line-686">            result = prime * result + Arrays.hashCode(atoms);</span>
<span class="source-line-no">687</span><span id="line-687">            return result;</span>
<span class="source-line-no">688</span><span id="line-688">        }</span>
<span class="source-line-no">689</span><span id="line-689"></span>
<span class="source-line-no">690</span><span id="line-690">        @Override</span>
<span class="source-line-no">691</span><span id="line-691">        public boolean equals(Object o){</span>
<span class="source-line-no">692</span><span id="line-692"></span>
<span class="source-line-no">693</span><span id="line-693">                if (!(o instanceof SecStrucCalc)) return false;</span>
<span class="source-line-no">694</span><span id="line-694">                else {</span>
<span class="source-line-no">695</span><span id="line-695">                        SecStrucCalc ss = (SecStrucCalc) o;</span>
<span class="source-line-no">696</span><span id="line-696">                        if (groups.length != ss.groups.length) return false;</span>
<span class="source-line-no">697</span><span id="line-697"></span>
<span class="source-line-no">698</span><span id="line-698">                        for (int g=0; g&lt;groups.length; g++){</span>
<span class="source-line-no">699</span><span id="line-699">                                SecStrucInfo g1 = getSecStrucState(g);</span>
<span class="source-line-no">700</span><span id="line-700">                                SecStrucInfo g2 = ss.getSecStrucState(g);</span>
<span class="source-line-no">701</span><span id="line-701">                                if (!g1.equals(g2)) return false;</span>
<span class="source-line-no">702</span><span id="line-702">                        }</span>
<span class="source-line-no">703</span><span id="line-703">                        return true;</span>
<span class="source-line-no">704</span><span id="line-704">                }</span>
<span class="source-line-no">705</span><span id="line-705">        }</span>
<span class="source-line-no">706</span><span id="line-706"></span>
<span class="source-line-no">707</span><span id="line-707">        private static SecStrucGroup[] initGroupArray(Structure s, int modelId) {</span>
<span class="source-line-no">708</span><span id="line-708">                List&lt;SecStrucGroup&gt; groupList = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">709</span><span id="line-709">                //</span>
<span class="source-line-no">710</span><span id="line-710">                for ( Chain c : s.getChains(modelId)){</span>
<span class="source-line-no">711</span><span id="line-711"></span>
<span class="source-line-no">712</span><span id="line-712">                        for (Group g : c.getAtomGroups()){</span>
<span class="source-line-no">713</span><span id="line-713"></span>
<span class="source-line-no">714</span><span id="line-714">                                //We can also calc secstruc if it is a modified amino acid</span>
<span class="source-line-no">715</span><span id="line-715">                                if ( g.hasAminoAtoms()) {</span>
<span class="source-line-no">716</span><span id="line-716"></span>
<span class="source-line-no">717</span><span id="line-717">                                        SecStrucGroup sg = new SecStrucGroup();</span>
<span class="source-line-no">718</span><span id="line-718">                                        sg.setResidueNumber(g.getResidueNumber());</span>
<span class="source-line-no">719</span><span id="line-719">                                        sg.setPDBFlag(true);</span>
<span class="source-line-no">720</span><span id="line-720">                                        sg.setPDBName(g.getPDBName());</span>
<span class="source-line-no">721</span><span id="line-721">                                        sg.setChain(g.getChain());</span>
<span class="source-line-no">722</span><span id="line-722"></span>
<span class="source-line-no">723</span><span id="line-723">                                        Atom N = g.getAtom(StructureTools.N_ATOM_NAME);</span>
<span class="source-line-no">724</span><span id="line-724">                                        Atom CA =  g.getAtom(StructureTools.CA_ATOM_NAME);</span>
<span class="source-line-no">725</span><span id="line-725">                                        Atom C = g.getAtom(StructureTools.C_ATOM_NAME);</span>
<span class="source-line-no">726</span><span id="line-726">                                        Atom O =  g.getAtom(StructureTools.O_ATOM_NAME);</span>
<span class="source-line-no">727</span><span id="line-727">                                        if ( N == null || CA == null || C == null || O == null)</span>
<span class="source-line-no">728</span><span id="line-728">                                                continue;</span>
<span class="source-line-no">729</span><span id="line-729"></span>
<span class="source-line-no">730</span><span id="line-730">                                        sg.setN((Atom)   N.clone());</span>
<span class="source-line-no">731</span><span id="line-731">                                        sg.setCA((Atom) CA.clone());</span>
<span class="source-line-no">732</span><span id="line-732">                                        sg.setC((Atom)   C.clone());</span>
<span class="source-line-no">733</span><span id="line-733">                                        sg.setO((Atom)  O.clone());</span>
<span class="source-line-no">734</span><span id="line-734">                                        sg.setOriginal(g);</span>
<span class="source-line-no">735</span><span id="line-735"></span>
<span class="source-line-no">736</span><span id="line-736">                                        SecStrucState state = new SecStrucState(sg,</span>
<span class="source-line-no">737</span><span id="line-737">                                                        SecStrucInfo.BIOJAVA_ASSIGNMENT,</span>
<span class="source-line-no">738</span><span id="line-738">                                                        SecStrucType.coil);</span>
<span class="source-line-no">739</span><span id="line-739"></span>
<span class="source-line-no">740</span><span id="line-740">                                        sg.setProperty(Group.SEC_STRUC, state);</span>
<span class="source-line-no">741</span><span id="line-741">                                        groupList.add(sg);</span>
<span class="source-line-no">742</span><span id="line-742">                                }</span>
<span class="source-line-no">743</span><span id="line-743">                        }</span>
<span class="source-line-no">744</span><span id="line-744"></span>
<span class="source-line-no">745</span><span id="line-745">                }</span>
<span class="source-line-no">746</span><span id="line-746">                return groupList.toArray(new SecStrucGroup[groupList.size()]);</span>
<span class="source-line-no">747</span><span id="line-747">        }</span>
<span class="source-line-no">748</span><span id="line-748"></span>
<span class="source-line-no">749</span><span id="line-749">        /**</span>
<span class="source-line-no">750</span><span id="line-750">         * Calculate the coordinates of the H atoms. They are usually</span>
<span class="source-line-no">751</span><span id="line-751">         * missing in the PDB files as only few experimental methods allow</span>
<span class="source-line-no">752</span><span id="line-752">         * to resolve their location.</span>
<span class="source-line-no">753</span><span id="line-753">         */</span>
<span class="source-line-no">754</span><span id="line-754">        private void calculateHAtoms() throws StructureException {</span>
<span class="source-line-no">755</span><span id="line-755"></span>
<span class="source-line-no">756</span><span id="line-756">                for ( int i = 0 ; i &lt; groups.length-1  ; i++) {</span>
<span class="source-line-no">757</span><span id="line-757"></span>
<span class="source-line-no">758</span><span id="line-758">                        SecStrucGroup a  = groups[i];</span>
<span class="source-line-no">759</span><span id="line-759">                        SecStrucGroup b  = groups[i+1];</span>
<span class="source-line-no">760</span><span id="line-760"></span>
<span class="source-line-no">761</span><span id="line-761">                        if ( !b.hasAtom("H") ) {</span>
<span class="source-line-no">762</span><span id="line-762">                                //Atom H = calc_H(a.getC(), b.getN(), b.getCA());</span>
<span class="source-line-no">763</span><span id="line-763">                                Atom H = calcSimple_H(a.getC(), a.getO(), b.getN());</span>
<span class="source-line-no">764</span><span id="line-764">                                b.setH(H);</span>
<span class="source-line-no">765</span><span id="line-765">                        }</span>
<span class="source-line-no">766</span><span id="line-766">                }</span>
<span class="source-line-no">767</span><span id="line-767">        }</span>
<span class="source-line-no">768</span><span id="line-768"></span>
<span class="source-line-no">769</span><span id="line-769"></span>
<span class="source-line-no">770</span><span id="line-770"></span>
<span class="source-line-no">771</span><span id="line-771">        /**</span>
<span class="source-line-no">772</span><span id="line-772">         * Calculate the HBonds between different groups.</span>
<span class="source-line-no">773</span><span id="line-773">         * see Creighton page 147 f</span>
<span class="source-line-no">774</span><span id="line-774">         * Modified to use only the contact map</span>
<span class="source-line-no">775</span><span id="line-775">         */</span>
<span class="source-line-no">776</span><span id="line-776">        private void calculateHBonds() {</span>
<span class="source-line-no">777</span><span id="line-777">                /**</span>
<span class="source-line-no">778</span><span id="line-778">                 * More efficient method for calculating C-Alpha pairs</span>
<span class="source-line-no">779</span><span id="line-779">                 */</span>
<span class="source-line-no">780</span><span id="line-780">                if (groups.length &lt; 5) return;</span>
<span class="source-line-no">781</span><span id="line-781">                Iterator&lt;AtomContact&gt; otu = contactSet.iterator();</span>
<span class="source-line-no">782</span><span id="line-782">                while(otu.hasNext()){</span>
<span class="source-line-no">783</span><span id="line-783">                        AtomContact ac = otu.next();</span>
<span class="source-line-no">784</span><span id="line-784">                        Pair&lt;Atom&gt; pair = ac.getPair();</span>
<span class="source-line-no">785</span><span id="line-785">                        Group g1 = pair.getFirst().getGroup();</span>
<span class="source-line-no">786</span><span id="line-786">                        Group g2 = pair.getSecond().getGroup();</span>
<span class="source-line-no">787</span><span id="line-787">                        // Now I need to get the index of the Group in the list groups</span>
<span class="source-line-no">788</span><span id="line-788">                        int i = indResMap.get(g1.getResidueNumber());</span>
<span class="source-line-no">789</span><span id="line-789">                        int j = indResMap.get(g2.getResidueNumber());</span>
<span class="source-line-no">790</span><span id="line-790">                        // Now check this</span>
<span class="source-line-no">791</span><span id="line-791">                        checkAddHBond(i,j);</span>
<span class="source-line-no">792</span><span id="line-792">                        //"backwards" hbonds are not allowed</span>
<span class="source-line-no">793</span><span id="line-793">                        if (j!=(i+1)) checkAddHBond(j,i);</span>
<span class="source-line-no">794</span><span id="line-794">                }</span>
<span class="source-line-no">795</span><span id="line-795">        }</span>
<span class="source-line-no">796</span><span id="line-796"></span>
<span class="source-line-no">797</span><span id="line-797">        private void checkAddHBond(int i, int j){</span>
<span class="source-line-no">798</span><span id="line-798"></span>
<span class="source-line-no">799</span><span id="line-799">                SecStrucGroup one = groups[i];</span>
<span class="source-line-no">800</span><span id="line-800"></span>
<span class="source-line-no">801</span><span id="line-801">                if ("PRO".equals(one.getPDBName())){</span>
<span class="source-line-no">802</span><span id="line-802">                        logger.debug("Ignore: PRO {}", one.getResidueNumber());</span>
<span class="source-line-no">803</span><span id="line-803">                        return;</span>
<span class="source-line-no">804</span><span id="line-804">                }</span>
<span class="source-line-no">805</span><span id="line-805">                if (!one.hasAtom("H")) {</span>
<span class="source-line-no">806</span><span id="line-806">                        logger.debug("Residue {} has no H",one.getResidueNumber());</span>
<span class="source-line-no">807</span><span id="line-807">                        return;</span>
<span class="source-line-no">808</span><span id="line-808">                }</span>
<span class="source-line-no">809</span><span id="line-809"></span>
<span class="source-line-no">810</span><span id="line-810">                SecStrucGroup two = groups[j];</span>
<span class="source-line-no">811</span><span id="line-811"></span>
<span class="source-line-no">812</span><span id="line-812">                double energy = 0;</span>
<span class="source-line-no">813</span><span id="line-813"></span>
<span class="source-line-no">814</span><span id="line-814">                try {</span>
<span class="source-line-no">815</span><span id="line-815">                        energy = calculateHBondEnergy(one,two);</span>
<span class="source-line-no">816</span><span id="line-816">                } catch (Exception e){</span>
<span class="source-line-no">817</span><span id="line-817">                        logger.warn("Energy calculation failed", e);</span>
<span class="source-line-no">818</span><span id="line-818">                        return;</span>
<span class="source-line-no">819</span><span id="line-819">                }</span>
<span class="source-line-no">820</span><span id="line-820">                logger.debug("Energy between positions ({},{}): ",i,j,energy);</span>
<span class="source-line-no">821</span><span id="line-821"></span>
<span class="source-line-no">822</span><span id="line-822">                trackHBondEnergy(i,j,energy);</span>
<span class="source-line-no">823</span><span id="line-823">        }</span>
<span class="source-line-no">824</span><span id="line-824"></span>
<span class="source-line-no">825</span><span id="line-825">        /**</span>
<span class="source-line-no">826</span><span id="line-826">         * Calculate HBond energy of two groups in cal/mol</span>
<span class="source-line-no">827</span><span id="line-827">         * see Creighton page 147 f</span>
<span class="source-line-no">828</span><span id="line-828">         * &lt;p&gt;</span>
<span class="source-line-no">829</span><span id="line-829">         * Jeffrey, George A., An introduction to hydrogen bonding,</span>
<span class="source-line-no">830</span><span id="line-830">         * Oxford University Press, 1997.</span>
<span class="source-line-no">831</span><span id="line-831">         * categorizes hbonds with donor-acceptor distances of</span>
<span class="source-line-no">832</span><span id="line-832">         * 2.2-2.5 &amp;aring; as "strong, mostly covalent",</span>
<span class="source-line-no">833</span><span id="line-833">         * 2.5-3.2 &amp;aring; as "moderate, mostly electrostatic",</span>
<span class="source-line-no">834</span><span id="line-834">         * 3.2-4.0 &amp;aring; as "weak, electrostatic".</span>
<span class="source-line-no">835</span><span id="line-835">         * Energies are given as 40-14, 15-4, and &lt;4 kcal/mol respectively.</span>
<span class="source-line-no">836</span><span id="line-836">         */</span>
<span class="source-line-no">837</span><span id="line-837">        private static double calculateHBondEnergy(SecStrucGroup one,</span>
<span class="source-line-no">838</span><span id="line-838">                        SecStrucGroup two) {</span>
<span class="source-line-no">839</span><span id="line-839"></span>
<span class="source-line-no">840</span><span id="line-840">                Atom N = one.getN();</span>
<span class="source-line-no">841</span><span id="line-841">                Atom H = one.getH();</span>
<span class="source-line-no">842</span><span id="line-842"></span>
<span class="source-line-no">843</span><span id="line-843">                Atom O = two.getO();</span>
<span class="source-line-no">844</span><span id="line-844">                Atom C = two.getC();</span>
<span class="source-line-no">845</span><span id="line-845"></span>
<span class="source-line-no">846</span><span id="line-846">                double dno = Calc.getDistance(O,N);</span>
<span class="source-line-no">847</span><span id="line-847">                double dhc = Calc.getDistance(C,H);</span>
<span class="source-line-no">848</span><span id="line-848">                double dho = Calc.getDistance(O,H);</span>
<span class="source-line-no">849</span><span id="line-849">                double dnc = Calc.getDistance(C,N);</span>
<span class="source-line-no">850</span><span id="line-850"></span>
<span class="source-line-no">851</span><span id="line-851">                logger.debug(" cccc: {} {} {} {} O ({})..N ({}):{}  |  ho:{} - hc:{} + nc:{} - no:{}",</span>
<span class="source-line-no">852</span><span id="line-852">                                one.getResidueNumber(),one.getPDBName(),two.getResidueNumber(),two.getPDBName(),</span>
<span class="source-line-no">853</span><span id="line-853">                                O.getPDBserial(),N.getPDBserial(),dno,dho,dhc,dnc,dno);</span>
<span class="source-line-no">854</span><span id="line-854"></span>
<span class="source-line-no">855</span><span id="line-855">                //there seems to be a contact!</span>
<span class="source-line-no">856</span><span id="line-856">                if ( (dno &lt; MINDIST) || (dhc &lt; MINDIST) ||</span>
<span class="source-line-no">857</span><span id="line-857">                                (dnc &lt; MINDIST) || (dno &lt; MINDIST)) {</span>
<span class="source-line-no">858</span><span id="line-858">                        return HBONDLOWENERGY;</span>
<span class="source-line-no">859</span><span id="line-859">                }</span>
<span class="source-line-no">860</span><span id="line-860"></span>
<span class="source-line-no">861</span><span id="line-861">                double e1 = Q / dho - Q / dhc;</span>
<span class="source-line-no">862</span><span id="line-862">                double e2 = Q / dnc - Q / dno;</span>
<span class="source-line-no">863</span><span id="line-863"></span>
<span class="source-line-no">864</span><span id="line-864">                double energy = e1 + e2;</span>
<span class="source-line-no">865</span><span id="line-865"></span>
<span class="source-line-no">866</span><span id="line-866">                logger.debug(" N ({}) O({}): {} : {} ",N.getPDBserial(),O.getPDBserial(),(float) dno,energy);</span>
<span class="source-line-no">867</span><span id="line-867"></span>
<span class="source-line-no">868</span><span id="line-868">                //Avoid too strong energy</span>
<span class="source-line-no">869</span><span id="line-869">                if (energy &gt; HBONDLOWENERGY) return energy;</span>
<span class="source-line-no">870</span><span id="line-870"></span>
<span class="source-line-no">871</span><span id="line-871">                return HBONDLOWENERGY ;</span>
<span class="source-line-no">872</span><span id="line-872">        }</span>
<span class="source-line-no">873</span><span id="line-873"></span>
<span class="source-line-no">874</span><span id="line-874">        /**</span>
<span class="source-line-no">875</span><span id="line-875">         * Store Hbonds in the Groups.</span>
<span class="source-line-no">876</span><span id="line-876">         * DSSP allows two HBonds per aminoacids to allow bifurcated bonds.</span>
<span class="source-line-no">877</span><span id="line-877">         */</span>
<span class="source-line-no">878</span><span id="line-878">        private  void trackHBondEnergy(int i, int j, double energy) {</span>
<span class="source-line-no">879</span><span id="line-879"></span>
<span class="source-line-no">880</span><span id="line-880">                if ("PRO".equals(groups[i].getPDBName())) {</span>
<span class="source-line-no">881</span><span id="line-881">                        logger.debug("Ignore: PRO {}",groups[i].getResidueNumber());</span>
<span class="source-line-no">882</span><span id="line-882">                        return;</span>
<span class="source-line-no">883</span><span id="line-883">                }</span>
<span class="source-line-no">884</span><span id="line-884"></span>
<span class="source-line-no">885</span><span id="line-885">                SecStrucState stateOne = getSecStrucState(i);</span>
<span class="source-line-no">886</span><span id="line-886">                SecStrucState stateTwo = getSecStrucState(j);</span>
<span class="source-line-no">887</span><span id="line-887"></span>
<span class="source-line-no">888</span><span id="line-888">                double acc1e = stateOne.getAccept1().getEnergy();</span>
<span class="source-line-no">889</span><span id="line-889">                double acc2e = stateOne.getAccept2().getEnergy();</span>
<span class="source-line-no">890</span><span id="line-890"></span>
<span class="source-line-no">891</span><span id="line-891">                double don1e = stateTwo.getDonor1().getEnergy();</span>
<span class="source-line-no">892</span><span id="line-892">                double don2e = stateTwo.getDonor2().getEnergy();</span>
<span class="source-line-no">893</span><span id="line-893"></span>
<span class="source-line-no">894</span><span id="line-894">                //Acceptor: N-H--&gt;O</span>
<span class="source-line-no">895</span><span id="line-895">                if (energy &lt; acc1e) {</span>
<span class="source-line-no">896</span><span id="line-896">                        logger.debug("{} &lt; {}",energy,acc1e);</span>
<span class="source-line-no">897</span><span id="line-897">                        stateOne.setAccept2(stateOne.getAccept1());</span>
<span class="source-line-no">898</span><span id="line-898"></span>
<span class="source-line-no">899</span><span id="line-899">                        HBond bond = new HBond();</span>
<span class="source-line-no">900</span><span id="line-900">                        bond.setEnergy(energy);</span>
<span class="source-line-no">901</span><span id="line-901">                        bond.setPartner(j);</span>
<span class="source-line-no">902</span><span id="line-902"></span>
<span class="source-line-no">903</span><span id="line-903">                        stateOne.setAccept1(bond);</span>
<span class="source-line-no">904</span><span id="line-904"></span>
<span class="source-line-no">905</span><span id="line-905">                } else if ( energy &lt; acc2e ) {</span>
<span class="source-line-no">906</span><span id="line-906">                        logger.debug("{} &lt; {}",energy,acc2e);</span>
<span class="source-line-no">907</span><span id="line-907"></span>
<span class="source-line-no">908</span><span id="line-908">                        HBond bond = new HBond();</span>
<span class="source-line-no">909</span><span id="line-909">                        bond.setEnergy(energy);</span>
<span class="source-line-no">910</span><span id="line-910">                        bond.setPartner(j);</span>
<span class="source-line-no">911</span><span id="line-911"></span>
<span class="source-line-no">912</span><span id="line-912">                        stateOne.setAccept2(bond);</span>
<span class="source-line-no">913</span><span id="line-913">                }</span>
<span class="source-line-no">914</span><span id="line-914"></span>
<span class="source-line-no">915</span><span id="line-915"></span>
<span class="source-line-no">916</span><span id="line-916">                //The other side of the bond: donor O--&gt;N-H</span>
<span class="source-line-no">917</span><span id="line-917">                if (energy &lt;  don1e) {</span>
<span class="source-line-no">918</span><span id="line-918">                        logger.debug("{} &lt; {}",energy,don1e);</span>
<span class="source-line-no">919</span><span id="line-919">                        stateTwo.setDonor2(stateTwo.getDonor1());</span>
<span class="source-line-no">920</span><span id="line-920"></span>
<span class="source-line-no">921</span><span id="line-921">                        HBond bond = new HBond();</span>
<span class="source-line-no">922</span><span id="line-922">                        bond.setEnergy(energy);</span>
<span class="source-line-no">923</span><span id="line-923">                        bond.setPartner(i);</span>
<span class="source-line-no">924</span><span id="line-924"></span>
<span class="source-line-no">925</span><span id="line-925">                        stateTwo.setDonor1(bond);</span>
<span class="source-line-no">926</span><span id="line-926"></span>
<span class="source-line-no">927</span><span id="line-927">                } else if ( energy &lt; don2e ) {</span>
<span class="source-line-no">928</span><span id="line-928">                        logger.debug("{} &lt; {}",energy,don2e);</span>
<span class="source-line-no">929</span><span id="line-929"></span>
<span class="source-line-no">930</span><span id="line-930">                        HBond bond = new HBond();</span>
<span class="source-line-no">931</span><span id="line-931">                        bond.setEnergy(energy);</span>
<span class="source-line-no">932</span><span id="line-932">                        bond.setPartner(i);</span>
<span class="source-line-no">933</span><span id="line-933"></span>
<span class="source-line-no">934</span><span id="line-934">                        stateTwo.setDonor2(bond);</span>
<span class="source-line-no">935</span><span id="line-935">                }</span>
<span class="source-line-no">936</span><span id="line-936">        }</span>
<span class="source-line-no">937</span><span id="line-937"></span>
<span class="source-line-no">938</span><span id="line-938">        /**</span>
<span class="source-line-no">939</span><span id="line-939">         * Detect helical turn patterns.</span>
<span class="source-line-no">940</span><span id="line-940">         */</span>
<span class="source-line-no">941</span><span id="line-941">        private void calculateTurns(){</span>
<span class="source-line-no">942</span><span id="line-942"></span>
<span class="source-line-no">943</span><span id="line-943">                for (int i = 0 ; i&lt; groups.length; i++){</span>
<span class="source-line-no">944</span><span id="line-944">                        for (int turn = 3; turn &lt;= 5; turn++) {</span>
<span class="source-line-no">945</span><span id="line-945"></span>
<span class="source-line-no">946</span><span id="line-946">                                if (i+turn &gt;= groups.length) continue;</span>
<span class="source-line-no">947</span><span id="line-947"></span>
<span class="source-line-no">948</span><span id="line-948">                                //Check for H bond from NH(i+n) to CO(i)</span>
<span class="source-line-no">949</span><span id="line-949">                                if (isBonded(i, i+turn)) {</span>
<span class="source-line-no">950</span><span id="line-950">                                        logger.debug("Turn at ({},{}) turn {}",i,(i+turn),turn);</span>
<span class="source-line-no">951</span><span id="line-951">                                        getSecStrucState(i).setTurn('&gt;', turn);</span>
<span class="source-line-no">952</span><span id="line-952">                                        getSecStrucState(i+turn).setTurn('&lt;', turn);</span>
<span class="source-line-no">953</span><span id="line-953">                                        //Bracketed residues get the helix number</span>
<span class="source-line-no">954</span><span id="line-954">                                        for (int j=i+1; j&lt;i+turn; j++){</span>
<span class="source-line-no">955</span><span id="line-955">                                                Integer t = turn;</span>
<span class="source-line-no">956</span><span id="line-956">                                                char helix = t.toString().charAt(0);</span>
<span class="source-line-no">957</span><span id="line-957">                                                getSecStrucState(j).setTurn(helix, turn);</span>
<span class="source-line-no">958</span><span id="line-958">                                        }</span>
<span class="source-line-no">959</span><span id="line-959">                                }</span>
<span class="source-line-no">960</span><span id="line-960">                        }</span>
<span class="source-line-no">961</span><span id="line-961">                }</span>
<span class="source-line-no">962</span><span id="line-962">        }</span>
<span class="source-line-no">963</span><span id="line-963"></span>
<span class="source-line-no">964</span><span id="line-964">        /**</span>
<span class="source-line-no">965</span><span id="line-965">         * Test if two groups are forming an H-Bond. The bond tested is</span>
<span class="source-line-no">966</span><span id="line-966">         * from the CO of group i to the NH of group j. Acceptor (i) and</span>
<span class="source-line-no">967</span><span id="line-967">         * donor (j). The donor of i has to be j, and the acceptor of j</span>
<span class="source-line-no">968</span><span id="line-968">         * has to be i.</span>
<span class="source-line-no">969</span><span id="line-969">         * DSSP defines H-Bonds if the energy &lt; -500 cal/mol.</span>
<span class="source-line-no">970</span><span id="line-970">         *</span>
<span class="source-line-no">971</span><span id="line-971">         * @param i group one</span>
<span class="source-line-no">972</span><span id="line-972">         * @param j group two</span>
<span class="source-line-no">973</span><span id="line-973">         * @return flag if the two are forming an Hbond</span>
<span class="source-line-no">974</span><span id="line-974">         */</span>
<span class="source-line-no">975</span><span id="line-975">        private boolean isBonded(int i, int j) {</span>
<span class="source-line-no">976</span><span id="line-976"></span>
<span class="source-line-no">977</span><span id="line-977">                SecStrucState one = getSecStrucState(i);</span>
<span class="source-line-no">978</span><span id="line-978">                SecStrucState two = getSecStrucState(j);</span>
<span class="source-line-no">979</span><span id="line-979"></span>
<span class="source-line-no">980</span><span id="line-980">                double don1e = one.getDonor1().getEnergy();</span>
<span class="source-line-no">981</span><span id="line-981">                double don2e = one.getDonor2().getEnergy();</span>
<span class="source-line-no">982</span><span id="line-982">                double acc1e = two.getAccept1().getEnergy();</span>
<span class="source-line-no">983</span><span id="line-983">                double acc2e = two.getAccept2().getEnergy();</span>
<span class="source-line-no">984</span><span id="line-984"></span>
<span class="source-line-no">985</span><span id="line-985">                int don1p = one.getDonor1().getPartner();</span>
<span class="source-line-no">986</span><span id="line-986">                int don2p = one.getDonor2().getPartner();</span>
<span class="source-line-no">987</span><span id="line-987">                int acc1p = two.getAccept1().getPartner();</span>
<span class="source-line-no">988</span><span id="line-988">                int acc2p = two.getAccept2().getPartner();</span>
<span class="source-line-no">989</span><span id="line-989"></span>
<span class="source-line-no">990</span><span id="line-990">                //Either donor from i is j, or accept from j is i</span>
<span class="source-line-no">991</span><span id="line-991">                boolean hbond = (don1p == j &amp;&amp; don1e &lt; HBONDHIGHENERGY) ||</span>
<span class="source-line-no">992</span><span id="line-992">                                (don2p == j &amp;&amp; don2e &lt; HBONDHIGHENERGY) ||</span>
<span class="source-line-no">993</span><span id="line-993">                                (acc1p == i &amp;&amp; acc1e &lt; HBONDHIGHENERGY) ||</span>
<span class="source-line-no">994</span><span id="line-994">                                (acc2p == i &amp;&amp; acc2e &lt; HBONDHIGHENERGY);</span>
<span class="source-line-no">995</span><span id="line-995"></span>
<span class="source-line-no">996</span><span id="line-996">                if (hbond){</span>
<span class="source-line-no">997</span><span id="line-997">                        logger.debug("*** H-bond from CO of {} to NH of {}", i, j);</span>
<span class="source-line-no">998</span><span id="line-998">                        return true;</span>
<span class="source-line-no">999</span><span id="line-999">                }</span>
<span class="source-line-no">1000</span><span id="line-1000">                return false ;</span>
<span class="source-line-no">1001</span><span id="line-1001">        }</span>
<span class="source-line-no">1002</span><span id="line-1002"></span>
<span class="source-line-no">1003</span><span id="line-1003">        /**</span>
<span class="source-line-no">1004</span><span id="line-1004">         * Use unit vectors NC and NCalpha Add them. Calc unit vector and</span>
<span class="source-line-no">1005</span><span id="line-1005">         * substract it from N.</span>
<span class="source-line-no">1006</span><span id="line-1006">         * C coordinates are from amino acid i-1</span>
<span class="source-line-no">1007</span><span id="line-1007">         * N, CA atoms from amino acid i</span>
<span class="source-line-no">1008</span><span id="line-1008">         *</span>
<span class="source-line-no">1009</span><span id="line-1009">         * @link http://openbioinformatics.blogspot.com/</span>
<span class="source-line-no">1010</span><span id="line-1010">         *              2009/08/how-to-calculate-h-atoms-for-nitrogens.html</span>
<span class="source-line-no">1011</span><span id="line-1011">         */</span>
<span class="source-line-no">1012</span><span id="line-1012">        @SuppressWarnings("unused")</span>
<span class="source-line-no">1013</span><span id="line-1013">        private static Atom calc_H(Atom C, Atom N, Atom CA)</span>
<span class="source-line-no">1014</span><span id="line-1014">                        throws StructureException {</span>
<span class="source-line-no">1015</span><span id="line-1015"></span>
<span class="source-line-no">1016</span><span id="line-1016">                Atom nc  = Calc.subtract(N,C);</span>
<span class="source-line-no">1017</span><span id="line-1017">                Atom nca = Calc.subtract(N,CA);</span>
<span class="source-line-no">1018</span><span id="line-1018"></span>
<span class="source-line-no">1019</span><span id="line-1019">                Atom u_nc  = Calc.unitVector(nc)   ;</span>
<span class="source-line-no">1020</span><span id="line-1020">                Atom u_nca = Calc.unitVector(nca);</span>
<span class="source-line-no">1021</span><span id="line-1021"></span>
<span class="source-line-no">1022</span><span id="line-1022">                Atom added = Calc.add(u_nc,u_nca);</span>
<span class="source-line-no">1023</span><span id="line-1023"></span>
<span class="source-line-no">1024</span><span id="line-1024">                Atom U = Calc.unitVector(added);</span>
<span class="source-line-no">1025</span><span id="line-1025"></span>
<span class="source-line-no">1026</span><span id="line-1026">                // according to Creighton distance N-H is 1.03 +/- 0.02A</span>
<span class="source-line-no">1027</span><span id="line-1027">                Atom H = Calc.add(N,U);</span>
<span class="source-line-no">1028</span><span id="line-1028"></span>
<span class="source-line-no">1029</span><span id="line-1029">                H.setName("H");</span>
<span class="source-line-no">1030</span><span id="line-1030">                // this atom does not have a pdbserial number ...</span>
<span class="source-line-no">1031</span><span id="line-1031">                return H;</span>
<span class="source-line-no">1032</span><span id="line-1032"></span>
<span class="source-line-no">1033</span><span id="line-1033">        }</span>
<span class="source-line-no">1034</span><span id="line-1034"></span>
<span class="source-line-no">1035</span><span id="line-1035">        private static Atom calcSimple_H(Atom c, Atom o, Atom n)  {</span>
<span class="source-line-no">1036</span><span id="line-1036"></span>
<span class="source-line-no">1037</span><span id="line-1037">                Atom h = Calc.subtract(c,o);</span>
<span class="source-line-no">1038</span><span id="line-1038">                double dist = Calc.getDistance(o,c);</span>
<span class="source-line-no">1039</span><span id="line-1039">                //System.out.println(dist);</span>
<span class="source-line-no">1040</span><span id="line-1040">                double x = n.getX() + h.getX() / dist;</span>
<span class="source-line-no">1041</span><span id="line-1041">                double y = n.getY() + h.getY() / dist;</span>
<span class="source-line-no">1042</span><span id="line-1042">                double z = n.getZ() + h.getZ() / dist;</span>
<span class="source-line-no">1043</span><span id="line-1043"></span>
<span class="source-line-no">1044</span><span id="line-1044">                h.setX(x);</span>
<span class="source-line-no">1045</span><span id="line-1045">                h.setY(y);</span>
<span class="source-line-no">1046</span><span id="line-1046">                h.setZ(z);</span>
<span class="source-line-no">1047</span><span id="line-1047"></span>
<span class="source-line-no">1048</span><span id="line-1048">                h.setName("H");</span>
<span class="source-line-no">1049</span><span id="line-1049">                return h;</span>
<span class="source-line-no">1050</span><span id="line-1050">        }</span>
<span class="source-line-no">1051</span><span id="line-1051"></span>
<span class="source-line-no">1052</span><span id="line-1052">        private void buildHelices(){</span>
<span class="source-line-no">1053</span><span id="line-1053"></span>
<span class="source-line-no">1054</span><span id="line-1054">                //Alpha-helix (i+4), 3-10-helix (i+3), Pi-helix (i+5)</span>
<span class="source-line-no">1055</span><span id="line-1055">                checkSetHelix(4, SecStrucType.helix4);</span>
<span class="source-line-no">1056</span><span id="line-1056">                checkSetHelix(3, SecStrucType.helix3);</span>
<span class="source-line-no">1057</span><span id="line-1057">                checkSetHelix(5, SecStrucType.helix5);</span>
<span class="source-line-no">1058</span><span id="line-1058"></span>
<span class="source-line-no">1059</span><span id="line-1059">                checkSetTurns();</span>
<span class="source-line-no">1060</span><span id="line-1060">        }</span>
<span class="source-line-no">1061</span><span id="line-1061"></span>
<span class="source-line-no">1062</span><span id="line-1062">        private void checkSetTurns() {</span>
<span class="source-line-no">1063</span><span id="line-1063"></span>
<span class="source-line-no">1064</span><span id="line-1064">                SecStrucType type = SecStrucType.turn;</span>
<span class="source-line-no">1065</span><span id="line-1065"></span>
<span class="source-line-no">1066</span><span id="line-1066">                for (int idx = 0; idx &lt; 3; idx++) {</span>
<span class="source-line-no">1067</span><span id="line-1067">                        for (int i = 0; i &lt; groups.length-1; i++) {</span>
<span class="source-line-no">1068</span><span id="line-1068"></span>
<span class="source-line-no">1069</span><span id="line-1069">                                SecStrucState state = getSecStrucState(i);</span>
<span class="source-line-no">1070</span><span id="line-1070">                                char[] turn = state.getTurn();</span>
<span class="source-line-no">1071</span><span id="line-1071"></span>
<span class="source-line-no">1072</span><span id="line-1072">                                //Any turn opening matters</span>
<span class="source-line-no">1073</span><span id="line-1073">                                if (turn[idx] == '&gt;' || turn[idx] == 'X') {</span>
<span class="source-line-no">1074</span><span id="line-1074">                                        //Mark following n residues as turn</span>
<span class="source-line-no">1075</span><span id="line-1075">                                        for (int k=1; k&lt;idx+3; k++){</span>
<span class="source-line-no">1076</span><span id="line-1076">                                                setSecStrucType(i+k, type);</span>
<span class="source-line-no">1077</span><span id="line-1077">                                        }</span>
<span class="source-line-no">1078</span><span id="line-1078">                                        if (!DSSP_HELICES) {</span>
<span class="source-line-no">1079</span><span id="line-1079">                                                setSecStrucType(i, type);</span>
<span class="source-line-no">1080</span><span id="line-1080">                                                setSecStrucType(i+idx+3, type);</span>
<span class="source-line-no">1081</span><span id="line-1081">                                        }</span>
<span class="source-line-no">1082</span><span id="line-1082">                                }</span>
<span class="source-line-no">1083</span><span id="line-1083">                        }</span>
<span class="source-line-no">1084</span><span id="line-1084">                }</span>
<span class="source-line-no">1085</span><span id="line-1085">        }</span>
<span class="source-line-no">1086</span><span id="line-1086"></span>
<span class="source-line-no">1087</span><span id="line-1087">        /**</span>
<span class="source-line-no">1088</span><span id="line-1088">         * A minimal helix is defined by two consecutive n-turns.</span>
<span class="source-line-no">1089</span><span id="line-1089">         * For example, a 4-helix, of minimal length 4 from residues</span>
<span class="source-line-no">1090</span><span id="line-1090">         * i to (i+3), requires turns (of type 4) at residues (i-1) and i.</span>
<span class="source-line-no">1091</span><span id="line-1091">         * &lt;p&gt;</span>
<span class="source-line-no">1092</span><span id="line-1092">         * Note that the orignal DSSP implementation does not assign</span>
<span class="source-line-no">1093</span><span id="line-1093">         * helix type to residue (i-1) and residue (i+n+1), although</span>
<span class="source-line-no">1094</span><span id="line-1094">         * they contain a helix turn. As they state in the original paper,</span>
<span class="source-line-no">1095</span><span id="line-1095">         * "the helices are one residue shorter than they would be according</span>
<span class="source-line-no">1096</span><span id="line-1096">         * to rule 6.3 of IUPAC-IUB".</span>
<span class="source-line-no">1097</span><span id="line-1097">         *</span>
<span class="source-line-no">1098</span><span id="line-1098">         * @param n</span>
<span class="source-line-no">1099</span><span id="line-1099">         * @param type</span>
<span class="source-line-no">1100</span><span id="line-1100">         */</span>
<span class="source-line-no">1101</span><span id="line-1101">        private void checkSetHelix(int n, SecStrucType type){</span>
<span class="source-line-no">1102</span><span id="line-1102"></span>
<span class="source-line-no">1103</span><span id="line-1103">                int idx = n - 3;</span>
<span class="source-line-no">1104</span><span id="line-1104">                logger.debug("Set helix {} {} {}", type, n, idx);</span>
<span class="source-line-no">1105</span><span id="line-1105"></span>
<span class="source-line-no">1106</span><span id="line-1106">                for (int i = 1; i &lt; groups.length-n; i++) {</span>
<span class="source-line-no">1107</span><span id="line-1107"></span>
<span class="source-line-no">1108</span><span id="line-1108">                        SecStrucState state = getSecStrucState(i);</span>
<span class="source-line-no">1109</span><span id="line-1109">                        SecStrucState previousState = getSecStrucState(i-1);</span>
<span class="source-line-no">1110</span><span id="line-1110"></span>
<span class="source-line-no">1111</span><span id="line-1111">                        //Check that no other helix was assgined to this range</span>
<span class="source-line-no">1112</span><span id="line-1112">                        if (state.getType().compareTo(type) &lt; 0) continue;</span>
<span class="source-line-no">1113</span><span id="line-1113">                        if (getSecStrucState(i+1).getType().compareTo(type) &lt; 0) continue;</span>
<span class="source-line-no">1114</span><span id="line-1114"></span>
<span class="source-line-no">1115</span><span id="line-1115">                        char turn = state.getTurn()[idx];</span>
<span class="source-line-no">1116</span><span id="line-1116">                        char pturn = previousState.getTurn()[idx];</span>
<span class="source-line-no">1117</span><span id="line-1117"></span>
<span class="source-line-no">1118</span><span id="line-1118">                        //Two consecutive n-turns present to define a n-helix</span>
<span class="source-line-no">1119</span><span id="line-1119">                        if ((turn=='&gt;' || turn=='X') &amp;&amp; (pturn=='&gt;' || pturn=='X')) {</span>
<span class="source-line-no">1120</span><span id="line-1120">                                //Mark following n residues as turn</span>
<span class="source-line-no">1121</span><span id="line-1121">                                for (int k=0; k&lt;n; k++){</span>
<span class="source-line-no">1122</span><span id="line-1122">                                        setSecStrucType(i+k, type);</span>
<span class="source-line-no">1123</span><span id="line-1123">                                }</span>
<span class="source-line-no">1124</span><span id="line-1124">                                if (!DSSP_HELICES) {</span>
<span class="source-line-no">1125</span><span id="line-1125">                                        setSecStrucType(i-1, type);</span>
<span class="source-line-no">1126</span><span id="line-1126">                                        setSecStrucType(i+n, type);</span>
<span class="source-line-no">1127</span><span id="line-1127">                                }</span>
<span class="source-line-no">1128</span><span id="line-1128">                        }</span>
<span class="source-line-no">1129</span><span id="line-1129">                }</span>
<span class="source-line-no">1130</span><span id="line-1130">        }</span>
<span class="source-line-no">1131</span><span id="line-1131"></span>
<span class="source-line-no">1132</span><span id="line-1132">        /**</span>
<span class="source-line-no">1133</span><span id="line-1133">         * Set the new type only if it has more preference than the</span>
<span class="source-line-no">1134</span><span id="line-1134">         * current residue SS type.</span>
<span class="source-line-no">1135</span><span id="line-1135">         * @param pos</span>
<span class="source-line-no">1136</span><span id="line-1136">         * @param type</span>
<span class="source-line-no">1137</span><span id="line-1137">         */</span>
<span class="source-line-no">1138</span><span id="line-1138">        private void setSecStrucType(int pos, SecStrucType type){</span>
<span class="source-line-no">1139</span><span id="line-1139">                SecStrucState ss = getSecStrucState(pos);</span>
<span class="source-line-no">1140</span><span id="line-1140">                if (type.compareTo(ss.getType()) &lt; 0) ss.setType(type);</span>
<span class="source-line-no">1141</span><span id="line-1141">        }</span>
<span class="source-line-no">1142</span><span id="line-1142"></span>
<span class="source-line-no">1143</span><span id="line-1143">        private SecStrucState getSecStrucState(int pos){</span>
<span class="source-line-no">1144</span><span id="line-1144">                Group g = groups[pos];</span>
<span class="source-line-no">1145</span><span id="line-1145">                SecStrucState state = (SecStrucState) g.getProperty(Group.SEC_STRUC);</span>
<span class="source-line-no">1146</span><span id="line-1146">                return state;</span>
<span class="source-line-no">1147</span><span id="line-1147">        }</span>
<span class="source-line-no">1148</span><span id="line-1148"></span>
<span class="source-line-no">1149</span><span id="line-1149">}</span>




























































</pre>
</div>
</main>
</body>
</html>
