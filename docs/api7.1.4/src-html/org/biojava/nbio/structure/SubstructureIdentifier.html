<!DOCTYPE HTML>
<html lang>
<head>
<!-- Generated by javadoc (21) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: org.biojava.nbio.structure, class: SubstructureIdentifier">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">/*</span>
<span class="source-line-no">002</span><span id="line-2"> *                    BioJava development code</span>
<span class="source-line-no">003</span><span id="line-3"> *</span>
<span class="source-line-no">004</span><span id="line-4"> * This code may be freely distributed and modified under the</span>
<span class="source-line-no">005</span><span id="line-5"> * terms of the GNU Lesser General Public Licence.  This should</span>
<span class="source-line-no">006</span><span id="line-6"> * be distributed with the code.  If you do not have a copy,</span>
<span class="source-line-no">007</span><span id="line-7"> * see:</span>
<span class="source-line-no">008</span><span id="line-8"> *</span>
<span class="source-line-no">009</span><span id="line-9"> *      http://www.gnu.org/copyleft/lesser.html</span>
<span class="source-line-no">010</span><span id="line-10"> *</span>
<span class="source-line-no">011</span><span id="line-11"> * Copyright for this code is held jointly by the individual</span>
<span class="source-line-no">012</span><span id="line-12"> * authors.  These should be listed in @author doc comments.</span>
<span class="source-line-no">013</span><span id="line-13"> *</span>
<span class="source-line-no">014</span><span id="line-14"> * For more information on the BioJava project and its aims,</span>
<span class="source-line-no">015</span><span id="line-15"> * or to join the biojava-l mailing list, visit the home page</span>
<span class="source-line-no">016</span><span id="line-16"> * at:</span>
<span class="source-line-no">017</span><span id="line-17"> *</span>
<span class="source-line-no">018</span><span id="line-18"> *      http://www.biojava.org/</span>
<span class="source-line-no">019</span><span id="line-19"> *</span>
<span class="source-line-no">020</span><span id="line-20"> * Created on December 19, 2013</span>
<span class="source-line-no">021</span><span id="line-21"> * Author: Douglas Myers-Turnbull</span>
<span class="source-line-no">022</span><span id="line-22"> */</span>
<span class="source-line-no">023</span><span id="line-23"></span>
<span class="source-line-no">024</span><span id="line-24">package org.biojava.nbio.structure;</span>
<span class="source-line-no">025</span><span id="line-25"></span>
<span class="source-line-no">026</span><span id="line-26">import java.io.IOException;</span>
<span class="source-line-no">027</span><span id="line-27">import java.util.ArrayList;</span>
<span class="source-line-no">028</span><span id="line-28">import java.util.Arrays;</span>
<span class="source-line-no">029</span><span id="line-29">import java.util.LinkedList;</span>
<span class="source-line-no">030</span><span id="line-30">import java.util.List;</span>
<span class="source-line-no">031</span><span id="line-31"></span>
<span class="source-line-no">032</span><span id="line-32">import org.biojava.nbio.structure.align.util.AtomCache;</span>
<span class="source-line-no">033</span><span id="line-33">import org.biojava.nbio.structure.contact.Grid;</span>
<span class="source-line-no">034</span><span id="line-34">import org.slf4j.Logger;</span>
<span class="source-line-no">035</span><span id="line-35">import org.slf4j.LoggerFactory;</span>
<span class="source-line-no">036</span><span id="line-36">/**</span>
<span class="source-line-no">037</span><span id="line-37"> * This is the canonical way to identify a part of a structure.</span>
<span class="source-line-no">038</span><span id="line-38"> *</span>
<span class="source-line-no">039</span><span id="line-39"> * &lt;p&gt;The current syntax allows the specification of a set of residues from</span>
<span class="source-line-no">040</span><span id="line-40"> * the first model of a structure. Future versions may be extended to represent</span>
<span class="source-line-no">041</span><span id="line-41"> * additional properties.</span>
<span class="source-line-no">042</span><span id="line-42"> *</span>
<span class="source-line-no">043</span><span id="line-43"> * &lt;p&gt;Identifiers should adhere to the following specification, although some</span>
<span class="source-line-no">044</span><span id="line-44"> * additional forms may be tolerated where unambiguous for backwards compatibility.</span>
<span class="source-line-no">045</span><span id="line-45"> * &lt;pre&gt;</span>
<span class="source-line-no">046</span><span id="line-46"> *              name          := pdbID</span>
<span class="source-line-no">047</span><span id="line-47"> *                             | pdbID '.' chainID</span>
<span class="source-line-no">048</span><span id="line-48"> *                             | pdbID '.' range</span>
<span class="source-line-no">049</span><span id="line-49"> *              range         := range (',' range)?</span>
<span class="source-line-no">050</span><span id="line-50"> *                             | chainID</span>
<span class="source-line-no">051</span><span id="line-51"> *                             | chainID '_' resNum '-' resNum</span>
<span class="source-line-no">052</span><span id="line-52"> *              pdbID         := [1-9][a-zA-Z0-9]{3}</span>
<span class="source-line-no">053</span><span id="line-53"> *                             | PDB_[a-zA-Z0-9]{8}</span>
<span class="source-line-no">054</span><span id="line-54"> *              chainID       := [a-zA-Z0-9]+</span>
<span class="source-line-no">055</span><span id="line-55"> *              resNum        := [-+]?[0-9]+[A-Za-z]?</span>
<span class="source-line-no">056</span><span id="line-56"> * &lt;/pre&gt;</span>
<span class="source-line-no">057</span><span id="line-57"> * For example:</span>
<span class="source-line-no">058</span><span id="line-58"> * &lt;pre&gt;</span>
<span class="source-line-no">059</span><span id="line-59"> *              1TIM                                    #whole structure (short format)</span>
<span class="source-line-no">060</span><span id="line-60"> *              1tim                                    #same as above</span>
<span class="source-line-no">061</span><span id="line-61"> *              4HHB.C                                  #single chain</span>
<span class="source-line-no">062</span><span id="line-62"> *              3AA0.A,B                                #two chains</span>
<span class="source-line-no">063</span><span id="line-63"> *              4GCR.A_1-40                             #substructure</span>
<span class="source-line-no">064</span><span id="line-64"> *      3iek.A_17-28,A_56-294,A_320-377         #substructure of 3 disjoint parts</span>
<span class="source-line-no">065</span><span id="line-65"> *              PDB_00001TIM                            #whole structure (extended format)</span>
<span class="source-line-no">066</span><span id="line-66"> *              pdb_00001tim                            #same as above</span>
<span class="source-line-no">067</span><span id="line-67"> *              PDB_00004HHB.C                          #single chain</span>
<span class="source-line-no">068</span><span id="line-68"> *              PDB_00003AA0.A,B                        #two chains</span>
<span class="source-line-no">069</span><span id="line-69"> *              PDB_00004GCR.A_1-40                     #substructure</span>
<span class="source-line-no">070</span><span id="line-70"> *      pdb_00003iek.A_17-28,A_56-294,A_320-377 #substructure of 3 disjoint parts</span>
<span class="source-line-no">071</span><span id="line-71"> * &lt;/pre&gt;</span>
<span class="source-line-no">072</span><span id="line-72"> * More options may be added to the specification at a future time.</span>
<span class="source-line-no">073</span><span id="line-73"></span>
<span class="source-line-no">074</span><span id="line-74"> * @author dmyersturnbull</span>
<span class="source-line-no">075</span><span id="line-75"> * @author Spencer Bliven</span>
<span class="source-line-no">076</span><span id="line-76"> */</span>
<span class="source-line-no">077</span><span id="line-77">public class SubstructureIdentifier implements StructureIdentifier {</span>
<span class="source-line-no">078</span><span id="line-78"></span>
<span class="source-line-no">079</span><span id="line-79">        private static final long serialVersionUID = 1L;</span>
<span class="source-line-no">080</span><span id="line-80"></span>
<span class="source-line-no">081</span><span id="line-81">        private static final Logger logger = LoggerFactory.getLogger(SubstructureIdentifier.class);</span>
<span class="source-line-no">082</span><span id="line-82"></span>
<span class="source-line-no">083</span><span id="line-83"></span>
<span class="source-line-no">084</span><span id="line-84">        private final PdbId pdbId;</span>
<span class="source-line-no">085</span><span id="line-85">        private final List&lt;ResidueRange&gt; ranges;</span>
<span class="source-line-no">086</span><span id="line-86"></span>
<span class="source-line-no">087</span><span id="line-87">        /**</span>
<span class="source-line-no">088</span><span id="line-88">         * Create a new identifier from a string.</span>
<span class="source-line-no">089</span><span id="line-89">         * @param id</span>
<span class="source-line-no">090</span><span id="line-90">         */</span>
<span class="source-line-no">091</span><span id="line-91">        public SubstructureIdentifier(String id) {</span>
<span class="source-line-no">092</span><span id="line-92">                String[] idRange = id.split("\\.");</span>
<span class="source-line-no">093</span><span id="line-93">                if(1 &gt; idRange.length || idRange.length &gt; 2 ) {</span>
<span class="source-line-no">094</span><span id="line-94">                        throw new IllegalArgumentException(String.format("Malformed %s: %s",getClass().getSimpleName(),id));</span>
<span class="source-line-no">095</span><span id="line-95">                }</span>
<span class="source-line-no">096</span><span id="line-96">                //used tempId to avoid writing 2 assignment statements to a final field,</span>
<span class="source-line-no">097</span><span id="line-97">                // although one is in the try block and the other in the catch block.</span>
<span class="source-line-no">098</span><span id="line-98">                PdbId tempId = null;</span>
<span class="source-line-no">099</span><span id="line-99">                try {</span>
<span class="source-line-no">100</span><span id="line-100">                        tempId = new PdbId(idRange[0]);</span>
<span class="source-line-no">101</span><span id="line-101">                } catch (IllegalArgumentException e) {</span>
<span class="source-line-no">102</span><span id="line-102">                        // Changed from Exception to a warning to support files and stuff -sbliven 2015/01/22</span>
<span class="source-line-no">103</span><span id="line-103">                        logger.warn(String.format("Unrecognized PDB code %s", idRange[0]));</span>
<span class="source-line-no">104</span><span id="line-104">                }</span>
<span class="source-line-no">105</span><span id="line-105">                this.pdbId = tempId;</span>
<span class="source-line-no">106</span><span id="line-106">                </span>
<span class="source-line-no">107</span><span id="line-107">                if( idRange.length == 2) {</span>
<span class="source-line-no">108</span><span id="line-108">                        String rangeStr = idRange[1].trim();</span>
<span class="source-line-no">109</span><span id="line-109"></span>
<span class="source-line-no">110</span><span id="line-110">                        this.ranges = ResidueRange.parseMultiple(rangeStr);</span>
<span class="source-line-no">111</span><span id="line-111">                } else {</span>
<span class="source-line-no">112</span><span id="line-112">                        this.ranges = new LinkedList&lt;&gt;();</span>
<span class="source-line-no">113</span><span id="line-113">                }</span>
<span class="source-line-no">114</span><span id="line-114">        }</span>
<span class="source-line-no">115</span><span id="line-115"></span>
<span class="source-line-no">116</span><span id="line-116">        /**</span>
<span class="source-line-no">117</span><span id="line-117">         * Create a new identifier based on a set of ranges.</span>
<span class="source-line-no">118</span><span id="line-118">         *</span>
<span class="source-line-no">119</span><span id="line-119">         * If ranges is empty, includes all residues.</span>
<span class="source-line-no">120</span><span id="line-120">         * @param pdbId a pdb id, can't be null</span>
<span class="source-line-no">121</span><span id="line-121">         * @param ranges the ranges</span>
<span class="source-line-no">122</span><span id="line-122">         */</span>
<span class="source-line-no">123</span><span id="line-123">        public SubstructureIdentifier(String pdbId, List&lt;ResidueRange&gt; ranges) {</span>
<span class="source-line-no">124</span><span id="line-124">                this(new PdbId(pdbId), ranges);</span>
<span class="source-line-no">125</span><span id="line-125">        }</span>
<span class="source-line-no">126</span><span id="line-126"></span>
<span class="source-line-no">127</span><span id="line-127">        /**</span>
<span class="source-line-no">128</span><span id="line-128">         * Create a new identifier based on a set of ranges.</span>
<span class="source-line-no">129</span><span id="line-129">         *</span>
<span class="source-line-no">130</span><span id="line-130">         * If ranges is empty, includes all residues.</span>
<span class="source-line-no">131</span><span id="line-131">         * @param pdbId</span>
<span class="source-line-no">132</span><span id="line-132">         * @param ranges</span>
<span class="source-line-no">133</span><span id="line-133">         */</span>
<span class="source-line-no">134</span><span id="line-134">        public SubstructureIdentifier(PdbId pdbId, List&lt;ResidueRange&gt; ranges) {</span>
<span class="source-line-no">135</span><span id="line-135">                if(ranges == null) {</span>
<span class="source-line-no">136</span><span id="line-136">                        throw new NullPointerException("Null ranges list");</span>
<span class="source-line-no">137</span><span id="line-137">                }</span>
<span class="source-line-no">138</span><span id="line-138">                this.pdbId = pdbId;</span>
<span class="source-line-no">139</span><span id="line-139">                this.ranges = ranges;</span>
<span class="source-line-no">140</span><span id="line-140">        }</span>
<span class="source-line-no">141</span><span id="line-141"></span>
<span class="source-line-no">142</span><span id="line-142">        @Override</span>
<span class="source-line-no">143</span><span id="line-143">        public String toString() {</span>
<span class="source-line-no">144</span><span id="line-144">                return getIdentifier();</span>
<span class="source-line-no">145</span><span id="line-145">        }</span>
<span class="source-line-no">146</span><span id="line-146"></span>
<span class="source-line-no">147</span><span id="line-147">        /**</span>
<span class="source-line-no">148</span><span id="line-148">         * Get the String form of this identifier.</span>
<span class="source-line-no">149</span><span id="line-149">         *</span>
<span class="source-line-no">150</span><span id="line-150">         * This provides the canonical form for a StructureIdentifier and has</span>
<span class="source-line-no">151</span><span id="line-151">         * all the information needed to recreate a particular substructure.</span>
<span class="source-line-no">152</span><span id="line-152">         *</span>
<span class="source-line-no">153</span><span id="line-153">         * Example: 3iek.A_17-28,A_56-294</span>
<span class="source-line-no">154</span><span id="line-154">         * @return The String form of this identifier</span>
<span class="source-line-no">155</span><span id="line-155">         */</span>
<span class="source-line-no">156</span><span id="line-156">        @Override</span>
<span class="source-line-no">157</span><span id="line-157">        public String getIdentifier() {</span>
<span class="source-line-no">158</span><span id="line-158">                String pdbId = this.pdbId == null? "": this.pdbId.getId();</span>
<span class="source-line-no">159</span><span id="line-159">                if (ranges.isEmpty()) return pdbId;</span>
<span class="source-line-no">160</span><span id="line-160">                return pdbId + "." + ResidueRange.toString(ranges);</span>
<span class="source-line-no">161</span><span id="line-161">        }</span>
<span class="source-line-no">162</span><span id="line-162"></span>
<span class="source-line-no">163</span><span id="line-163">        /**</span>
<span class="source-line-no">164</span><span id="line-164">         * Get the PDB identifier part of the SubstructureIdentifier</span>
<span class="source-line-no">165</span><span id="line-165">         * @return the PDB ID</span>
<span class="source-line-no">166</span><span id="line-166">         */</span>
<span class="source-line-no">167</span><span id="line-167">        public PdbId getPdbId() {</span>
<span class="source-line-no">168</span><span id="line-168">                return pdbId;</span>
<span class="source-line-no">169</span><span id="line-169">        }</span>
<span class="source-line-no">170</span><span id="line-170">        </span>
<span class="source-line-no">171</span><span id="line-171">        public List&lt;ResidueRange&gt; getResidueRanges() {</span>
<span class="source-line-no">172</span><span id="line-172">                return ranges;</span>
<span class="source-line-no">173</span><span id="line-173">        }</span>
<span class="source-line-no">174</span><span id="line-174"></span>
<span class="source-line-no">175</span><span id="line-175">        /**</span>
<span class="source-line-no">176</span><span id="line-176">         * Return itself. SubstructureIdentifiers are canonical!</span>
<span class="source-line-no">177</span><span id="line-177">         */</span>
<span class="source-line-no">178</span><span id="line-178">        @Override</span>
<span class="source-line-no">179</span><span id="line-179">        public SubstructureIdentifier toCanonical() {</span>
<span class="source-line-no">180</span><span id="line-180">                return this;</span>
<span class="source-line-no">181</span><span id="line-181">        }</span>
<span class="source-line-no">182</span><span id="line-182"></span>
<span class="source-line-no">183</span><span id="line-183">        /**</span>
<span class="source-line-no">184</span><span id="line-184">         * Takes a complete structure as input and reduces it to residues present in</span>
<span class="source-line-no">185</span><span id="line-185">         * the specified ranges</span>
<span class="source-line-no">186</span><span id="line-186">         *</span>
<span class="source-line-no">187</span><span id="line-187">         * &lt;p&gt;The returned structure will be a shallow copy of the input, with shared</span>
<span class="source-line-no">188</span><span id="line-188">         * Chains, Residues, etc.</span>
<span class="source-line-no">189</span><span id="line-189">         *</span>
<span class="source-line-no">190</span><span id="line-190">         * &lt;p&gt;Ligands are handled in a special way. If a full chain is selected</span>
<span class="source-line-no">191</span><span id="line-191">         * (e.g. '1ABC.A') then any waters and ligands with matching chain name are</span>
<span class="source-line-no">192</span><span id="line-192">         * included. If a residue range is present ('1ABC.A:1-100') then any</span>
<span class="source-line-no">193</span><span id="line-193">         * ligands (technically non-water non-polymer atoms) within</span>
<span class="source-line-no">194</span><span id="line-194">         * {@link StructureTools#DEFAULT_LIGAND_PROXIMITY_CUTOFF} of the selected</span>
<span class="source-line-no">195</span><span id="line-195">         * range are included, regardless of chain.</span>
<span class="source-line-no">196</span><span id="line-196">         * @param s A full structure, e.g. as loaded from the PDB. The structure</span>
<span class="source-line-no">197</span><span id="line-197">         * ID should match that returned by getPdbId().</span>
<span class="source-line-no">198</span><span id="line-198">         * @return</span>
<span class="source-line-no">199</span><span id="line-199">         * @throws StructureException</span>
<span class="source-line-no">200</span><span id="line-200">         */</span>
<span class="source-line-no">201</span><span id="line-201">        @Override</span>
<span class="source-line-no">202</span><span id="line-202">        public Structure reduce(Structure s) throws StructureException {</span>
<span class="source-line-no">203</span><span id="line-203">                // Follows StructureImpl.clone()</span>
<span class="source-line-no">204</span><span id="line-204"></span>
<span class="source-line-no">205</span><span id="line-205">                if(s == null)</span>
<span class="source-line-no">206</span><span id="line-206">                        throw new StructureException("NullPointerException Possibly due to malformed PIBId format.");</span>
<span class="source-line-no">207</span><span id="line-207"></span>
<span class="source-line-no">208</span><span id="line-208">                // Create new structure &amp; copy basic properties</span>
<span class="source-line-no">209</span><span id="line-209">                Structure newS = new StructureImpl();</span>
<span class="source-line-no">210</span><span id="line-210"></span>
<span class="source-line-no">211</span><span id="line-211">                newS.setPdbId(s.getPdbId());</span>
<span class="source-line-no">212</span><span id="line-212">                newS.setPDBHeader(s.getPDBHeader());</span>
<span class="source-line-no">213</span><span id="line-213">                newS.setName(this.toString());</span>
<span class="source-line-no">214</span><span id="line-214">                newS.setDBRefs(s.getDBRefs());</span>
<span class="source-line-no">215</span><span id="line-215">                newS.setBiologicalAssembly(s.isBiologicalAssembly());</span>
<span class="source-line-no">216</span><span id="line-216">                newS.getPDBHeader().setDescription(</span>
<span class="source-line-no">217</span><span id="line-217">                                "sub-range " + ranges + " of "  + newS.getPdbId() + " "</span>
<span class="source-line-no">218</span><span id="line-218">                                                + s.getPDBHeader().getDescription());</span>
<span class="source-line-no">219</span><span id="line-219">                newS.setEntityInfos(new ArrayList&lt;&gt;());</span>
<span class="source-line-no">220</span><span id="line-220">                // TODO The following should be only copied for atoms which are present in the range.</span>
<span class="source-line-no">221</span><span id="line-221">                newS.setSSBonds(s.getSSBonds());</span>
<span class="source-line-no">222</span><span id="line-222">                newS.setSites(s.getSites());</span>
<span class="source-line-no">223</span><span id="line-223"></span>
<span class="source-line-no">224</span><span id="line-224">                newS.setStructureIdentifier(this);</span>
<span class="source-line-no">225</span><span id="line-225"></span>
<span class="source-line-no">226</span><span id="line-226">                for( int modelNr=0;modelNr&lt;s.nrModels();modelNr++) {</span>
<span class="source-line-no">227</span><span id="line-227"></span>
<span class="source-line-no">228</span><span id="line-228">                        // Construct new model</span>
<span class="source-line-no">229</span><span id="line-229">                        newS.addModel(new ArrayList&lt;Chain&gt;());</span>
<span class="source-line-no">230</span><span id="line-230"></span>
<span class="source-line-no">231</span><span id="line-231">                        if(getResidueRanges().isEmpty()) {</span>
<span class="source-line-no">232</span><span id="line-232">                                // Include all residues</span>
<span class="source-line-no">233</span><span id="line-233">                                newS.setEntityInfos(s.getEntityInfos());</span>
<span class="source-line-no">234</span><span id="line-234">                                newS.setSSBonds(s.getSSBonds());</span>
<span class="source-line-no">235</span><span id="line-235">                                newS.setSites(s.getSites());</span>
<span class="source-line-no">236</span><span id="line-236"></span>
<span class="source-line-no">237</span><span id="line-237">                                newS.setModel(modelNr, s.getModel(modelNr));</span>
<span class="source-line-no">238</span><span id="line-238">                        } else {</span>
<span class="source-line-no">239</span><span id="line-239">                                // Restrict residues</span>
<span class="source-line-no">240</span><span id="line-240">                                for( ResidueRange range: getResidueRanges()) {</span>
<span class="source-line-no">241</span><span id="line-241"></span>
<span class="source-line-no">242</span><span id="line-242">                                        String chainName = range.getChainName();</span>
<span class="source-line-no">243</span><span id="line-243">                                        ResidueNumber pdbresnum1 = range.getStart();</span>
<span class="source-line-no">244</span><span id="line-244">                                        ResidueNumber pdbresnum2 = range.getEnd();</span>
<span class="source-line-no">245</span><span id="line-245"></span>
<span class="source-line-no">246</span><span id="line-246">//                                      StructureTools.addGroupsToStructure(newS, groups, modelNr, false);</span>
<span class="source-line-no">247</span><span id="line-247">                                        Chain polyChain; //polymer</span>
<span class="source-line-no">248</span><span id="line-248">                                        if("_".equals(chainName) ) {</span>
<span class="source-line-no">249</span><span id="line-249">                                                // Handle special case of "_" chain for single-chain proteins</span>
<span class="source-line-no">250</span><span id="line-250">                                                polyChain = s.getPolyChains(modelNr).get(0);</span>
<span class="source-line-no">251</span><span id="line-251">                                                chainName = polyChain.getName();</span>
<span class="source-line-no">252</span><span id="line-252">                                                if(pdbresnum1 != null)</span>
<span class="source-line-no">253</span><span id="line-253">                                                        pdbresnum1.setChainName(chainName);</span>
<span class="source-line-no">254</span><span id="line-254">                                                if(pdbresnum2 != null)</span>
<span class="source-line-no">255</span><span id="line-255">                                                        pdbresnum2.setChainName(chainName);</span>
<span class="source-line-no">256</span><span id="line-256"></span>
<span class="source-line-no">257</span><span id="line-257">                                                if(s.getPolyChains().size() != 1) {</span>
<span class="source-line-no">258</span><span id="line-258">                                                        // SCOP 1.71 uses this for some proteins with multiple chains</span>
<span class="source-line-no">259</span><span id="line-259">                                                        // Print a warning in this ambiguous case</span>
<span class="source-line-no">260</span><span id="line-260">                                                        logger.warn("Multiple possible chains match '_'. Using chain {}",chainName);</span>
<span class="source-line-no">261</span><span id="line-261">                                                }</span>
<span class="source-line-no">262</span><span id="line-262">                                        } else {</span>
<span class="source-line-no">263</span><span id="line-263">                                                // Explicit chain</span>
<span class="source-line-no">264</span><span id="line-264">                                                polyChain = s.getPolyChainByPDB(chainName,modelNr);</span>
<span class="source-line-no">265</span><span id="line-265">                                                if( polyChain == null ) {</span>
<span class="source-line-no">266</span><span id="line-266">                                                        // Chain not found</span>
<span class="source-line-no">267</span><span id="line-267">                                                        // Maybe it was a chain index, masquerading as a chainName?</span>
<span class="source-line-no">268</span><span id="line-268">                                                        try {</span>
<span class="source-line-no">269</span><span id="line-269">                                                                int chainNum = Integer.parseInt(chainName);</span>
<span class="source-line-no">270</span><span id="line-270">                                                                polyChain = s.getChainByIndex(modelNr, chainNum);</span>
<span class="source-line-no">271</span><span id="line-271">                                                                chainName = polyChain.getName();</span>
<span class="source-line-no">272</span><span id="line-272">                                                                if(pdbresnum1 != null)</span>
<span class="source-line-no">273</span><span id="line-273">                                                                        pdbresnum1.setChainName(chainName);</span>
<span class="source-line-no">274</span><span id="line-274">                                                                if(pdbresnum2 != null)</span>
<span class="source-line-no">275</span><span id="line-275">                                                                        pdbresnum2.setChainName(chainName);</span>
<span class="source-line-no">276</span><span id="line-276">                                                                logger.warn("No chain found for {}. Interpretting it as an index, using chain {} instead",chainName,polyChain.getId());</span>
<span class="source-line-no">277</span><span id="line-277">                                                        } catch(NumberFormatException e3) {</span>
<span class="source-line-no">278</span><span id="line-278">                                                                // Not an index. Throw the original exception</span>
<span class="source-line-no">279</span><span id="line-279">                                                                throw new StructureException(String.format("Unrecognized chain %s in %s",chainName,getIdentifier()));</span>
<span class="source-line-no">280</span><span id="line-280">                                                        }</span>
<span class="source-line-no">281</span><span id="line-281">                                                }</span>
<span class="source-line-no">282</span><span id="line-282">                                        }</span>
<span class="source-line-no">283</span><span id="line-283"></span>
<span class="source-line-no">284</span><span id="line-284">                                        if(pdbresnum1 == null &amp;&amp; pdbresnum2 == null) {</span>
<span class="source-line-no">285</span><span id="line-285">                                                // Include all atoms with matching chainName</span>
<span class="source-line-no">286</span><span id="line-286">                                                StructureTools.addGroupsToStructure(newS, polyChain.getAtomGroups(), modelNr, false);</span>
<span class="source-line-no">287</span><span id="line-287">                                                for(Chain chain : s.getNonPolyChainsByPDB(chainName, modelNr) ) {</span>
<span class="source-line-no">288</span><span id="line-288">                                                        StructureTools.addGroupsToStructure(newS, chain.getAtomGroups(), modelNr, false);</span>
<span class="source-line-no">289</span><span id="line-289">                                                }</span>
<span class="source-line-no">290</span><span id="line-290">                                                Chain waters = s.getWaterChainByPDB(chainName, modelNr);</span>
<span class="source-line-no">291</span><span id="line-291">                                                if( waters != null) {</span>
<span class="source-line-no">292</span><span id="line-292">                                                        StructureTools.addGroupsToStructure(newS, waters.getAtomGroups(), modelNr, false);</span>
<span class="source-line-no">293</span><span id="line-293">                                                }</span>
<span class="source-line-no">294</span><span id="line-294"></span>
<span class="source-line-no">295</span><span id="line-295">                                                // TODO do we need to prune SeqRes down to the atoms present? -SB 2016-10-7</span>
<span class="source-line-no">296</span><span id="line-296">                                        } else {</span>
<span class="source-line-no">297</span><span id="line-297">                                                // Include polymer range and any proximal ligands</span>
<span class="source-line-no">298</span><span id="line-298">                                                List&lt;Group&gt; polygroups = Arrays.asList(polyChain.getGroupsByPDB(pdbresnum1, pdbresnum2));</span>
<span class="source-line-no">299</span><span id="line-299">                                                StructureTools.addGroupsToStructure(newS, polygroups, modelNr, false);</span>
<span class="source-line-no">300</span><span id="line-300">                                                copyLigandsByProximity(s,newS, StructureTools.DEFAULT_LIGAND_PROXIMITY_CUTOFF, modelNr, modelNr);</span>
<span class="source-line-no">301</span><span id="line-301">                                        }</span>
<span class="source-line-no">302</span><span id="line-302">                                } // end range</span>
<span class="source-line-no">303</span><span id="line-303">                        }</span>
<span class="source-line-no">304</span><span id="line-304">                } // end modelNr</span>
<span class="source-line-no">305</span><span id="line-305"></span>
<span class="source-line-no">306</span><span id="line-306">                return newS;</span>
<span class="source-line-no">307</span><span id="line-307">        }</span>
<span class="source-line-no">308</span><span id="line-308"></span>
<span class="source-line-no">309</span><span id="line-309">        /**</span>
<span class="source-line-no">310</span><span id="line-310">         * Loads the complete structure based on {@link #getPdbId()}.</span>
<span class="source-line-no">311</span><span id="line-311">         *</span>
<span class="source-line-no">312</span><span id="line-312">         * @param cache A source of structures</span>
<span class="source-line-no">313</span><span id="line-313">         * @return A Structure containing at least the atoms identified by this,</span>
<span class="source-line-no">314</span><span id="line-314">         *  or null if no PDB ID is set</span>
<span class="source-line-no">315</span><span id="line-315">         * @throws StructureException For errors loading and parsing the structure</span>
<span class="source-line-no">316</span><span id="line-316">         * @throws IOException Errors reading the structure from disk</span>
<span class="source-line-no">317</span><span id="line-317">         */</span>
<span class="source-line-no">318</span><span id="line-318">        @Override</span>
<span class="source-line-no">319</span><span id="line-319">        public Structure loadStructure(AtomCache cache) throws IOException, StructureException {</span>
<span class="source-line-no">320</span><span id="line-320">                PdbId pdb = getPdbId();</span>
<span class="source-line-no">321</span><span id="line-321">                if(pdb == null)</span>
<span class="source-line-no">322</span><span id="line-322">                        return null;</span>
<span class="source-line-no">323</span><span id="line-323">                return cache.getStructureForPdbId(pdb);</span>
<span class="source-line-no">324</span><span id="line-324">        }</span>
<span class="source-line-no">325</span><span id="line-325"></span>
<span class="source-line-no">326</span><span id="line-326">        /**</span>
<span class="source-line-no">327</span><span id="line-327">         * Supplements the reduced structure with ligands from the full structure based on</span>
<span class="source-line-no">328</span><span id="line-328">         * a distance cutoff. Ligand groups are moved (destructively) from full to reduced</span>
<span class="source-line-no">329</span><span id="line-329">         * if they fall within the cutoff of any atom in the reduced structure.</span>
<span class="source-line-no">330</span><span id="line-330">         * The {@link StructureTools#DEFAULT_LIGAND_PROXIMITY_CUTOFF default cutoff}</span>
<span class="source-line-no">331</span><span id="line-331">         * is used.</span>
<span class="source-line-no">332</span><span id="line-332">         * @param full Structure containing all ligands</span>
<span class="source-line-no">333</span><span id="line-333">         * @param reduced Structure with a subset of the polymer groups from full</span>
<span class="source-line-no">334</span><span id="line-334">         * @see StructureTools#getLigandsByProximity(java.util.Collection, Atom[], double)</span>
<span class="source-line-no">335</span><span id="line-335">         */</span>
<span class="source-line-no">336</span><span id="line-336">        protected static void copyLigandsByProximity(Structure full, Structure reduced) {</span>
<span class="source-line-no">337</span><span id="line-337">                // Normal case where all models should be copied from full to reduced</span>
<span class="source-line-no">338</span><span id="line-338">                assert full.nrModels() &gt;= reduced.nrModels();</span>
<span class="source-line-no">339</span><span id="line-339">                for(int model = 0; model&lt; reduced.nrModels(); model++) {</span>
<span class="source-line-no">340</span><span id="line-340">                        copyLigandsByProximity(full, reduced, StructureTools.DEFAULT_LIGAND_PROXIMITY_CUTOFF, model, model);</span>
<span class="source-line-no">341</span><span id="line-341">                }</span>
<span class="source-line-no">342</span><span id="line-342">        }</span>
<span class="source-line-no">343</span><span id="line-343">        /**</span>
<span class="source-line-no">344</span><span id="line-344">         * Supplements the reduced structure with ligands from the full structure based on</span>
<span class="source-line-no">345</span><span id="line-345">         * a distance cutoff. Ligand groups are moved (destructively) from full to reduced</span>
<span class="source-line-no">346</span><span id="line-346">         * if they fall within the cutoff of any atom in the reduced structure.</span>
<span class="source-line-no">347</span><span id="line-347">         * @param full Structure containing all ligands</span>
<span class="source-line-no">348</span><span id="line-348">         * @param reduced Structure with a subset of the polymer groups from full</span>
<span class="source-line-no">349</span><span id="line-349">         * @param cutoff Distance cutoff (Ã…)</span>
<span class="source-line-no">350</span><span id="line-350">         * @param fromModel source model in full</span>
<span class="source-line-no">351</span><span id="line-351">         * @param toModel destination model in reduced</span>
<span class="source-line-no">352</span><span id="line-352">         * @see StructureTools#getLigandsByProximity(java.util.Collection, Atom[], double)</span>
<span class="source-line-no">353</span><span id="line-353">         */</span>
<span class="source-line-no">354</span><span id="line-354">        protected static void copyLigandsByProximity(Structure full, Structure reduced, double cutoff, int fromModel, int toModel) {</span>
<span class="source-line-no">355</span><span id="line-355">                // Geometric hashing of the reduced structure</span>
<span class="source-line-no">356</span><span id="line-356">                Grid grid = new Grid(cutoff);</span>
<span class="source-line-no">357</span><span id="line-357">                Atom[] nonwaters = StructureTools.getAllNonHAtomArray(reduced,true,toModel);</span>
<span class="source-line-no">358</span><span id="line-358">                if( nonwaters.length &lt; 1 )</span>
<span class="source-line-no">359</span><span id="line-359">                        return;</span>
<span class="source-line-no">360</span><span id="line-360">                grid.addAtoms(nonwaters);</span>
<span class="source-line-no">361</span><span id="line-361"></span>
<span class="source-line-no">362</span><span id="line-362">                full.getNonPolyChains(fromModel).stream() //potential ligand chains</span>
<span class="source-line-no">363</span><span id="line-363">                .flatMap((chain) -&gt; chain.getAtomGroups().stream() ) // potential ligand groups</span>
<span class="source-line-no">364</span><span id="line-364">                .filter( (g) -&gt; !g.isWater() ) // ignore waters</span>
<span class="source-line-no">365</span><span id="line-365">                .filter( (g) -&gt; !g.isPolymeric() ) // already shouldn't be polymeric, but filter anyways</span>
<span class="source-line-no">366</span><span id="line-366">                .filter( (g) -&gt; grid.hasAnyContact(Calc.atomsToPoints(g.getAtoms())) ) // must contact reduced</span>
<span class="source-line-no">367</span><span id="line-367">                .sequential() // Keeps ligands from the same chain together if possible</span>
<span class="source-line-no">368</span><span id="line-368">                .reduce((Chain)null, // reduction updates the chain guess</span>
<span class="source-line-no">369</span><span id="line-369">                                (guess, g ) -&gt; {</span>
<span class="source-line-no">370</span><span id="line-370">                                        boolean wasAdded;</span>
<span class="source-line-no">371</span><span id="line-371">                                        try {</span>
<span class="source-line-no">372</span><span id="line-372">                                                // Check that it's not in reduced already</span>
<span class="source-line-no">373</span><span id="line-373">                                                wasAdded = reduced.findGroup(g.getChainId(),</span>
<span class="source-line-no">374</span><span id="line-374">                                                                g.getResidueNumber().toString(), toModel) != null;</span>
<span class="source-line-no">375</span><span id="line-375">                                        } catch (StructureException e) {</span>
<span class="source-line-no">376</span><span id="line-376">                                                // not found</span>
<span class="source-line-no">377</span><span id="line-377">                                                wasAdded = false;</span>
<span class="source-line-no">378</span><span id="line-378">                                        }</span>
<span class="source-line-no">379</span><span id="line-379">                                        if( !wasAdded ) {</span>
<span class="source-line-no">380</span><span id="line-380">                                                // Add the ligand to reduced</span>
<span class="source-line-no">381</span><span id="line-381">                                                // note this is not idempotent, but it is synchronized on reduced</span>
<span class="source-line-no">382</span><span id="line-382">                                                logger.info("Adding ligand group {} {} by proximity",g.getPDBName(), g.getResidueNumber().toPDB());</span>
<span class="source-line-no">383</span><span id="line-383">                                                return StructureTools.addGroupToStructure(reduced, g, toModel, guess, false);</span>
<span class="source-line-no">384</span><span id="line-384">                                        }</span>
<span class="source-line-no">385</span><span id="line-385">                                        return guess;</span>
<span class="source-line-no">386</span><span id="line-386">                                },</span>
<span class="source-line-no">387</span><span id="line-387">                                // update to the new guess</span>
<span class="source-line-no">388</span><span id="line-388">                                (oldGuess, newGuess) -&gt; newGuess );</span>
<span class="source-line-no">389</span><span id="line-389">        }</span>
<span class="source-line-no">390</span><span id="line-390"></span>
<span class="source-line-no">391</span><span id="line-391">}</span>




























































</pre>
</div>
</main>
</body>
</html>
