<!DOCTYPE HTML>
<html lang>
<head>
<!-- Generated by javadoc (21) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: org.biojava.nbio.structure.io.cif, class: CifStructureConsumerImpl">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">package org.biojava.nbio.structure.io.cif;</span>
<span class="source-line-no">002</span><span id="line-2"></span>
<span class="source-line-no">003</span><span id="line-3">import java.time.LocalDate;</span>
<span class="source-line-no">004</span><span id="line-4">import java.time.ZoneId;</span>
<span class="source-line-no">005</span><span id="line-5">import java.time.format.DateTimeFormatter;</span>
<span class="source-line-no">006</span><span id="line-6">import java.time.format.DateTimeFormatterBuilder;</span>
<span class="source-line-no">007</span><span id="line-7">import java.util.ArrayList;</span>
<span class="source-line-no">008</span><span id="line-8">import java.util.Date;</span>
<span class="source-line-no">009</span><span id="line-9">import java.util.HashMap;</span>
<span class="source-line-no">010</span><span id="line-10">import java.util.LinkedHashMap;</span>
<span class="source-line-no">011</span><span id="line-11">import java.util.List;</span>
<span class="source-line-no">012</span><span id="line-12">import java.util.Locale;</span>
<span class="source-line-no">013</span><span id="line-13">import java.util.Map;</span>
<span class="source-line-no">014</span><span id="line-14">import java.util.NoSuchElementException;</span>
<span class="source-line-no">015</span><span id="line-15">import java.util.Optional;</span>
<span class="source-line-no">016</span><span id="line-16">import java.util.OptionalInt;</span>
<span class="source-line-no">017</span><span id="line-17">import java.util.stream.IntStream;</span>
<span class="source-line-no">018</span><span id="line-18"></span>
<span class="source-line-no">019</span><span id="line-19">import javax.vecmath.Matrix4d;</span>
<span class="source-line-no">020</span><span id="line-20"></span>
<span class="source-line-no">021</span><span id="line-21">import org.biojava.nbio.structure.AminoAcid;</span>
<span class="source-line-no">022</span><span id="line-22">import org.biojava.nbio.structure.AminoAcidImpl;</span>
<span class="source-line-no">023</span><span id="line-23">import org.biojava.nbio.structure.Atom;</span>
<span class="source-line-no">024</span><span id="line-24">import org.biojava.nbio.structure.AtomImpl;</span>
<span class="source-line-no">025</span><span id="line-25">import org.biojava.nbio.structure.Chain;</span>
<span class="source-line-no">026</span><span id="line-26">import org.biojava.nbio.structure.ChainImpl;</span>
<span class="source-line-no">027</span><span id="line-27">import org.biojava.nbio.structure.DBRef;</span>
<span class="source-line-no">028</span><span id="line-28">import org.biojava.nbio.structure.Element;</span>
<span class="source-line-no">029</span><span id="line-29">import org.biojava.nbio.structure.EntityInfo;</span>
<span class="source-line-no">030</span><span id="line-30">import org.biojava.nbio.structure.EntityType;</span>
<span class="source-line-no">031</span><span id="line-31">import org.biojava.nbio.structure.Group;</span>
<span class="source-line-no">032</span><span id="line-32">import org.biojava.nbio.structure.GroupType;</span>
<span class="source-line-no">033</span><span id="line-33">import org.biojava.nbio.structure.HetatomImpl;</span>
<span class="source-line-no">034</span><span id="line-34">import org.biojava.nbio.structure.NucleotideImpl;</span>
<span class="source-line-no">035</span><span id="line-35">import org.biojava.nbio.structure.PDBCrystallographicInfo;</span>
<span class="source-line-no">036</span><span id="line-36">import org.biojava.nbio.structure.PDBHeader;</span>
<span class="source-line-no">037</span><span id="line-37">import org.biojava.nbio.structure.PdbId;</span>
<span class="source-line-no">038</span><span id="line-38">import org.biojava.nbio.structure.ResidueNumber;</span>
<span class="source-line-no">039</span><span id="line-39">import org.biojava.nbio.structure.SeqMisMatch;</span>
<span class="source-line-no">040</span><span id="line-40">import org.biojava.nbio.structure.SeqMisMatchImpl;</span>
<span class="source-line-no">041</span><span id="line-41">import org.biojava.nbio.structure.Site;</span>
<span class="source-line-no">042</span><span id="line-42">import org.biojava.nbio.structure.Structure;</span>
<span class="source-line-no">043</span><span id="line-43">import org.biojava.nbio.structure.StructureException;</span>
<span class="source-line-no">044</span><span id="line-44">import org.biojava.nbio.structure.StructureImpl;</span>
<span class="source-line-no">045</span><span id="line-45">import org.biojava.nbio.structure.StructureTools;</span>
<span class="source-line-no">046</span><span id="line-46">import org.biojava.nbio.structure.chem.ChemCompGroupFactory;</span>
<span class="source-line-no">047</span><span id="line-47">import org.biojava.nbio.structure.io.BondMaker;</span>
<span class="source-line-no">048</span><span id="line-48">import org.biojava.nbio.structure.io.ChargeAdder;</span>
<span class="source-line-no">049</span><span id="line-49">import org.biojava.nbio.structure.io.EntityFinder;</span>
<span class="source-line-no">050</span><span id="line-50">import org.biojava.nbio.structure.io.FileParsingParameters;</span>
<span class="source-line-no">051</span><span id="line-51">import org.biojava.nbio.structure.io.SeqRes2AtomAligner;</span>
<span class="source-line-no">052</span><span id="line-52">import org.biojava.nbio.structure.quaternary.BioAssemblyInfo;</span>
<span class="source-line-no">053</span><span id="line-53">import org.biojava.nbio.structure.quaternary.BiologicalAssemblyBuilder;</span>
<span class="source-line-no">054</span><span id="line-54">import org.biojava.nbio.structure.quaternary.BiologicalAssemblyTransformation;</span>
<span class="source-line-no">055</span><span id="line-55">import org.biojava.nbio.structure.xtal.CrystalCell;</span>
<span class="source-line-no">056</span><span id="line-56">import org.biojava.nbio.structure.xtal.SpaceGroup;</span>
<span class="source-line-no">057</span><span id="line-57">import org.biojava.nbio.structure.xtal.SymoplibParser;</span>
<span class="source-line-no">058</span><span id="line-58">import org.rcsb.cif.model.FloatColumn;</span>
<span class="source-line-no">059</span><span id="line-59">import org.rcsb.cif.model.IntColumn;</span>
<span class="source-line-no">060</span><span id="line-60">import org.rcsb.cif.model.StrColumn;</span>
<span class="source-line-no">061</span><span id="line-61">import org.rcsb.cif.model.ValueKind;</span>
<span class="source-line-no">062</span><span id="line-62">import org.rcsb.cif.schema.mm.AtomSite;</span>
<span class="source-line-no">063</span><span id="line-63">import org.rcsb.cif.schema.mm.AtomSites;</span>
<span class="source-line-no">064</span><span id="line-64">import org.rcsb.cif.schema.mm.AuditAuthor;</span>
<span class="source-line-no">065</span><span id="line-65">import org.rcsb.cif.schema.mm.Cell;</span>
<span class="source-line-no">066</span><span id="line-66">import org.rcsb.cif.schema.mm.ChemComp;</span>
<span class="source-line-no">067</span><span id="line-67">import org.rcsb.cif.schema.mm.ChemCompBond;</span>
<span class="source-line-no">068</span><span id="line-68">import org.rcsb.cif.schema.mm.DatabasePDBRemark;</span>
<span class="source-line-no">069</span><span id="line-69">import org.rcsb.cif.schema.mm.DatabasePDBRev;</span>
<span class="source-line-no">070</span><span id="line-70">import org.rcsb.cif.schema.mm.DatabasePDBRevRecord;</span>
<span class="source-line-no">071</span><span id="line-71">import org.rcsb.cif.schema.mm.Em3dReconstruction;</span>
<span class="source-line-no">072</span><span id="line-72">import org.rcsb.cif.schema.mm.Entity;</span>
<span class="source-line-no">073</span><span id="line-73">import org.rcsb.cif.schema.mm.EntityPoly;</span>
<span class="source-line-no">074</span><span id="line-74">import org.rcsb.cif.schema.mm.EntityPolySeq;</span>
<span class="source-line-no">075</span><span id="line-75">import org.rcsb.cif.schema.mm.EntitySrcGen;</span>
<span class="source-line-no">076</span><span id="line-76">import org.rcsb.cif.schema.mm.EntitySrcNat;</span>
<span class="source-line-no">077</span><span id="line-77">import org.rcsb.cif.schema.mm.Exptl;</span>
<span class="source-line-no">078</span><span id="line-78">import org.rcsb.cif.schema.mm.PdbxAuditRevisionHistory;</span>
<span class="source-line-no">079</span><span id="line-79">import org.rcsb.cif.schema.mm.PdbxChemCompIdentifier;</span>
<span class="source-line-no">080</span><span id="line-80">import org.rcsb.cif.schema.mm.PdbxDatabaseStatus;</span>
<span class="source-line-no">081</span><span id="line-81">import org.rcsb.cif.schema.mm.PdbxEntityBranchDescriptor;</span>
<span class="source-line-no">082</span><span id="line-82">import org.rcsb.cif.schema.mm.PdbxEntitySrcSyn;</span>
<span class="source-line-no">083</span><span id="line-83">import org.rcsb.cif.schema.mm.PdbxMolecule;</span>
<span class="source-line-no">084</span><span id="line-84">import org.rcsb.cif.schema.mm.PdbxMoleculeFeatures;</span>
<span class="source-line-no">085</span><span id="line-85">import org.rcsb.cif.schema.mm.PdbxNonpolyScheme;</span>
<span class="source-line-no">086</span><span id="line-86">import org.rcsb.cif.schema.mm.PdbxReferenceEntityLink;</span>
<span class="source-line-no">087</span><span id="line-87">import org.rcsb.cif.schema.mm.PdbxReferenceEntityList;</span>
<span class="source-line-no">088</span><span id="line-88">import org.rcsb.cif.schema.mm.PdbxReferenceEntityPolyLink;</span>
<span class="source-line-no">089</span><span id="line-89">import org.rcsb.cif.schema.mm.PdbxStructAssembly;</span>
<span class="source-line-no">090</span><span id="line-90">import org.rcsb.cif.schema.mm.PdbxStructAssemblyGen;</span>
<span class="source-line-no">091</span><span id="line-91">import org.rcsb.cif.schema.mm.PdbxStructModResidue;</span>
<span class="source-line-no">092</span><span id="line-92">import org.rcsb.cif.schema.mm.PdbxStructOperList;</span>
<span class="source-line-no">093</span><span id="line-93">import org.rcsb.cif.schema.mm.Refine;</span>
<span class="source-line-no">094</span><span id="line-94">import org.rcsb.cif.schema.mm.Struct;</span>
<span class="source-line-no">095</span><span id="line-95">import org.rcsb.cif.schema.mm.StructAsym;</span>
<span class="source-line-no">096</span><span id="line-96">import org.rcsb.cif.schema.mm.StructConf;</span>
<span class="source-line-no">097</span><span id="line-97">import org.rcsb.cif.schema.mm.StructConn;</span>
<span class="source-line-no">098</span><span id="line-98">import org.rcsb.cif.schema.mm.StructConnType;</span>
<span class="source-line-no">099</span><span id="line-99">import org.rcsb.cif.schema.mm.StructKeywords;</span>
<span class="source-line-no">100</span><span id="line-100">import org.rcsb.cif.schema.mm.StructNcsOper;</span>
<span class="source-line-no">101</span><span id="line-101">import org.rcsb.cif.schema.mm.StructRef;</span>
<span class="source-line-no">102</span><span id="line-102">import org.rcsb.cif.schema.mm.StructRefSeq;</span>
<span class="source-line-no">103</span><span id="line-103">import org.rcsb.cif.schema.mm.StructRefSeqDif;</span>
<span class="source-line-no">104</span><span id="line-104">import org.rcsb.cif.schema.mm.StructSheetRange;</span>
<span class="source-line-no">105</span><span id="line-105">import org.rcsb.cif.schema.mm.StructSite;</span>
<span class="source-line-no">106</span><span id="line-106">import org.rcsb.cif.schema.mm.StructSiteGen;</span>
<span class="source-line-no">107</span><span id="line-107">import org.rcsb.cif.schema.mm.Symmetry;</span>
<span class="source-line-no">108</span><span id="line-108">import org.slf4j.Logger;</span>
<span class="source-line-no">109</span><span id="line-109">import org.slf4j.LoggerFactory;</span>
<span class="source-line-no">110</span><span id="line-110"></span>
<span class="source-line-no">111</span><span id="line-111">/**</span>
<span class="source-line-no">112</span><span id="line-112"> * An implementation of a CifFileConsumer for BioJava. Will process the information provided by a CifFile instance and</span>
<span class="source-line-no">113</span><span id="line-113"> * use it to build up a {@link Structure} object.</span>
<span class="source-line-no">114</span><span id="line-114"> * @author Sebastian Bittrich</span>
<span class="source-line-no">115</span><span id="line-115"> * @since 6.0.0</span>
<span class="source-line-no">116</span><span id="line-116"> */</span>
<span class="source-line-no">117</span><span id="line-117">public class CifStructureConsumerImpl implements CifStructureConsumer {</span>
<span class="source-line-no">118</span><span id="line-118">    private static final Logger logger = LoggerFactory.getLogger(CifStructureConsumerImpl.class);</span>
<span class="source-line-no">119</span><span id="line-119">    private static final DateTimeFormatter DATE_FORMAT = new DateTimeFormatterBuilder()</span>
<span class="source-line-no">120</span><span id="line-120">            .parseCaseInsensitive()</span>
<span class="source-line-no">121</span><span id="line-121">            .appendPattern("yyyy-MM-dd")</span>
<span class="source-line-no">122</span><span id="line-122">            .toFormatter(Locale.US);</span>
<span class="source-line-no">123</span><span id="line-123"></span>
<span class="source-line-no">124</span><span id="line-124">    private Structure structure;</span>
<span class="source-line-no">125</span><span id="line-125">    private Chain currentChain;</span>
<span class="source-line-no">126</span><span id="line-126">    private Group currentGroup;</span>
<span class="source-line-no">127</span><span id="line-127">    private List&lt;List&lt;Chain&gt;&gt; allModels;</span>
<span class="source-line-no">128</span><span id="line-128">    private List&lt;Chain&gt; currentModel;</span>
<span class="source-line-no">129</span><span id="line-129">    private PDBHeader pdbHeader;</span>
<span class="source-line-no">130</span><span id="line-130">    private String currentNmrModelNumber;</span>
<span class="source-line-no">131</span><span id="line-131">        private Em3dReconstruction em3dReconstruction;</span>
<span class="source-line-no">132</span><span id="line-132">    private List&lt;Chain&gt; entityChains;</span>
<span class="source-line-no">133</span><span id="line-133"></span>
<span class="source-line-no">134</span><span id="line-134">    private Entity entity;</span>
<span class="source-line-no">135</span><span id="line-135">    private EntityPoly entityPoly;</span>
<span class="source-line-no">136</span><span id="line-136">    private EntitySrcGen entitySrcGen;</span>
<span class="source-line-no">137</span><span id="line-137">    private EntitySrcNat entitySrcNat;</span>
<span class="source-line-no">138</span><span id="line-138">    private PdbxEntitySrcSyn entitySrcSyn;</span>
<span class="source-line-no">139</span><span id="line-139">    private List&lt;Chain&gt; seqResChains;</span>
<span class="source-line-no">140</span><span id="line-140">    private PdbxStructAssembly structAssembly;</span>
<span class="source-line-no">141</span><span id="line-141">    private PdbxStructAssemblyGen structAssemblyGen;</span>
<span class="source-line-no">142</span><span id="line-142">    private StructAsym structAsym;</span>
<span class="source-line-no">143</span><span id="line-143">    private StructConn structConn;</span>
<span class="source-line-no">144</span><span id="line-144">    private StructNcsOper structNcsOper;</span>
<span class="source-line-no">145</span><span id="line-145">    private PdbxStructOperList structOpers;</span>
<span class="source-line-no">146</span><span id="line-146">    private StructRef structRef;</span>
<span class="source-line-no">147</span><span id="line-147">    private StructRefSeqDif structRefSeqDif;</span>
<span class="source-line-no">148</span><span id="line-148">    private StructSiteGen structSiteGen;</span>
<span class="source-line-no">149</span><span id="line-149"></span>
<span class="source-line-no">150</span><span id="line-150">    private Map&lt;String, String&gt; asymId2entityId;</span>
<span class="source-line-no">151</span><span id="line-151">    private Map&lt;String, String&gt; asymId2authorId;</span>
<span class="source-line-no">152</span><span id="line-152">    private Matrix4d parsedScaleMatrix;</span>
<span class="source-line-no">153</span><span id="line-153"></span>
<span class="source-line-no">154</span><span id="line-154">    private final FileParsingParameters params;</span>
<span class="source-line-no">155</span><span id="line-155"></span>
<span class="source-line-no">156</span><span id="line-156">    public CifStructureConsumerImpl(FileParsingParameters params) {</span>
<span class="source-line-no">157</span><span id="line-157">        this.params = params;</span>
<span class="source-line-no">158</span><span id="line-158">    }</span>
<span class="source-line-no">159</span><span id="line-159"></span>
<span class="source-line-no">160</span><span id="line-160">    @Override</span>
<span class="source-line-no">161</span><span id="line-161">    public void prepare() {</span>
<span class="source-line-no">162</span><span id="line-162">        this.structure = new StructureImpl();</span>
<span class="source-line-no">163</span><span id="line-163">        this.pdbHeader = new PDBHeader();</span>
<span class="source-line-no">164</span><span id="line-164">        structure.setPDBHeader(pdbHeader);</span>
<span class="source-line-no">165</span><span id="line-165"></span>
<span class="source-line-no">166</span><span id="line-166">        this.allModels = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">167</span><span id="line-167">        this.currentModel = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">168</span><span id="line-168"></span>
<span class="source-line-no">169</span><span id="line-169">        this.seqResChains  = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">170</span><span id="line-170">        this.asymId2entityId = new HashMap&lt;&gt;();</span>
<span class="source-line-no">171</span><span id="line-171">        this.asymId2authorId = new HashMap&lt;&gt;();</span>
<span class="source-line-no">172</span><span id="line-172"></span>
<span class="source-line-no">173</span><span id="line-173">        this.entityChains = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">174</span><span id="line-174">    }</span>
<span class="source-line-no">175</span><span id="line-175"></span>
<span class="source-line-no">176</span><span id="line-176">    @Override</span>
<span class="source-line-no">177</span><span id="line-177">    public void consumeAtomSite(AtomSite atomSite) {</span>
<span class="source-line-no">178</span><span id="line-178">        if (params.isHeaderOnly()) {</span>
<span class="source-line-no">179</span><span id="line-179">            return;</span>
<span class="source-line-no">180</span><span id="line-180">        }</span>
<span class="source-line-no">181</span><span id="line-181"></span>
<span class="source-line-no">182</span><span id="line-182">        StrColumn labelAsymId = atomSite.getLabelAsymId();</span>
<span class="source-line-no">183</span><span id="line-183">        StrColumn authAsymId = atomSite.getAuthAsymId();</span>
<span class="source-line-no">184</span><span id="line-184"></span>
<span class="source-line-no">185</span><span id="line-185">        StrColumn groupPDB = atomSite.getGroupPDB();</span>
<span class="source-line-no">186</span><span id="line-186">        IntColumn authSeqId = atomSite.getAuthSeqId();</span>
<span class="source-line-no">187</span><span id="line-187"></span>
<span class="source-line-no">188</span><span id="line-188">        StrColumn labelCompId = atomSite.getLabelCompId();</span>
<span class="source-line-no">189</span><span id="line-189"></span>
<span class="source-line-no">190</span><span id="line-190">        IntColumn id = atomSite.getId();</span>
<span class="source-line-no">191</span><span id="line-191">        StrColumn labelAtomId = atomSite.getLabelAtomId();</span>
<span class="source-line-no">192</span><span id="line-192"></span>
<span class="source-line-no">193</span><span id="line-193">        FloatColumn cartnX = atomSite.getCartnX();</span>
<span class="source-line-no">194</span><span id="line-194">        FloatColumn cartnY = atomSite.getCartnY();</span>
<span class="source-line-no">195</span><span id="line-195">        FloatColumn cartnZ = atomSite.getCartnZ();</span>
<span class="source-line-no">196</span><span id="line-196"></span>
<span class="source-line-no">197</span><span id="line-197">        FloatColumn occupancy = atomSite.getOccupancy();</span>
<span class="source-line-no">198</span><span id="line-198">        FloatColumn bIsoOrEquiv = atomSite.getBIsoOrEquiv();</span>
<span class="source-line-no">199</span><span id="line-199"></span>
<span class="source-line-no">200</span><span id="line-200">        StrColumn labelAltId = atomSite.getLabelAltId();</span>
<span class="source-line-no">201</span><span id="line-201">        StrColumn typeSymbol = atomSite.getTypeSymbol();</span>
<span class="source-line-no">202</span><span id="line-202"></span>
<span class="source-line-no">203</span><span id="line-203">        StrColumn pdbxPDBInsCode = atomSite.getPdbxPDBInsCode();</span>
<span class="source-line-no">204</span><span id="line-204">        IntColumn labelSeqId = atomSite.getLabelSeqId();</span>
<span class="source-line-no">205</span><span id="line-205">        IntColumn pdbx_pdb_model_num = atomSite.getPdbxPDBModelNum();</span>
<span class="source-line-no">206</span><span id="line-206"></span>
<span class="source-line-no">207</span><span id="line-207">        for (int atomIndex = 0; atomIndex &lt; atomSite.getRowCount(); atomIndex++) {</span>
<span class="source-line-no">208</span><span id="line-208">            boolean startOfNewChain = false;</span>
<span class="source-line-no">209</span><span id="line-209">            Character oneLetterCode = StructureTools.get1LetterCodeAmino(labelCompId.get(atomIndex));</span>
<span class="source-line-no">210</span><span id="line-210"></span>
<span class="source-line-no">211</span><span id="line-211">            boolean isHetAtmInFile = false;</span>
<span class="source-line-no">212</span><span id="line-212">            if (!"ATOM".equals(groupPDB.get(atomIndex))) {</span>
<span class="source-line-no">213</span><span id="line-213">                if (oneLetterCode != null &amp;&amp; oneLetterCode.equals(StructureTools.UNKNOWN_GROUP_LABEL)) {</span>
<span class="source-line-no">214</span><span id="line-214">                    oneLetterCode = null;</span>
<span class="source-line-no">215</span><span id="line-215">                }</span>
<span class="source-line-no">216</span><span id="line-216"></span>
<span class="source-line-no">217</span><span id="line-217">                isHetAtmInFile = true;</span>
<span class="source-line-no">218</span><span id="line-218">            }</span>
<span class="source-line-no">219</span><span id="line-219"></span>
<span class="source-line-no">220</span><span id="line-220">            String insCodeString = pdbxPDBInsCode.isDefined()? pdbxPDBInsCode.get(atomIndex) : null;</span>
<span class="source-line-no">221</span><span id="line-221"></span>
<span class="source-line-no">222</span><span id="line-222">            Character insCode = null;</span>
<span class="source-line-no">223</span><span id="line-223">            if (insCodeString != null &amp;&amp; !insCodeString.isEmpty() &amp;&amp; !"?".equals(insCodeString)) {</span>
<span class="source-line-no">224</span><span id="line-224">                insCode = insCodeString.charAt(0);</span>
<span class="source-line-no">225</span><span id="line-225">            }</span>
<span class="source-line-no">226</span><span id="line-226"></span>
<span class="source-line-no">227</span><span id="line-227">            // non polymer chains (ligands and small molecules) will have a label_seq_id set to '.'</span>
<span class="source-line-no">228</span><span id="line-228">            long seqId = labelSeqId.get(atomIndex);</span>
<span class="source-line-no">229</span><span id="line-229"></span>
<span class="source-line-no">230</span><span id="line-230">            String nmrModelNumber = pdbx_pdb_model_num.getStringData(atomIndex);</span>
<span class="source-line-no">231</span><span id="line-231"></span>
<span class="source-line-no">232</span><span id="line-232">            if (currentNmrModelNumber == null) {</span>
<span class="source-line-no">233</span><span id="line-233">                currentNmrModelNumber = nmrModelNumber;</span>
<span class="source-line-no">234</span><span id="line-234">            }</span>
<span class="source-line-no">235</span><span id="line-235">            if (!currentNmrModelNumber.equals(nmrModelNumber)) {</span>
<span class="source-line-no">236</span><span id="line-236">                currentNmrModelNumber = nmrModelNumber;</span>
<span class="source-line-no">237</span><span id="line-237"></span>
<span class="source-line-no">238</span><span id="line-238">                if (currentChain != null) {</span>
<span class="source-line-no">239</span><span id="line-239">                    currentChain.addGroup(currentGroup);</span>
<span class="source-line-no">240</span><span id="line-240">                    currentGroup.trimToSize();</span>
<span class="source-line-no">241</span><span id="line-241">                }</span>
<span class="source-line-no">242</span><span id="line-242"></span>
<span class="source-line-no">243</span><span id="line-243">                allModels.add(currentModel);</span>
<span class="source-line-no">244</span><span id="line-244">                currentModel = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">245</span><span id="line-245">                currentChain = null;</span>
<span class="source-line-no">246</span><span id="line-246">                currentGroup = null;</span>
<span class="source-line-no">247</span><span id="line-247">            }</span>
<span class="source-line-no">248</span><span id="line-248"></span>
<span class="source-line-no">249</span><span id="line-249">            String asymId = labelAsymId.get(atomIndex);</span>
<span class="source-line-no">250</span><span id="line-250">            String authId = authAsymId.isDefined()? authAsymId.get(atomIndex) : asymId;</span>
<span class="source-line-no">251</span><span id="line-251"></span>
<span class="source-line-no">252</span><span id="line-252">            if (currentChain == null) {</span>
<span class="source-line-no">253</span><span id="line-253">                currentChain = new ChainImpl();</span>
<span class="source-line-no">254</span><span id="line-254">                currentChain.setName(authId);</span>
<span class="source-line-no">255</span><span id="line-255">                currentChain.setId(asymId);</span>
<span class="source-line-no">256</span><span id="line-256">                currentModel.add(currentChain);</span>
<span class="source-line-no">257</span><span id="line-257">                startOfNewChain = true;</span>
<span class="source-line-no">258</span><span id="line-258">            }</span>
<span class="source-line-no">259</span><span id="line-259"></span>
<span class="source-line-no">260</span><span id="line-260">            if (!asymId.equals(currentChain.getId())) {</span>
<span class="source-line-no">261</span><span id="line-261">                startOfNewChain = true;</span>
<span class="source-line-no">262</span><span id="line-262"></span>
<span class="source-line-no">263</span><span id="line-263">                currentChain.addGroup(currentGroup);</span>
<span class="source-line-no">264</span><span id="line-264"></span>
<span class="source-line-no">265</span><span id="line-265">                Optional&lt;Chain&gt; testChain = currentModel.stream()</span>
<span class="source-line-no">266</span><span id="line-266">                        .filter(chain -&gt; chain.getId().equals(asymId))</span>
<span class="source-line-no">267</span><span id="line-267">                        .findFirst();</span>
<span class="source-line-no">268</span><span id="line-268"></span>
<span class="source-line-no">269</span><span id="line-269">                if (testChain.isPresent()) {</span>
<span class="source-line-no">270</span><span id="line-270">                    currentChain = testChain.get();</span>
<span class="source-line-no">271</span><span id="line-271">                } else {</span>
<span class="source-line-no">272</span><span id="line-272">                    currentChain = new ChainImpl();</span>
<span class="source-line-no">273</span><span id="line-273">                    currentChain.setName(authId);</span>
<span class="source-line-no">274</span><span id="line-274">                    currentChain.setId(asymId);</span>
<span class="source-line-no">275</span><span id="line-275">                }</span>
<span class="source-line-no">276</span><span id="line-276"></span>
<span class="source-line-no">277</span><span id="line-277">                if (!currentModel.contains(currentChain)) {</span>
<span class="source-line-no">278</span><span id="line-278">                    currentModel.add(currentChain);</span>
<span class="source-line-no">279</span><span id="line-279">                }</span>
<span class="source-line-no">280</span><span id="line-280">            }</span>
<span class="source-line-no">281</span><span id="line-281"></span>
<span class="source-line-no">282</span><span id="line-282">            int authSeqIdInt = authSeqId.isDefined()? authSeqId.get(atomIndex) : (int)seqId;</span>
<span class="source-line-no">283</span><span id="line-283"></span>
<span class="source-line-no">284</span><span id="line-284">            ResidueNumber residueNumber = new ResidueNumber(authId, authSeqIdInt, insCode);</span>
<span class="source-line-no">285</span><span id="line-285"></span>
<span class="source-line-no">286</span><span id="line-286">            String recordName = groupPDB.get(atomIndex);</span>
<span class="source-line-no">287</span><span id="line-287">            String compId = labelCompId.get(atomIndex);</span>
<span class="source-line-no">288</span><span id="line-288">            if (currentGroup == null) {</span>
<span class="source-line-no">289</span><span id="line-289">                currentGroup = createGroup(recordName, oneLetterCode, compId, seqId);</span>
<span class="source-line-no">290</span><span id="line-290">                currentGroup.setResidueNumber(residueNumber);</span>
<span class="source-line-no">291</span><span id="line-291">                currentGroup.setPDBName(compId);</span>
<span class="source-line-no">292</span><span id="line-292">                currentGroup.setHetAtomInFile(isHetAtmInFile);</span>
<span class="source-line-no">293</span><span id="line-293">            }</span>
<span class="source-line-no">294</span><span id="line-294"></span>
<span class="source-line-no">295</span><span id="line-295">            Group altGroup = null;</span>
<span class="source-line-no">296</span><span id="line-296">            String altLocation = labelAltId.isDefined()? labelAltId.get(atomIndex) : null;</span>
<span class="source-line-no">297</span><span id="line-297"></span>
<span class="source-line-no">298</span><span id="line-298">            if (startOfNewChain) {</span>
<span class="source-line-no">299</span><span id="line-299">                currentGroup = createGroup(recordName, oneLetterCode, compId, seqId);</span>
<span class="source-line-no">300</span><span id="line-300">                currentGroup.setResidueNumber(residueNumber);</span>
<span class="source-line-no">301</span><span id="line-301">                currentGroup.setPDBName(compId);</span>
<span class="source-line-no">302</span><span id="line-302">                currentGroup.setHetAtomInFile(isHetAtmInFile);</span>
<span class="source-line-no">303</span><span id="line-303">            } else {</span>
<span class="source-line-no">304</span><span id="line-304">                if (!residueNumber.equals(currentGroup.getResidueNumber())) {</span>
<span class="source-line-no">305</span><span id="line-305">                    currentChain.addGroup(currentGroup);</span>
<span class="source-line-no">306</span><span id="line-306">                    currentGroup.trimToSize();</span>
<span class="source-line-no">307</span><span id="line-307">                    currentGroup = createGroup(recordName, oneLetterCode, compId, seqId);</span>
<span class="source-line-no">308</span><span id="line-308">                    currentGroup.setPDBName(compId);</span>
<span class="source-line-no">309</span><span id="line-309">                    currentGroup.setResidueNumber(residueNumber);</span>
<span class="source-line-no">310</span><span id="line-310">                    currentGroup.setHetAtomInFile(isHetAtmInFile);</span>
<span class="source-line-no">311</span><span id="line-311">                } else {</span>
<span class="source-line-no">312</span><span id="line-312">                    if (altLocation != null &amp;&amp; !altLocation.isEmpty() &amp;&amp; !".".equals(altLocation)) {</span>
<span class="source-line-no">313</span><span id="line-313">                        altGroup = getAltLocGroup(recordName, altLocation.charAt(0), oneLetterCode, compId, seqId);</span>
<span class="source-line-no">314</span><span id="line-314">                        if (altGroup.getChain() == null) {</span>
<span class="source-line-no">315</span><span id="line-315">                            altGroup.setChain(currentChain);</span>
<span class="source-line-no">316</span><span id="line-316">                        }</span>
<span class="source-line-no">317</span><span id="line-317">                    }</span>
<span class="source-line-no">318</span><span id="line-318">                }</span>
<span class="source-line-no">319</span><span id="line-319">            }</span>
<span class="source-line-no">320</span><span id="line-320"></span>
<span class="source-line-no">321</span><span id="line-321">            if (params.isParseCAOnly()) {</span>
<span class="source-line-no">322</span><span id="line-322">                if (!labelAtomId.get(atomIndex).equals(StructureTools.CA_ATOM_NAME) &amp;&amp; "C".equals(typeSymbol.get(atomIndex))) {</span>
<span class="source-line-no">323</span><span id="line-323">                    continue;</span>
<span class="source-line-no">324</span><span id="line-324">                }</span>
<span class="source-line-no">325</span><span id="line-325">            }</span>
<span class="source-line-no">326</span><span id="line-326"></span>
<span class="source-line-no">327</span><span id="line-327">            Atom atom = new AtomImpl();</span>
<span class="source-line-no">328</span><span id="line-328"></span>
<span class="source-line-no">329</span><span id="line-329">            atom.setPDBserial(id.get(atomIndex));</span>
<span class="source-line-no">330</span><span id="line-330">            atom.setName(labelAtomId.get(atomIndex));</span>
<span class="source-line-no">331</span><span id="line-331"></span>
<span class="source-line-no">332</span><span id="line-332">            atom.setX(cartnX.get(atomIndex));</span>
<span class="source-line-no">333</span><span id="line-333">            atom.setY(cartnY.get(atomIndex));</span>
<span class="source-line-no">334</span><span id="line-334">            atom.setZ(cartnZ.get(atomIndex));</span>
<span class="source-line-no">335</span><span id="line-335"></span>
<span class="source-line-no">336</span><span id="line-336">            atom.setOccupancy((float) occupancy.get(atomIndex));</span>
<span class="source-line-no">337</span><span id="line-337">            atom.setTempFactor((float) bIsoOrEquiv.get(atomIndex));</span>
<span class="source-line-no">338</span><span id="line-338"></span>
<span class="source-line-no">339</span><span id="line-339">            if (altLocation == null || altLocation.isEmpty() || ".".equals(altLocation)) {</span>
<span class="source-line-no">340</span><span id="line-340">                atom.setAltLoc(' ');</span>
<span class="source-line-no">341</span><span id="line-341">            } else {</span>
<span class="source-line-no">342</span><span id="line-342">                atom.setAltLoc(altLocation.charAt(0));</span>
<span class="source-line-no">343</span><span id="line-343">            }</span>
<span class="source-line-no">344</span><span id="line-344"></span>
<span class="source-line-no">345</span><span id="line-345">            String ts = typeSymbol.get(atomIndex);</span>
<span class="source-line-no">346</span><span id="line-346">            try {</span>
<span class="source-line-no">347</span><span id="line-347">                Element element = Element.valueOfIgnoreCase(ts);</span>
<span class="source-line-no">348</span><span id="line-348">                atom.setElement(element);</span>
<span class="source-line-no">349</span><span id="line-349">            }  catch (IllegalArgumentException e) {</span>
<span class="source-line-no">350</span><span id="line-350">                logger.info("Element {} was not recognised as a BioJava-known element, the element will be " +</span>
<span class="source-line-no">351</span><span id="line-351">                        "represented as the generic element {}", ts, Element.R.name());</span>
<span class="source-line-no">352</span><span id="line-352">                atom.setElement(Element.R);</span>
<span class="source-line-no">353</span><span id="line-353">            }</span>
<span class="source-line-no">354</span><span id="line-354"></span>
<span class="source-line-no">355</span><span id="line-355">            if (altGroup != null) {</span>
<span class="source-line-no">356</span><span id="line-356">                altGroup.addAtom(atom);</span>
<span class="source-line-no">357</span><span id="line-357">            } else {</span>
<span class="source-line-no">358</span><span id="line-358">                currentGroup.addAtom(atom);</span>
<span class="source-line-no">359</span><span id="line-359">            }</span>
<span class="source-line-no">360</span><span id="line-360"></span>
<span class="source-line-no">361</span><span id="line-361">            String atomName = atom.getName();</span>
<span class="source-line-no">362</span><span id="line-362">            if (!currentGroup.hasAtom(atomName)) {</span>
<span class="source-line-no">363</span><span id="line-363">                if (currentGroup.getPDBName().equals(atom.getGroup().getPDBName())) {</span>
<span class="source-line-no">364</span><span id="line-364">                    if (!StructureTools.hasNonDeuteratedEquiv(atom, currentGroup)) {</span>
<span class="source-line-no">365</span><span id="line-365">                        currentGroup.addAtom(atom);</span>
<span class="source-line-no">366</span><span id="line-366">                    }</span>
<span class="source-line-no">367</span><span id="line-367">                }</span>
<span class="source-line-no">368</span><span id="line-368">            }</span>
<span class="source-line-no">369</span><span id="line-369">        }</span>
<span class="source-line-no">370</span><span id="line-370">    }</span>
<span class="source-line-no">371</span><span id="line-371"></span>
<span class="source-line-no">372</span><span id="line-372">    private Group getAltLocGroup(String recordName, Character altLoc, Character oneLetterCode, String threeLetterCode,</span>
<span class="source-line-no">373</span><span id="line-373">                                 long seqId) {</span>
<span class="source-line-no">374</span><span id="line-374">        List&lt;Atom&gt; atoms = currentGroup.getAtoms();</span>
<span class="source-line-no">375</span><span id="line-375">        if (atoms.size() &gt; 0) {</span>
<span class="source-line-no">376</span><span id="line-376">            if (atoms.get(0).getAltLoc().equals(altLoc)) {</span>
<span class="source-line-no">377</span><span id="line-377">                return currentGroup;</span>
<span class="source-line-no">378</span><span id="line-378">            }</span>
<span class="source-line-no">379</span><span id="line-379">        }</span>
<span class="source-line-no">380</span><span id="line-380"></span>
<span class="source-line-no">381</span><span id="line-381">        List&lt;Group&gt; altLocs = currentGroup.getAltLocs();</span>
<span class="source-line-no">382</span><span id="line-382">        for (Group altLocGroup : altLocs) {</span>
<span class="source-line-no">383</span><span id="line-383">            atoms = altLocGroup.getAtoms();</span>
<span class="source-line-no">384</span><span id="line-384">            if (atoms.size() &gt; 0) {</span>
<span class="source-line-no">385</span><span id="line-385">                for (Atom a1 : atoms) {</span>
<span class="source-line-no">386</span><span id="line-386">                    if (a1.getAltLoc().equals(altLoc)) {</span>
<span class="source-line-no">387</span><span id="line-387">                        return altLocGroup;</span>
<span class="source-line-no">388</span><span id="line-388">                    }</span>
<span class="source-line-no">389</span><span id="line-389">                }</span>
<span class="source-line-no">390</span><span id="line-390">            }</span>
<span class="source-line-no">391</span><span id="line-391">        }</span>
<span class="source-line-no">392</span><span id="line-392"></span>
<span class="source-line-no">393</span><span id="line-393">        if (threeLetterCode.equals(currentGroup.getPDBName())) {</span>
<span class="source-line-no">394</span><span id="line-394">            if (currentGroup.getAtoms().isEmpty()) {</span>
<span class="source-line-no">395</span><span id="line-395">                return currentGroup;</span>
<span class="source-line-no">396</span><span id="line-396">            }</span>
<span class="source-line-no">397</span><span id="line-397"></span>
<span class="source-line-no">398</span><span id="line-398">            Group altLocGroup = (Group) currentGroup.clone();</span>
<span class="source-line-no">399</span><span id="line-399">            altLocGroup.setAtoms(new ArrayList&lt;&gt;());</span>
<span class="source-line-no">400</span><span id="line-400">            altLocGroup.getAltLocs().clear();</span>
<span class="source-line-no">401</span><span id="line-401">            currentGroup.addAltLoc(altLocGroup);</span>
<span class="source-line-no">402</span><span id="line-402">            return altLocGroup;</span>
<span class="source-line-no">403</span><span id="line-403">        }</span>
<span class="source-line-no">404</span><span id="line-404"></span>
<span class="source-line-no">405</span><span id="line-405">        Group altLocGroup = createGroup(recordName, oneLetterCode, threeLetterCode, seqId);</span>
<span class="source-line-no">406</span><span id="line-406">        altLocGroup.setPDBName(threeLetterCode);</span>
<span class="source-line-no">407</span><span id="line-407">        altLocGroup.setResidueNumber(currentGroup.getResidueNumber());</span>
<span class="source-line-no">408</span><span id="line-408">        currentGroup.addAltLoc(altLocGroup);</span>
<span class="source-line-no">409</span><span id="line-409">        return altLocGroup;</span>
<span class="source-line-no">410</span><span id="line-410">    }</span>
<span class="source-line-no">411</span><span id="line-411"></span>
<span class="source-line-no">412</span><span id="line-412">    private Group createGroup(String record, Character oneLetterCode, String threeLetterCode, long seqId) {</span>
<span class="source-line-no">413</span><span id="line-413">        Group group = ChemCompGroupFactory.getGroupFromChemCompDictionary(threeLetterCode);</span>
<span class="source-line-no">414</span><span id="line-414">        if (group != null &amp;&amp; !group.getChemComp().isEmpty()) {</span>
<span class="source-line-no">415</span><span id="line-415">            if (group instanceof AminoAcidImpl) {</span>
<span class="source-line-no">416</span><span id="line-416">                AminoAcidImpl aminoAcid = (AminoAcidImpl) group;</span>
<span class="source-line-no">417</span><span id="line-417">                aminoAcid.setId(seqId);</span>
<span class="source-line-no">418</span><span id="line-418">            } else if (group instanceof NucleotideImpl) {</span>
<span class="source-line-no">419</span><span id="line-419">                NucleotideImpl nucleotide = (NucleotideImpl) group;</span>
<span class="source-line-no">420</span><span id="line-420">                nucleotide.setId(seqId);</span>
<span class="source-line-no">421</span><span id="line-421">            } else if (group instanceof HetatomImpl) {</span>
<span class="source-line-no">422</span><span id="line-422">                HetatomImpl hetatom = (HetatomImpl) group;</span>
<span class="source-line-no">423</span><span id="line-423">                hetatom.setId(seqId);</span>
<span class="source-line-no">424</span><span id="line-424">            }</span>
<span class="source-line-no">425</span><span id="line-425">            return group;</span>
<span class="source-line-no">426</span><span id="line-426">        }</span>
<span class="source-line-no">427</span><span id="line-427"></span>
<span class="source-line-no">428</span><span id="line-428">        if ("ATOM".equals(record)) {</span>
<span class="source-line-no">429</span><span id="line-429">            if (StructureTools.isNucleotide(threeLetterCode)) {</span>
<span class="source-line-no">430</span><span id="line-430">                NucleotideImpl nucleotide = new NucleotideImpl();</span>
<span class="source-line-no">431</span><span id="line-431">                group = nucleotide;</span>
<span class="source-line-no">432</span><span id="line-432">                nucleotide.setId(seqId);</span>
<span class="source-line-no">433</span><span id="line-433">            } else if (oneLetterCode == null || oneLetterCode == StructureTools.UNKNOWN_GROUP_LABEL) {</span>
<span class="source-line-no">434</span><span id="line-434">                HetatomImpl hetatom = new HetatomImpl();</span>
<span class="source-line-no">435</span><span id="line-435">                group = hetatom;</span>
<span class="source-line-no">436</span><span id="line-436">                hetatom.setId(seqId);</span>
<span class="source-line-no">437</span><span id="line-437">            } else {</span>
<span class="source-line-no">438</span><span id="line-438">                AminoAcidImpl aminoAcid = new AminoAcidImpl();</span>
<span class="source-line-no">439</span><span id="line-439">                group = aminoAcid;</span>
<span class="source-line-no">440</span><span id="line-440">                aminoAcid.setAminoType(oneLetterCode);</span>
<span class="source-line-no">441</span><span id="line-441">                aminoAcid.setId(seqId);</span>
<span class="source-line-no">442</span><span id="line-442">            }</span>
<span class="source-line-no">443</span><span id="line-443">        } else {</span>
<span class="source-line-no">444</span><span id="line-444">            if (StructureTools.isNucleotide(threeLetterCode)) {</span>
<span class="source-line-no">445</span><span id="line-445">                NucleotideImpl nucleotide = new NucleotideImpl();</span>
<span class="source-line-no">446</span><span id="line-446">                group = nucleotide;</span>
<span class="source-line-no">447</span><span id="line-447">                nucleotide.setId(seqId);</span>
<span class="source-line-no">448</span><span id="line-448">            } else if (oneLetterCode != null) {</span>
<span class="source-line-no">449</span><span id="line-449">                AminoAcidImpl aminoAcid = new AminoAcidImpl();</span>
<span class="source-line-no">450</span><span id="line-450">                group = aminoAcid;</span>
<span class="source-line-no">451</span><span id="line-451">                aminoAcid.setAminoType(oneLetterCode);</span>
<span class="source-line-no">452</span><span id="line-452">                aminoAcid.setId(seqId);</span>
<span class="source-line-no">453</span><span id="line-453">            } else {</span>
<span class="source-line-no">454</span><span id="line-454">                HetatomImpl hetatom = new HetatomImpl();</span>
<span class="source-line-no">455</span><span id="line-455">                hetatom.setId(seqId);</span>
<span class="source-line-no">456</span><span id="line-456">                group = hetatom;</span>
<span class="source-line-no">457</span><span id="line-457">            }</span>
<span class="source-line-no">458</span><span id="line-458">        }</span>
<span class="source-line-no">459</span><span id="line-459">        return group;</span>
<span class="source-line-no">460</span><span id="line-460">    }</span>
<span class="source-line-no">461</span><span id="line-461"></span>
<span class="source-line-no">462</span><span id="line-462">    @Override</span>
<span class="source-line-no">463</span><span id="line-463">    public void consumeAtomSites(AtomSites atomSites) {</span>
<span class="source-line-no">464</span><span id="line-464">        // no atom sites present</span>
<span class="source-line-no">465</span><span id="line-465">        if (!atomSites.isDefined() || atomSites.getRowCount() == 0) {</span>
<span class="source-line-no">466</span><span id="line-466">            return;</span>
<span class="source-line-no">467</span><span id="line-467">        }</span>
<span class="source-line-no">468</span><span id="line-468"></span>
<span class="source-line-no">469</span><span id="line-469">        try {</span>
<span class="source-line-no">470</span><span id="line-470">            parsedScaleMatrix = new Matrix4d(</span>
<span class="source-line-no">471</span><span id="line-471">                    atomSites.getFractTransfMatrix11().get(0),</span>
<span class="source-line-no">472</span><span id="line-472">                    atomSites.getFractTransfMatrix12().get(0),</span>
<span class="source-line-no">473</span><span id="line-473">                    atomSites.getFractTransfMatrix13().get(0),</span>
<span class="source-line-no">474</span><span id="line-474">                    atomSites.getFractTransfVector1().get(0),</span>
<span class="source-line-no">475</span><span id="line-475"></span>
<span class="source-line-no">476</span><span id="line-476">                    atomSites.getFractTransfMatrix21().get(0),</span>
<span class="source-line-no">477</span><span id="line-477">                    atomSites.getFractTransfMatrix22().get(0),</span>
<span class="source-line-no">478</span><span id="line-478">                    atomSites.getFractTransfMatrix23().get(0),</span>
<span class="source-line-no">479</span><span id="line-479">                    atomSites.getFractTransfVector2().get(0),</span>
<span class="source-line-no">480</span><span id="line-480"></span>
<span class="source-line-no">481</span><span id="line-481">                    atomSites.getFractTransfMatrix31().get(0),</span>
<span class="source-line-no">482</span><span id="line-482">                    atomSites.getFractTransfMatrix32().get(0),</span>
<span class="source-line-no">483</span><span id="line-483">                    atomSites.getFractTransfMatrix33().get(0),</span>
<span class="source-line-no">484</span><span id="line-484">                    atomSites.getFractTransfVector3().get(0),</span>
<span class="source-line-no">485</span><span id="line-485"></span>
<span class="source-line-no">486</span><span id="line-486">                    0,</span>
<span class="source-line-no">487</span><span id="line-487">                    0,</span>
<span class="source-line-no">488</span><span id="line-488">                    0,</span>
<span class="source-line-no">489</span><span id="line-489">                    1</span>
<span class="source-line-no">490</span><span id="line-490">            );</span>
<span class="source-line-no">491</span><span id="line-491">        } catch (NumberFormatException e) {</span>
<span class="source-line-no">492</span><span id="line-492">            logger.warn("Some values in _atom_sites.fract_transf_matrix or _atom_sites.fract_transf_vector could not " +</span>
<span class="source-line-no">493</span><span id="line-493">                    "be parsed as numbers. Can't check whether coordinate frame convention is correct! Error: {}",</span>
<span class="source-line-no">494</span><span id="line-494">                    e.getMessage());</span>
<span class="source-line-no">495</span><span id="line-495">            structure.getPDBHeader().getCrystallographicInfo().setNonStandardCoordFrameConvention(false);</span>
<span class="source-line-no">496</span><span id="line-496">        }</span>
<span class="source-line-no">497</span><span id="line-497">    }</span>
<span class="source-line-no">498</span><span id="line-498"></span>
<span class="source-line-no">499</span><span id="line-499">    @Override</span>
<span class="source-line-no">500</span><span id="line-500">    public void consumeAuditAuthor(AuditAuthor auditAuthor) {</span>
<span class="source-line-no">501</span><span id="line-501">        for (int rowIndex = 0; rowIndex &lt; auditAuthor.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">502</span><span id="line-502">            String name = auditAuthor.getName().get(rowIndex);</span>
<span class="source-line-no">503</span><span id="line-503"></span>
<span class="source-line-no">504</span><span id="line-504">            StringBuilder last = new StringBuilder();</span>
<span class="source-line-no">505</span><span id="line-505">            StringBuilder initials = new StringBuilder();</span>
<span class="source-line-no">506</span><span id="line-506">            boolean afterComma = false;</span>
<span class="source-line-no">507</span><span id="line-507">            for (char c : name.toCharArray()) {</span>
<span class="source-line-no">508</span><span id="line-508">                if (c == ' ') {</span>
<span class="source-line-no">509</span><span id="line-509">                    continue;</span>
<span class="source-line-no">510</span><span id="line-510">                }</span>
<span class="source-line-no">511</span><span id="line-511">                if (c == ',') {</span>
<span class="source-line-no">512</span><span id="line-512">                    afterComma = true;</span>
<span class="source-line-no">513</span><span id="line-513">                    continue;</span>
<span class="source-line-no">514</span><span id="line-514">                }</span>
<span class="source-line-no">515</span><span id="line-515"></span>
<span class="source-line-no">516</span><span id="line-516">                if (afterComma) {</span>
<span class="source-line-no">517</span><span id="line-517">                    initials.append(c);</span>
<span class="source-line-no">518</span><span id="line-518">                } else {</span>
<span class="source-line-no">519</span><span id="line-519">                    last.append(c);</span>
<span class="source-line-no">520</span><span id="line-520">                }</span>
<span class="source-line-no">521</span><span id="line-521">            }</span>
<span class="source-line-no">522</span><span id="line-522"></span>
<span class="source-line-no">523</span><span id="line-523">            StringBuilder newaa = new StringBuilder();</span>
<span class="source-line-no">524</span><span id="line-524">            newaa.append(initials);</span>
<span class="source-line-no">525</span><span id="line-525">            newaa.append(last);</span>
<span class="source-line-no">526</span><span id="line-526"></span>
<span class="source-line-no">527</span><span id="line-527">            String auth = pdbHeader.getAuthors();</span>
<span class="source-line-no">528</span><span id="line-528">            if (auth == null) {</span>
<span class="source-line-no">529</span><span id="line-529">                pdbHeader.setAuthors(newaa.toString());</span>
<span class="source-line-no">530</span><span id="line-530">            } else {</span>
<span class="source-line-no">531</span><span id="line-531">                auth += "," + newaa.toString();</span>
<span class="source-line-no">532</span><span id="line-532">                pdbHeader.setAuthors(auth);</span>
<span class="source-line-no">533</span><span id="line-533">            }</span>
<span class="source-line-no">534</span><span id="line-534">        }</span>
<span class="source-line-no">535</span><span id="line-535">    }</span>
<span class="source-line-no">536</span><span id="line-536"></span>
<span class="source-line-no">537</span><span id="line-537">    @Override</span>
<span class="source-line-no">538</span><span id="line-538">    public void consumeCell(Cell cell) {</span>
<span class="source-line-no">539</span><span id="line-539">        if (!cell.isDefined() || cell.getRowCount() == 0) {</span>
<span class="source-line-no">540</span><span id="line-540">            return;</span>
<span class="source-line-no">541</span><span id="line-541">        }</span>
<span class="source-line-no">542</span><span id="line-542"></span>
<span class="source-line-no">543</span><span id="line-543">        try {</span>
<span class="source-line-no">544</span><span id="line-544">            float a = (float) cell.getLengthA().get(0);</span>
<span class="source-line-no">545</span><span id="line-545">            float b = (float) cell.getLengthB().get(0);</span>
<span class="source-line-no">546</span><span id="line-546">            float c = (float) cell.getLengthC().get(0);</span>
<span class="source-line-no">547</span><span id="line-547">            float alpha = (float) cell.getAngleAlpha().get(0);</span>
<span class="source-line-no">548</span><span id="line-548">            float beta = (float) cell.getAngleBeta().get(0);</span>
<span class="source-line-no">549</span><span id="line-549">            float gamma = (float) cell.getAngleGamma().get(0);</span>
<span class="source-line-no">550</span><span id="line-550"></span>
<span class="source-line-no">551</span><span id="line-551">            CrystalCell crystalCell = new CrystalCell();</span>
<span class="source-line-no">552</span><span id="line-552">            crystalCell.setA(a);</span>
<span class="source-line-no">553</span><span id="line-553">            crystalCell.setB(b);</span>
<span class="source-line-no">554</span><span id="line-554">            crystalCell.setC(c);</span>
<span class="source-line-no">555</span><span id="line-555">            crystalCell.setAlpha(alpha);</span>
<span class="source-line-no">556</span><span id="line-556">            crystalCell.setBeta(beta);</span>
<span class="source-line-no">557</span><span id="line-557">            crystalCell.setGamma(gamma);</span>
<span class="source-line-no">558</span><span id="line-558"></span>
<span class="source-line-no">559</span><span id="line-559">            if (!crystalCell.isCellReasonable()) {</span>
<span class="source-line-no">560</span><span id="line-560">                // If the entry describes a structure determined by a technique other than X-ray crystallography,</span>
<span class="source-line-no">561</span><span id="line-561">                // cell is (sometimes!) a = b = c = 1.0, alpha = beta = gamma = 90 degrees</span>
<span class="source-line-no">562</span><span id="line-562">                // if so we don't add and CrystalCell will be null</span>
<span class="source-line-no">563</span><span id="line-563">                logger.debug("The crystal cell read from file does not have reasonable dimensions (at least one dimension is below {}), discarding it.", CrystalCell.MIN_VALID_CELL_SIZE);</span>
<span class="source-line-no">564</span><span id="line-564">                return;</span>
<span class="source-line-no">565</span><span id="line-565">            }</span>
<span class="source-line-no">566</span><span id="line-566"></span>
<span class="source-line-no">567</span><span id="line-567">            structure.getPDBHeader()</span>
<span class="source-line-no">568</span><span id="line-568">                    .getCrystallographicInfo()</span>
<span class="source-line-no">569</span><span id="line-569">                    .setCrystalCell(crystalCell);</span>
<span class="source-line-no">570</span><span id="line-570"></span>
<span class="source-line-no">571</span><span id="line-571">        } catch (NumberFormatException e){</span>
<span class="source-line-no">572</span><span id="line-572">            structure.getPDBHeader()</span>
<span class="source-line-no">573</span><span id="line-573">                    .getCrystallographicInfo()</span>
<span class="source-line-no">574</span><span id="line-574">                    .setCrystalCell(null);</span>
<span class="source-line-no">575</span><span id="line-575">            logger.info("could not parse some cell parameters ({}), ignoring _cell", e.getMessage());</span>
<span class="source-line-no">576</span><span id="line-576">        }</span>
<span class="source-line-no">577</span><span id="line-577">    }</span>
<span class="source-line-no">578</span><span id="line-578"></span>
<span class="source-line-no">579</span><span id="line-579">    @Override</span>
<span class="source-line-no">580</span><span id="line-580">    public void consumeChemComp(ChemComp chemComp) {</span>
<span class="source-line-no">581</span><span id="line-581">        // TODO not impled in ref</span>
<span class="source-line-no">582</span><span id="line-582">    }</span>
<span class="source-line-no">583</span><span id="line-583"></span>
<span class="source-line-no">584</span><span id="line-584">    @Override</span>
<span class="source-line-no">585</span><span id="line-585">    public void consumeChemCompBond(ChemCompBond chemCompBond) {</span>
<span class="source-line-no">586</span><span id="line-586">        // TODO not impled in ref</span>
<span class="source-line-no">587</span><span id="line-587">    }</span>
<span class="source-line-no">588</span><span id="line-588"></span>
<span class="source-line-no">589</span><span id="line-589">    @Override</span>
<span class="source-line-no">590</span><span id="line-590">    public void consumeDatabasePDBRemark(DatabasePDBRemark databasePDBremark) {</span>
<span class="source-line-no">591</span><span id="line-591">        for (int rowIndex = 0; rowIndex &lt; databasePDBremark.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">592</span><span id="line-592">            int id = databasePDBremark.getId().get(rowIndex);</span>
<span class="source-line-no">593</span><span id="line-593">            if (id == 2) {</span>
<span class="source-line-no">594</span><span id="line-594">                String line = databasePDBremark.getText().get(rowIndex);</span>
<span class="source-line-no">595</span><span id="line-595">                int i = line.indexOf("ANGSTROM");</span>
<span class="source-line-no">596</span><span id="line-596"></span>
<span class="source-line-no">597</span><span id="line-597">                if (i &gt; 5) {</span>
<span class="source-line-no">598</span><span id="line-598">                    // line contains ANGSTROM info...</span>
<span class="source-line-no">599</span><span id="line-599">                    String resolution = line.substring(i - 5, i).trim();</span>
<span class="source-line-no">600</span><span id="line-600">                    // convert string to float</span>
<span class="source-line-no">601</span><span id="line-601">                    try {</span>
<span class="source-line-no">602</span><span id="line-602">                        float res = Float.parseFloat(resolution);</span>
<span class="source-line-no">603</span><span id="line-603">                        pdbHeader.setResolution(res);</span>
<span class="source-line-no">604</span><span id="line-604">                    } catch (NumberFormatException e) {</span>
<span class="source-line-no">605</span><span id="line-605">                        logger.info("could not parse resolution from line and ignoring it {}", line);</span>
<span class="source-line-no">606</span><span id="line-606">                        return;</span>
<span class="source-line-no">607</span><span id="line-607">                    }</span>
<span class="source-line-no">608</span><span id="line-608">                }</span>
<span class="source-line-no">609</span><span id="line-609">            }</span>
<span class="source-line-no">610</span><span id="line-610">        }</span>
<span class="source-line-no">611</span><span id="line-611">    }</span>
<span class="source-line-no">612</span><span id="line-612"></span>
<span class="source-line-no">613</span><span id="line-613">    private Date convert(LocalDate localDate) {</span>
<span class="source-line-no">614</span><span id="line-614">        return Date.from(localDate.atStartOfDay().atZone(ZoneId.systemDefault()).toInstant());</span>
<span class="source-line-no">615</span><span id="line-615">    }</span>
<span class="source-line-no">616</span><span id="line-616"></span>
<span class="source-line-no">617</span><span id="line-617">    @Override</span>
<span class="source-line-no">618</span><span id="line-618">    public void consumeDatabasePDBRev(DatabasePDBRev databasePDBrev) {</span>
<span class="source-line-no">619</span><span id="line-619">        logger.debug("got a database revision:{}", databasePDBrev);</span>
<span class="source-line-no">620</span><span id="line-620"></span>
<span class="source-line-no">621</span><span id="line-621">        Date modDate = null;</span>
<span class="source-line-no">622</span><span id="line-622">        for (int rowIndex = 0; rowIndex &lt; databasePDBrev.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">623</span><span id="line-623">            if (databasePDBrev.getNum().get(rowIndex) == 1) {</span>
<span class="source-line-no">624</span><span id="line-624">                String dateOriginal = databasePDBrev.getDateOriginal().get(rowIndex);</span>
<span class="source-line-no">625</span><span id="line-625">                pdbHeader.setDepDate(convert(LocalDate.parse(dateOriginal, DATE_FORMAT)));</span>
<span class="source-line-no">626</span><span id="line-626"></span>
<span class="source-line-no">627</span><span id="line-627">                String date = databasePDBrev.getDate().get(rowIndex);</span>
<span class="source-line-no">628</span><span id="line-628">                final Date relDate = convert(LocalDate.parse(date, DATE_FORMAT));</span>
<span class="source-line-no">629</span><span id="line-629">                pdbHeader.setRelDate(relDate);</span>
<span class="source-line-no">630</span><span id="line-630">                modDate = relDate;</span>
<span class="source-line-no">631</span><span id="line-631">            } else {</span>
<span class="source-line-no">632</span><span id="line-632">                String dbrev = databasePDBrev.getDate().get(rowIndex);</span>
<span class="source-line-no">633</span><span id="line-633">                modDate = convert(LocalDate.parse(dbrev, DATE_FORMAT));</span>
<span class="source-line-no">634</span><span id="line-634">            }</span>
<span class="source-line-no">635</span><span id="line-635">            pdbHeader.setModDate(modDate);</span>
<span class="source-line-no">636</span><span id="line-636">        }</span>
<span class="source-line-no">637</span><span id="line-637">    }</span>
<span class="source-line-no">638</span><span id="line-638"></span>
<span class="source-line-no">639</span><span id="line-639">    @Override</span>
<span class="source-line-no">640</span><span id="line-640">    public void consumeDatabasePDBRevRecord(DatabasePDBRevRecord databasePDBrevRecord) {</span>
<span class="source-line-no">641</span><span id="line-641">        List&lt;org.biojava.nbio.structure.DatabasePDBRevRecord&gt; revRecords = pdbHeader.getRevisionRecords();</span>
<span class="source-line-no">642</span><span id="line-642">        if (revRecords == null) {</span>
<span class="source-line-no">643</span><span id="line-643">            revRecords = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">644</span><span id="line-644">            pdbHeader.setRevisionRecords(revRecords);</span>
<span class="source-line-no">645</span><span id="line-645">        }</span>
<span class="source-line-no">646</span><span id="line-646"></span>
<span class="source-line-no">647</span><span id="line-647">        for (int i = 0; i &lt; databasePDBrevRecord.getRowCount(); i++) {</span>
<span class="source-line-no">648</span><span id="line-648">            revRecords.add(new org.biojava.nbio.structure.DatabasePDBRevRecord(databasePDBrevRecord, i));</span>
<span class="source-line-no">649</span><span id="line-649">        }</span>
<span class="source-line-no">650</span><span id="line-650">    }</span>
<span class="source-line-no">651</span><span id="line-651"></span>
<span class="source-line-no">652</span><span id="line-652">    @Override</span>
<span class="source-line-no">653</span><span id="line-653">    public void consumeEm3dReconstruction(Em3dReconstruction em3dReconstruction) {</span>
<span class="source-line-no">654</span><span id="line-654">        this.em3dReconstruction = em3dReconstruction;</span>
<span class="source-line-no">655</span><span id="line-655"></span>
<span class="source-line-no">656</span><span id="line-656">        for (int rowIndex = 0; rowIndex &lt; em3dReconstruction.getRowCount(); rowIndex++) { //can it have more than 1 value?</span>
<span class="source-line-no">657</span><span id="line-657">                final FloatColumn resolution = em3dReconstruction.getResolution();</span>
<span class="source-line-no">658</span><span id="line-658">                        if (ValueKind.PRESENT.equals(resolution.getValueKind(rowIndex)))</span>
<span class="source-line-no">659</span><span id="line-659">                        pdbHeader.setResolution((float) resolution.get(rowIndex));</span>
<span class="source-line-no">660</span><span id="line-660">        }</span>
<span class="source-line-no">661</span><span id="line-661">        //TODO other fields (maybe RFree)?</span>
<span class="source-line-no">662</span><span id="line-662">    }</span>
<span class="source-line-no">663</span><span id="line-663"></span>
<span class="source-line-no">664</span><span id="line-664">    @Override</span>
<span class="source-line-no">665</span><span id="line-665">    public void consumeEntity(Entity entity) {</span>
<span class="source-line-no">666</span><span id="line-666">        this.entity = entity;</span>
<span class="source-line-no">667</span><span id="line-667">    }</span>
<span class="source-line-no">668</span><span id="line-668"></span>
<span class="source-line-no">669</span><span id="line-669">    @Override</span>
<span class="source-line-no">670</span><span id="line-670">    public void consumeEntityPoly(EntityPoly entityPoly) {</span>
<span class="source-line-no">671</span><span id="line-671">        this.entityPoly = entityPoly;</span>
<span class="source-line-no">672</span><span id="line-672">    }</span>
<span class="source-line-no">673</span><span id="line-673"></span>
<span class="source-line-no">674</span><span id="line-674">    @Override</span>
<span class="source-line-no">675</span><span id="line-675">    public void consumeEntitySrcGen(EntitySrcGen entitySrcGen) {</span>
<span class="source-line-no">676</span><span id="line-676">        this.entitySrcGen = entitySrcGen;</span>
<span class="source-line-no">677</span><span id="line-677">    }</span>
<span class="source-line-no">678</span><span id="line-678"></span>
<span class="source-line-no">679</span><span id="line-679">    @Override</span>
<span class="source-line-no">680</span><span id="line-680">    public void consumeEntitySrcNat(EntitySrcNat entitySrcNat) {</span>
<span class="source-line-no">681</span><span id="line-681">        this.entitySrcNat = entitySrcNat;</span>
<span class="source-line-no">682</span><span id="line-682">    }</span>
<span class="source-line-no">683</span><span id="line-683"></span>
<span class="source-line-no">684</span><span id="line-684">    @Override</span>
<span class="source-line-no">685</span><span id="line-685">    public void consumeEntitySrcSyn(PdbxEntitySrcSyn entitySrcSyn) {</span>
<span class="source-line-no">686</span><span id="line-686">        this.entitySrcSyn = entitySrcSyn;</span>
<span class="source-line-no">687</span><span id="line-687">    }</span>
<span class="source-line-no">688</span><span id="line-688"></span>
<span class="source-line-no">689</span><span id="line-689">    @Override</span>
<span class="source-line-no">690</span><span id="line-690">    public void consumeEntityPolySeq(EntityPolySeq entityPolySeq) {</span>
<span class="source-line-no">691</span><span id="line-691">        for (int rowIndex = 0; rowIndex &lt; entityPolySeq.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">692</span><span id="line-692">            Chain entityChain = getEntityChain(entityPolySeq.getEntityId().get(rowIndex));</span>
<span class="source-line-no">693</span><span id="line-693"></span>
<span class="source-line-no">694</span><span id="line-694">            // first we check through the chemcomp provider, if it fails we do some heuristics to guess the type of group</span>
<span class="source-line-no">695</span><span id="line-695">            // TODO some of this code is analogous to getNewGroup() and we should try to unify them - JD 2016-03-08</span>
<span class="source-line-no">696</span><span id="line-696"></span>
<span class="source-line-no">697</span><span id="line-697">            Group g = ChemCompGroupFactory.getGroupFromChemCompDictionary(entityPolySeq.getMonId().get(rowIndex));</span>
<span class="source-line-no">698</span><span id="line-698">            //int seqId = Integer.parseInt(entityPolySeq.getNum());</span>
<span class="source-line-no">699</span><span id="line-699">            if (g != null &amp;&amp; !g.getChemComp().isEmpty()) {</span>
<span class="source-line-no">700</span><span id="line-700">                if (g instanceof AminoAcidImpl) {</span>
<span class="source-line-no">701</span><span id="line-701">                    AminoAcidImpl aa = (AminoAcidImpl) g;</span>
<span class="source-line-no">702</span><span id="line-702">                    aa.setRecordType(AminoAcid.SEQRESRECORD);</span>
<span class="source-line-no">703</span><span id="line-703">                }</span>
<span class="source-line-no">704</span><span id="line-704">            } else {</span>
<span class="source-line-no">705</span><span id="line-705">                if (entityPolySeq.getMonId().get(rowIndex).length() == 3 &amp;&amp;</span>
<span class="source-line-no">706</span><span id="line-706">                        StructureTools.get1LetterCodeAmino(entityPolySeq.getMonId().get(rowIndex)) != null) {</span>
<span class="source-line-no">707</span><span id="line-707">                    AminoAcidImpl a = new AminoAcidImpl();</span>
<span class="source-line-no">708</span><span id="line-708">                    a.setRecordType(AminoAcid.SEQRESRECORD);</span>
<span class="source-line-no">709</span><span id="line-709">                    Character code1 = StructureTools.get1LetterCodeAmino(entityPolySeq.getMonId().get(rowIndex));</span>
<span class="source-line-no">710</span><span id="line-710">                    a.setAminoType(code1);</span>
<span class="source-line-no">711</span><span id="line-711">                    g = a;</span>
<span class="source-line-no">712</span><span id="line-712"></span>
<span class="source-line-no">713</span><span id="line-713">                } else if (StructureTools.isNucleotide(entityPolySeq.getMonId().get(rowIndex))) {</span>
<span class="source-line-no">714</span><span id="line-714">                    // the group is actually a nucleotide group...</span>
<span class="source-line-no">715</span><span id="line-715">                    g = new NucleotideImpl();</span>
<span class="source-line-no">716</span><span id="line-716">                } else {</span>
<span class="source-line-no">717</span><span id="line-717">                    logger.debug("Residue {} {} is not a standard aminoacid or nucleotide, will create a het group for it", entityPolySeq.getNum().get(rowIndex), entityPolySeq.getMonId().get(rowIndex));</span>
<span class="source-line-no">718</span><span id="line-718">                    g = new HetatomImpl();</span>
<span class="source-line-no">719</span><span id="line-719">                }</span>
<span class="source-line-no">720</span><span id="line-720">            }</span>
<span class="source-line-no">721</span><span id="line-721">            // at this stage we don't know about author residue numbers (insertion codes)</span>
<span class="source-line-no">722</span><span id="line-722">            // we abuse now the ResidueNumber field setting the internal residue numbers (label_seq_id, strictly</span>
<span class="source-line-no">723</span><span id="line-723">            // sequential and follow the seqres sequence 1 to n)</span>
<span class="source-line-no">724</span><span id="line-724">            // later the actual ResidueNumbers (author residue numbers) have to be corrected in alignSeqRes()</span>
<span class="source-line-no">725</span><span id="line-725">            g.setResidueNumber(ResidueNumber.fromString(entityPolySeq.getNum().getStringData(rowIndex)));</span>
<span class="source-line-no">726</span><span id="line-726">            g.setPDBName(entityPolySeq.getMonId().get(rowIndex));</span>
<span class="source-line-no">727</span><span id="line-727">            entityChain.addGroup(g);</span>
<span class="source-line-no">728</span><span id="line-728">        }</span>
<span class="source-line-no">729</span><span id="line-729">    }</span>
<span class="source-line-no">730</span><span id="line-730"></span>
<span class="source-line-no">731</span><span id="line-731">    private Chain getEntityChain(String entityId) {</span>
<span class="source-line-no">732</span><span id="line-732">        for (Chain chain : entityChains) {</span>
<span class="source-line-no">733</span><span id="line-733">            if (chain.getId().equals(entityId)) {</span>
<span class="source-line-no">734</span><span id="line-734">                return chain;</span>
<span class="source-line-no">735</span><span id="line-735">            }</span>
<span class="source-line-no">736</span><span id="line-736">        }</span>
<span class="source-line-no">737</span><span id="line-737"></span>
<span class="source-line-no">738</span><span id="line-738">        // does not exist yet, so create...</span>
<span class="source-line-no">739</span><span id="line-739">        Chain chain = new ChainImpl();</span>
<span class="source-line-no">740</span><span id="line-740">        chain.setId(entityId);</span>
<span class="source-line-no">741</span><span id="line-741">        entityChains.add(chain);</span>
<span class="source-line-no">742</span><span id="line-742"></span>
<span class="source-line-no">743</span><span id="line-743">        return chain;</span>
<span class="source-line-no">744</span><span id="line-744">    }</span>
<span class="source-line-no">745</span><span id="line-745"></span>
<span class="source-line-no">746</span><span id="line-746">    @Override</span>
<span class="source-line-no">747</span><span id="line-747">    public void consumeExptl(Exptl exptl) {</span>
<span class="source-line-no">748</span><span id="line-748">        for (int rowIndex = 0; rowIndex &lt; exptl.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">749</span><span id="line-749">            pdbHeader.setExperimentalTechnique(exptl.getMethod().get(rowIndex));</span>
<span class="source-line-no">750</span><span id="line-750">        }</span>
<span class="source-line-no">751</span><span id="line-751">    }</span>
<span class="source-line-no">752</span><span id="line-752"></span>
<span class="source-line-no">753</span><span id="line-753">    @Override</span>
<span class="source-line-no">754</span><span id="line-754">    public void consumePdbxAuditRevisionHistory(PdbxAuditRevisionHistory pdbxAuditRevisionHistory) {</span>
<span class="source-line-no">755</span><span id="line-755">        Date date = null;</span>
<span class="source-line-no">756</span><span id="line-756">        for (int rowIndex = 0; rowIndex &lt; pdbxAuditRevisionHistory.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">757</span><span id="line-757">            // first entry in revision history is the release date</span>
<span class="source-line-no">758</span><span id="line-758">            if (pdbxAuditRevisionHistory.getOrdinal().get(rowIndex) == 1) {</span>
<span class="source-line-no">759</span><span id="line-759">                String release = pdbxAuditRevisionHistory.getRevisionDate().get(rowIndex);</span>
<span class="source-line-no">760</span><span id="line-760">                date = convert(LocalDate.parse(release, DATE_FORMAT));</span>
<span class="source-line-no">761</span><span id="line-761">                pdbHeader.setRelDate(date);</span>
<span class="source-line-no">762</span><span id="line-762">            } else {</span>
<span class="source-line-no">763</span><span id="line-763">                // all other dates are revision dates;</span>
<span class="source-line-no">764</span><span id="line-764">                // since this method may be called multiple times,</span>
<span class="source-line-no">765</span><span id="line-765">                // the last revision date will "stick"</span>
<span class="source-line-no">766</span><span id="line-766">                String revision = pdbxAuditRevisionHistory.getRevisionDate().get(rowIndex);</span>
<span class="source-line-no">767</span><span id="line-767">                date = convert(LocalDate.parse(revision, DATE_FORMAT));</span>
<span class="source-line-no">768</span><span id="line-768">            }</span>
<span class="source-line-no">769</span><span id="line-769">            pdbHeader.setModDate(date);</span>
<span class="source-line-no">770</span><span id="line-770">        }</span>
<span class="source-line-no">771</span><span id="line-771">    }</span>
<span class="source-line-no">772</span><span id="line-772"></span>
<span class="source-line-no">773</span><span id="line-773">    @Override</span>
<span class="source-line-no">774</span><span id="line-774">    public void consumePdbxChemCompIdentifier(PdbxChemCompIdentifier pdbxChemCompIdentifier) {</span>
<span class="source-line-no">775</span><span id="line-775">        // TODO not impled in ref</span>
<span class="source-line-no">776</span><span id="line-776">    }</span>
<span class="source-line-no">777</span><span id="line-777"></span>
<span class="source-line-no">778</span><span id="line-778">    @Override</span>
<span class="source-line-no">779</span><span id="line-779">    public void consumePdbxDatabaseStatus(PdbxDatabaseStatus pdbxDatabaseStatus) {</span>
<span class="source-line-no">780</span><span id="line-780">        for (int rowIndex = 0; rowIndex &lt; pdbxDatabaseStatus.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">781</span><span id="line-781">            // the deposition date field is only available in mmCIF 5.0</span>
<span class="source-line-no">782</span><span id="line-782">            StrColumn recvdInitialDepositionDate = pdbxDatabaseStatus.getRecvdInitialDepositionDate();</span>
<span class="source-line-no">783</span><span id="line-783">            if (recvdInitialDepositionDate.isDefined()) {</span>
<span class="source-line-no">784</span><span id="line-784">                String deposition = recvdInitialDepositionDate.get(rowIndex);</span>
<span class="source-line-no">785</span><span id="line-785">                pdbHeader.setDepDate(convert(LocalDate.parse(deposition, DATE_FORMAT)));</span>
<span class="source-line-no">786</span><span id="line-786">            }</span>
<span class="source-line-no">787</span><span id="line-787">        }</span>
<span class="source-line-no">788</span><span id="line-788">    }</span>
<span class="source-line-no">789</span><span id="line-789"></span>
<span class="source-line-no">790</span><span id="line-790">    @Override</span>
<span class="source-line-no">791</span><span id="line-791">    public void consumePdbxEntityBranchDescriptor(PdbxEntityBranchDescriptor pdbxEntityBranchDescriptor) {</span>
<span class="source-line-no">792</span><span id="line-792">        // TODO not considered in ref</span>
<span class="source-line-no">793</span><span id="line-793">    }</span>
<span class="source-line-no">794</span><span id="line-794"></span>
<span class="source-line-no">795</span><span id="line-795">    @Override</span>
<span class="source-line-no">796</span><span id="line-796">    public void consumePdbxMolecule(PdbxMolecule pdbxMolecule) {</span>
<span class="source-line-no">797</span><span id="line-797">        // TODO not considered in ref</span>
<span class="source-line-no">798</span><span id="line-798">    }</span>
<span class="source-line-no">799</span><span id="line-799"></span>
<span class="source-line-no">800</span><span id="line-800">    @Override</span>
<span class="source-line-no">801</span><span id="line-801">    public void consumePdbxMoleculeFeatures(PdbxMoleculeFeatures pdbxMoleculeFeatures) {</span>
<span class="source-line-no">802</span><span id="line-802">        // TODO not considered in ref</span>
<span class="source-line-no">803</span><span id="line-803">    }</span>
<span class="source-line-no">804</span><span id="line-804"></span>
<span class="source-line-no">805</span><span id="line-805">    @Override</span>
<span class="source-line-no">806</span><span id="line-806">    public void consumePdbxNonpolyScheme(PdbxNonpolyScheme pdbxNonpolyScheme) {</span>
<span class="source-line-no">807</span><span id="line-807">        // TODO not impled in ref</span>
<span class="source-line-no">808</span><span id="line-808">    }</span>
<span class="source-line-no">809</span><span id="line-809"></span>
<span class="source-line-no">810</span><span id="line-810">    @Override</span>
<span class="source-line-no">811</span><span id="line-811">    public void consumePdbxReferenceEntityLink(PdbxReferenceEntityLink pdbxReferenceEntityLink) {</span>
<span class="source-line-no">812</span><span id="line-812">        // TODO not considered in ref</span>
<span class="source-line-no">813</span><span id="line-813">    }</span>
<span class="source-line-no">814</span><span id="line-814"></span>
<span class="source-line-no">815</span><span id="line-815">    @Override</span>
<span class="source-line-no">816</span><span id="line-816">    public void consumePdbxReferenceEntityList(PdbxReferenceEntityList pdbxReferenceEntityList) {</span>
<span class="source-line-no">817</span><span id="line-817">        // TODO not considered in ref</span>
<span class="source-line-no">818</span><span id="line-818">    }</span>
<span class="source-line-no">819</span><span id="line-819"></span>
<span class="source-line-no">820</span><span id="line-820">    @Override</span>
<span class="source-line-no">821</span><span id="line-821">    public void consumePdbxReferenceEntityPolyLink(PdbxReferenceEntityPolyLink pdbxReferenceEntityPolyLink) {</span>
<span class="source-line-no">822</span><span id="line-822">        // TODO not considered in ref</span>
<span class="source-line-no">823</span><span id="line-823">    }</span>
<span class="source-line-no">824</span><span id="line-824"></span>
<span class="source-line-no">825</span><span id="line-825">    @Override</span>
<span class="source-line-no">826</span><span id="line-826">    public void consumePdbxStructAssembly(PdbxStructAssembly pdbxStructAssembly) {</span>
<span class="source-line-no">827</span><span id="line-827">        this.structAssembly = pdbxStructAssembly;</span>
<span class="source-line-no">828</span><span id="line-828">    }</span>
<span class="source-line-no">829</span><span id="line-829"></span>
<span class="source-line-no">830</span><span id="line-830">    @Override</span>
<span class="source-line-no">831</span><span id="line-831">    public void consumePdbxStructAssemblyGen(PdbxStructAssemblyGen pdbxStructAssemblyGen) {</span>
<span class="source-line-no">832</span><span id="line-832">        this.structAssemblyGen = pdbxStructAssemblyGen;</span>
<span class="source-line-no">833</span><span id="line-833">    }</span>
<span class="source-line-no">834</span><span id="line-834"></span>
<span class="source-line-no">835</span><span id="line-835">    @Override</span>
<span class="source-line-no">836</span><span id="line-836">    public void consumePdbxStructModResidue(PdbxStructModResidue pdbxStructModResidue) {</span>
<span class="source-line-no">837</span><span id="line-837">        // TODO not considered in ref</span>
<span class="source-line-no">838</span><span id="line-838">    }</span>
<span class="source-line-no">839</span><span id="line-839"></span>
<span class="source-line-no">840</span><span id="line-840">    @Override</span>
<span class="source-line-no">841</span><span id="line-841">    public void consumePdbxStructOperList(PdbxStructOperList pdbxStructOperList) {</span>
<span class="source-line-no">842</span><span id="line-842">        this.structOpers = pdbxStructOperList;</span>
<span class="source-line-no">843</span><span id="line-843">    }</span>
<span class="source-line-no">844</span><span id="line-844"></span>
<span class="source-line-no">845</span><span id="line-845">    @Override</span>
<span class="source-line-no">846</span><span id="line-846">    public void consumeRefine(Refine refine) {</span>
<span class="source-line-no">847</span><span id="line-847">        for (int rowIndex = 0; rowIndex &lt; refine.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">848</span><span id="line-848">            // RESOLUTION</span>
<span class="source-line-no">849</span><span id="line-849">                ValueKind valueKind = refine.getLsDResHigh().getValueKind(rowIndex);</span>
<span class="source-line-no">850</span><span id="line-850">                if (! ValueKind.PRESENT.equals(valueKind)) {</span>
<span class="source-line-no">851</span><span id="line-851">                        continue;</span>
<span class="source-line-no">852</span><span id="line-852">                }</span>
<span class="source-line-no">853</span><span id="line-853">            // in very rare cases (for instance hybrid methods x-ray + neutron diffraction, e.g. 3ins, 4n9m)</span>
<span class="source-line-no">854</span><span id="line-854">            // there are 2 resolution values, one for each method</span>
<span class="source-line-no">855</span><span id="line-855">            // we take the last one found so that behaviour is like in PDB file parsing</span>
<span class="source-line-no">856</span><span id="line-856">            double lsDResHigh = refine.getLsDResHigh().get(rowIndex);</span>
<span class="source-line-no">857</span><span id="line-857">            // TODO this could use a check to keep reasonable values - 1.5 may be overwritten by 0.0</span>
<span class="source-line-no">858</span><span id="line-858">            if (pdbHeader.getResolution() != PDBHeader.DEFAULT_RESOLUTION) {</span>
<span class="source-line-no">859</span><span id="line-859">                logger.warn("More than 1 resolution value present, will use last one {} and discard previous {}",</span>
<span class="source-line-no">860</span><span id="line-860">                        lsDResHigh, String.format("%4.2f",pdbHeader.getResolution()));</span>
<span class="source-line-no">861</span><span id="line-861">            }</span>
<span class="source-line-no">862</span><span id="line-862">            pdbHeader.setResolution((float) lsDResHigh);</span>
<span class="source-line-no">863</span><span id="line-863"></span>
<span class="source-line-no">864</span><span id="line-864">            FloatColumn lsRFactorRFree = refine.getLsRFactorRFree();</span>
<span class="source-line-no">865</span><span id="line-865">            // RFREE</span>
<span class="source-line-no">866</span><span id="line-866">            if (pdbHeader.getRfree() != PDBHeader.DEFAULT_RFREE) {</span>
<span class="source-line-no">867</span><span id="line-867">                logger.warn("More than 1 Rfree value present, will use last one {} and discard previous {}",</span>
<span class="source-line-no">868</span><span id="line-868">                        lsRFactorRFree, String.format("%4.2f",pdbHeader.getRfree()));</span>
<span class="source-line-no">869</span><span id="line-869">            }</span>
<span class="source-line-no">870</span><span id="line-870">            if (lsRFactorRFree.isDefined() &amp;&amp; lsRFactorRFree.getValueKind(rowIndex) == ValueKind.PRESENT) {</span>
<span class="source-line-no">871</span><span id="line-871">                pdbHeader.setRfree((float) lsRFactorRFree.get(rowIndex));</span>
<span class="source-line-no">872</span><span id="line-872">            } else {</span>
<span class="source-line-no">873</span><span id="line-873">                // some entries like 2ifo haven't got this field at all</span>
<span class="source-line-no">874</span><span id="line-874">                logger.info("_refine.ls_R_factor_R_free not present, not parsing Rfree value");</span>
<span class="source-line-no">875</span><span id="line-875">            }</span>
<span class="source-line-no">876</span><span id="line-876"></span>
<span class="source-line-no">877</span><span id="line-877">            // RWORK</span>
<span class="source-line-no">878</span><span id="line-878">            FloatColumn lsRFactorRWork = refine.getLsRFactorRWork();</span>
<span class="source-line-no">879</span><span id="line-879">            if(pdbHeader.getRwork() != PDBHeader.DEFAULT_RFREE) {</span>
<span class="source-line-no">880</span><span id="line-880">                logger.warn("More than 1 R work value present, will use last one {} and discard previous {} ",</span>
<span class="source-line-no">881</span><span id="line-881">                        lsRFactorRWork, String.format("%4.2f",pdbHeader.getRwork()));</span>
<span class="source-line-no">882</span><span id="line-882">            }</span>
<span class="source-line-no">883</span><span id="line-883">            if (lsRFactorRWork.isDefined() &amp;&amp; lsRFactorRWork.getValueKind(rowIndex) == ValueKind.PRESENT) {</span>
<span class="source-line-no">884</span><span id="line-884">                pdbHeader.setRwork((float) lsRFactorRWork.get(rowIndex));</span>
<span class="source-line-no">885</span><span id="line-885">            } else {</span>
<span class="source-line-no">886</span><span id="line-886">                logger.info("_refine.ls_R_factor_R_work not present, not parsing R-work value");</span>
<span class="source-line-no">887</span><span id="line-887">            }</span>
<span class="source-line-no">888</span><span id="line-888">        }</span>
<span class="source-line-no">889</span><span id="line-889">    }</span>
<span class="source-line-no">890</span><span id="line-890"></span>
<span class="source-line-no">891</span><span id="line-891">    @Override</span>
<span class="source-line-no">892</span><span id="line-892">    public void consumeStruct(Struct struct) {</span>
<span class="source-line-no">893</span><span id="line-893">        if (struct.isDefined() &amp;&amp; struct.getTitle().isDefined()) {</span>
<span class="source-line-no">894</span><span id="line-894">            pdbHeader.setTitle(struct.getTitle().get(0));</span>
<span class="source-line-no">895</span><span id="line-895">        }</span>
<span class="source-line-no">896</span><span id="line-896"></span>
<span class="source-line-no">897</span><span id="line-897">        if (struct.isDefined() &amp;&amp; struct.getEntryId().isDefined()) {</span>
<span class="source-line-no">898</span><span id="line-898">            PdbId pdbId;</span>
<span class="source-line-no">899</span><span id="line-899">            String pdbCode = struct.getEntryId().get(0);</span>
<span class="source-line-no">900</span><span id="line-900">            if(pdbCode.isBlank()){</span>
<span class="source-line-no">901</span><span id="line-901">                pdbId = null;</span>
<span class="source-line-no">902</span><span id="line-902">            } else {</span>
<span class="source-line-no">903</span><span id="line-903">                try {</span>
<span class="source-line-no">904</span><span id="line-904">                    pdbId = new PdbId(pdbCode);</span>
<span class="source-line-no">905</span><span id="line-905">                } catch (IllegalArgumentException e) {</span>
<span class="source-line-no">906</span><span id="line-906">                    logger.warn("Malformed PDB ID {}. setting PdbId to null", pdbCode);</span>
<span class="source-line-no">907</span><span id="line-907">                    pdbId = null;</span>
<span class="source-line-no">908</span><span id="line-908">                }</span>
<span class="source-line-no">909</span><span id="line-909">            }</span>
<span class="source-line-no">910</span><span id="line-910">            pdbHeader.setPdbId(pdbId);</span>
<span class="source-line-no">911</span><span id="line-911">            structure.setPdbId(pdbId);</span>
<span class="source-line-no">912</span><span id="line-912">        }</span>
<span class="source-line-no">913</span><span id="line-913">    }</span>
<span class="source-line-no">914</span><span id="line-914"></span>
<span class="source-line-no">915</span><span id="line-915">    @Override</span>
<span class="source-line-no">916</span><span id="line-916">    public void consumeStructAsym(StructAsym structAsym) {</span>
<span class="source-line-no">917</span><span id="line-917">        this.structAsym = structAsym;</span>
<span class="source-line-no">918</span><span id="line-918">    }</span>
<span class="source-line-no">919</span><span id="line-919"></span>
<span class="source-line-no">920</span><span id="line-920">    @Override</span>
<span class="source-line-no">921</span><span id="line-921">    public void consumeStructConf(StructConf structConf) {</span>
<span class="source-line-no">922</span><span id="line-922">        // TODO not considered in ref</span>
<span class="source-line-no">923</span><span id="line-923">    }</span>
<span class="source-line-no">924</span><span id="line-924"></span>
<span class="source-line-no">925</span><span id="line-925">    @Override</span>
<span class="source-line-no">926</span><span id="line-926">    public void consumeStructConn(StructConn structConn) {</span>
<span class="source-line-no">927</span><span id="line-927">        this.structConn = structConn;</span>
<span class="source-line-no">928</span><span id="line-928">    }</span>
<span class="source-line-no">929</span><span id="line-929"></span>
<span class="source-line-no">930</span><span id="line-930">    @Override</span>
<span class="source-line-no">931</span><span id="line-931">    public void consumeStructConnType(StructConnType structConnType) {</span>
<span class="source-line-no">932</span><span id="line-932">        // TODO not considered in ref</span>
<span class="source-line-no">933</span><span id="line-933">    }</span>
<span class="source-line-no">934</span><span id="line-934"></span>
<span class="source-line-no">935</span><span id="line-935">    @Override</span>
<span class="source-line-no">936</span><span id="line-936">    public void consumeStructKeywords(StructKeywords structKeywords) {</span>
<span class="source-line-no">937</span><span id="line-937">        ArrayList&lt;String&gt; keywordsList = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">938</span><span id="line-938"></span>
<span class="source-line-no">939</span><span id="line-939">        StrColumn text = structKeywords.getText();</span>
<span class="source-line-no">940</span><span id="line-940">        if (text.isDefined()) {</span>
<span class="source-line-no">941</span><span id="line-941">            String keywords = text.get(0);</span>
<span class="source-line-no">942</span><span id="line-942">            String[] strings = keywords.split(" *, *");</span>
<span class="source-line-no">943</span><span id="line-943">            for (String string : strings) {</span>
<span class="source-line-no">944</span><span id="line-944">                keywordsList.add(string.trim());</span>
<span class="source-line-no">945</span><span id="line-945">            }</span>
<span class="source-line-no">946</span><span id="line-946">        }</span>
<span class="source-line-no">947</span><span id="line-947">        structure.getPDBHeader().setKeywords(keywordsList);</span>
<span class="source-line-no">948</span><span id="line-948"></span>
<span class="source-line-no">949</span><span id="line-949">        StrColumn pdbxKeywords = structKeywords.getPdbxKeywords();</span>
<span class="source-line-no">950</span><span id="line-950">        if (pdbxKeywords.isDefined()) {</span>
<span class="source-line-no">951</span><span id="line-951">            String keywords = pdbxKeywords.get(0);</span>
<span class="source-line-no">952</span><span id="line-952">            pdbHeader.setClassification(keywords);</span>
<span class="source-line-no">953</span><span id="line-953">            //This field should be left empty. TODO The next line should be removed later</span>
<span class="source-line-no">954</span><span id="line-954">            pdbHeader.setDescription(keywords);</span>
<span class="source-line-no">955</span><span id="line-955">        }</span>
<span class="source-line-no">956</span><span id="line-956">    }</span>
<span class="source-line-no">957</span><span id="line-957"></span>
<span class="source-line-no">958</span><span id="line-958">    @Override</span>
<span class="source-line-no">959</span><span id="line-959">    public void consumeStructNcsOper(StructNcsOper structNcsOper) {</span>
<span class="source-line-no">960</span><span id="line-960">        this.structNcsOper = structNcsOper;</span>
<span class="source-line-no">961</span><span id="line-961">    }</span>
<span class="source-line-no">962</span><span id="line-962"></span>
<span class="source-line-no">963</span><span id="line-963">    @Override</span>
<span class="source-line-no">964</span><span id="line-964">    public void consumeStructRef(StructRef structRef) {</span>
<span class="source-line-no">965</span><span id="line-965">        this.structRef = structRef;</span>
<span class="source-line-no">966</span><span id="line-966">    }</span>
<span class="source-line-no">967</span><span id="line-967"></span>
<span class="source-line-no">968</span><span id="line-968">    @Override</span>
<span class="source-line-no">969</span><span id="line-969">    public void consumeStructRefSeq(StructRefSeq structRefSeq) {</span>
<span class="source-line-no">970</span><span id="line-970">        for (int rowIndex = 0; rowIndex &lt; structRefSeq.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">971</span><span id="line-971">            String refId = structRefSeq.getRefId().get(rowIndex);</span>
<span class="source-line-no">972</span><span id="line-972"></span>
<span class="source-line-no">973</span><span id="line-973">            DBRef dbRef = new DBRef();</span>
<span class="source-line-no">974</span><span id="line-974"></span>
<span class="source-line-no">975</span><span id="line-975">            dbRef.setIdCode(structRefSeq.getPdbxPDBIdCode().isDefined()? structRefSeq.getPdbxPDBIdCode().get(rowIndex):null);</span>
<span class="source-line-no">976</span><span id="line-976">            dbRef.setDbAccession(structRefSeq.getPdbxDbAccession().isDefined()? structRefSeq.getPdbxDbAccession().get(rowIndex):null);</span>
<span class="source-line-no">977</span><span id="line-977">            dbRef.setDbIdCode(structRefSeq.getPdbxDbAccession().isDefined()? structRefSeq.getPdbxDbAccession().get(rowIndex):null);</span>
<span class="source-line-no">978</span><span id="line-978">            dbRef.setChainName(structRefSeq.getPdbxStrandId().get(rowIndex));</span>
<span class="source-line-no">979</span><span id="line-979"></span>
<span class="source-line-no">980</span><span id="line-980">            OptionalInt structRefRowIndex = IntStream.range(0, structRef.getRowCount())</span>
<span class="source-line-no">981</span><span id="line-981">                    .filter(i -&gt; structRef.getId().get(i).equals(refId))</span>
<span class="source-line-no">982</span><span id="line-982">                    .findFirst();</span>
<span class="source-line-no">983</span><span id="line-983"></span>
<span class="source-line-no">984</span><span id="line-984">            if (structRefRowIndex.isPresent()) {</span>
<span class="source-line-no">985</span><span id="line-985">                dbRef.setDatabase(structRef.getDbName().get(structRefRowIndex.getAsInt()));</span>
<span class="source-line-no">986</span><span id="line-986">                dbRef.setDbIdCode(structRef.getDbCode().get(structRefRowIndex.getAsInt()));</span>
<span class="source-line-no">987</span><span id="line-987">            } else {</span>
<span class="source-line-no">988</span><span id="line-988">                logger.info("could not find StructRef `{} for StructRefSeq {}", refId, rowIndex);</span>
<span class="source-line-no">989</span><span id="line-989">            }</span>
<span class="source-line-no">990</span><span id="line-990"></span>
<span class="source-line-no">991</span><span id="line-991">            int seqBegin;</span>
<span class="source-line-no">992</span><span id="line-992">            int seqEnd;</span>
<span class="source-line-no">993</span><span id="line-993"></span>
<span class="source-line-no">994</span><span id="line-994">            try {</span>
<span class="source-line-no">995</span><span id="line-995">                seqBegin = Integer.parseInt(structRefSeq.getPdbxAuthSeqAlignBeg().get(rowIndex));</span>
<span class="source-line-no">996</span><span id="line-996">                seqEnd = Integer.parseInt(structRefSeq.getPdbxAuthSeqAlignEnd().get(rowIndex));</span>
<span class="source-line-no">997</span><span id="line-997">            } catch (NumberFormatException e) {</span>
<span class="source-line-no">998</span><span id="line-998">                // this happens in a few entries, annotation error? e.g. 6eoj</span>
<span class="source-line-no">999</span><span id="line-999">                logger.warn("Couldn't parse pdbx_auth_seq_align_beg/end in _struct_ref_seq. Will not store dbref " +</span>
<span class="source-line-no">1000</span><span id="line-1000">                        "alignment info for accession {}. Error: {}", dbRef.getDbAccession(), e.getMessage());</span>
<span class="source-line-no">1001</span><span id="line-1001">                return;</span>
<span class="source-line-no">1002</span><span id="line-1002">            }</span>
<span class="source-line-no">1003</span><span id="line-1003"></span>
<span class="source-line-no">1004</span><span id="line-1004">            char beginInsCode = ' ';</span>
<span class="source-line-no">1005</span><span id="line-1005">            String pdbxSeqAlignBegInsCode = structRefSeq.getPdbxSeqAlignBegInsCode().get(rowIndex);</span>
<span class="source-line-no">1006</span><span id="line-1006">            if (pdbxSeqAlignBegInsCode.length() &gt; 0) {</span>
<span class="source-line-no">1007</span><span id="line-1007">                beginInsCode = pdbxSeqAlignBegInsCode.charAt(0);</span>
<span class="source-line-no">1008</span><span id="line-1008">            }</span>
<span class="source-line-no">1009</span><span id="line-1009"></span>
<span class="source-line-no">1010</span><span id="line-1010">            char endInsCode = ' ';</span>
<span class="source-line-no">1011</span><span id="line-1011">            String pdbxSeqAlignEndInsCode = structRefSeq.getPdbxSeqAlignEndInsCode().get(rowIndex);</span>
<span class="source-line-no">1012</span><span id="line-1012">            if (pdbxSeqAlignEndInsCode.length() &gt; 0) {</span>
<span class="source-line-no">1013</span><span id="line-1013">                endInsCode = pdbxSeqAlignEndInsCode.charAt(0);</span>
<span class="source-line-no">1014</span><span id="line-1014">            }</span>
<span class="source-line-no">1015</span><span id="line-1015"></span>
<span class="source-line-no">1016</span><span id="line-1016">            if (beginInsCode == '?') {</span>
<span class="source-line-no">1017</span><span id="line-1017">                beginInsCode = ' ';</span>
<span class="source-line-no">1018</span><span id="line-1018">            }</span>
<span class="source-line-no">1019</span><span id="line-1019">            if (endInsCode == '?') {</span>
<span class="source-line-no">1020</span><span id="line-1020">                endInsCode = ' ';</span>
<span class="source-line-no">1021</span><span id="line-1021">            }</span>
<span class="source-line-no">1022</span><span id="line-1022"></span>
<span class="source-line-no">1023</span><span id="line-1023">            dbRef.setSeqBegin(seqBegin);</span>
<span class="source-line-no">1024</span><span id="line-1024">            dbRef.setInsertBegin(beginInsCode);</span>
<span class="source-line-no">1025</span><span id="line-1025">            dbRef.setSeqEnd(seqEnd);</span>
<span class="source-line-no">1026</span><span id="line-1026">            dbRef.setInsertEnd(endInsCode);</span>
<span class="source-line-no">1027</span><span id="line-1027"></span>
<span class="source-line-no">1028</span><span id="line-1028">            int dbSeqBegin = structRefSeq.getDbAlignBeg().get(rowIndex);</span>
<span class="source-line-no">1029</span><span id="line-1029">            int dbSeqEnd = structRefSeq.getDbAlignEnd().get(rowIndex);</span>
<span class="source-line-no">1030</span><span id="line-1030"></span>
<span class="source-line-no">1031</span><span id="line-1031">            char dbBeginInsCode = ' ';</span>
<span class="source-line-no">1032</span><span id="line-1032">            StrColumn pdbxDbAlignBegInsCodeCol = structRefSeq.getPdbxDbAlignBegInsCode();</span>
<span class="source-line-no">1033</span><span id="line-1033">            if (pdbxDbAlignBegInsCodeCol.isDefined()) {</span>
<span class="source-line-no">1034</span><span id="line-1034">                String pdbxDbAlignBegInsCode = pdbxDbAlignBegInsCodeCol.get(rowIndex);</span>
<span class="source-line-no">1035</span><span id="line-1035">                if (pdbxDbAlignBegInsCode.length() &gt; 0) {</span>
<span class="source-line-no">1036</span><span id="line-1036">                    dbBeginInsCode = pdbxDbAlignBegInsCode.charAt(0);</span>
<span class="source-line-no">1037</span><span id="line-1037">                }</span>
<span class="source-line-no">1038</span><span id="line-1038">            }</span>
<span class="source-line-no">1039</span><span id="line-1039"></span>
<span class="source-line-no">1040</span><span id="line-1040">            char dbEndInsCode = ' ';</span>
<span class="source-line-no">1041</span><span id="line-1041">            StrColumn pdbxDbAlignEndInsCodeCol = structRefSeq.getPdbxDbAlignEndInsCode();</span>
<span class="source-line-no">1042</span><span id="line-1042">            if (pdbxDbAlignEndInsCodeCol.isDefined()) {</span>
<span class="source-line-no">1043</span><span id="line-1043">                String pdbxDbAlignEndInsCode = pdbxDbAlignEndInsCodeCol.get(rowIndex);</span>
<span class="source-line-no">1044</span><span id="line-1044">                if (pdbxDbAlignEndInsCode.length() &gt; 0) {</span>
<span class="source-line-no">1045</span><span id="line-1045">                    dbEndInsCode = pdbxDbAlignEndInsCode.charAt(0);</span>
<span class="source-line-no">1046</span><span id="line-1046">                }</span>
<span class="source-line-no">1047</span><span id="line-1047">            }</span>
<span class="source-line-no">1048</span><span id="line-1048"></span>
<span class="source-line-no">1049</span><span id="line-1049">            if (dbBeginInsCode == '?') {</span>
<span class="source-line-no">1050</span><span id="line-1050">                dbBeginInsCode = ' ';</span>
<span class="source-line-no">1051</span><span id="line-1051">            }</span>
<span class="source-line-no">1052</span><span id="line-1052">            if (dbEndInsCode == '?') {</span>
<span class="source-line-no">1053</span><span id="line-1053">                dbEndInsCode = ' ';</span>
<span class="source-line-no">1054</span><span id="line-1054">            }</span>
<span class="source-line-no">1055</span><span id="line-1055"></span>
<span class="source-line-no">1056</span><span id="line-1056">            dbRef.setDbSeqBegin(dbSeqBegin);</span>
<span class="source-line-no">1057</span><span id="line-1057">            dbRef.setIdbnsBegin(dbBeginInsCode);</span>
<span class="source-line-no">1058</span><span id="line-1058">            dbRef.setDbSeqEnd(dbSeqEnd);</span>
<span class="source-line-no">1059</span><span id="line-1059">            dbRef.setIdbnsEnd(dbEndInsCode);</span>
<span class="source-line-no">1060</span><span id="line-1060"></span>
<span class="source-line-no">1061</span><span id="line-1061">            List&lt;DBRef&gt; dbrefs = structure.getDBRefs();</span>
<span class="source-line-no">1062</span><span id="line-1062">            if (dbrefs == null) {</span>
<span class="source-line-no">1063</span><span id="line-1063">                dbrefs = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1064</span><span id="line-1064">            }</span>
<span class="source-line-no">1065</span><span id="line-1065">            dbrefs.add(dbRef);</span>
<span class="source-line-no">1066</span><span id="line-1066"></span>
<span class="source-line-no">1067</span><span id="line-1067">            logger.debug(dbRef.toPDB());</span>
<span class="source-line-no">1068</span><span id="line-1068"></span>
<span class="source-line-no">1069</span><span id="line-1069">            structure.setDBRefs(dbrefs);</span>
<span class="source-line-no">1070</span><span id="line-1070">        }</span>
<span class="source-line-no">1071</span><span id="line-1071">    }</span>
<span class="source-line-no">1072</span><span id="line-1072"></span>
<span class="source-line-no">1073</span><span id="line-1073">    @Override</span>
<span class="source-line-no">1074</span><span id="line-1074">    public void consumeStructRefSeqDif(StructRefSeqDif structRefSeqDif) {</span>
<span class="source-line-no">1075</span><span id="line-1075">        this.structRefSeqDif = structRefSeqDif;</span>
<span class="source-line-no">1076</span><span id="line-1076">    }</span>
<span class="source-line-no">1077</span><span id="line-1077"></span>
<span class="source-line-no">1078</span><span id="line-1078">    @Override</span>
<span class="source-line-no">1079</span><span id="line-1079">    public void consumeStructSheetRange(StructSheetRange structSheetRange) {</span>
<span class="source-line-no">1080</span><span id="line-1080">        // TODO not considered in ref</span>
<span class="source-line-no">1081</span><span id="line-1081">    }</span>
<span class="source-line-no">1082</span><span id="line-1082"></span>
<span class="source-line-no">1083</span><span id="line-1083">    @Override</span>
<span class="source-line-no">1084</span><span id="line-1084">    public void consumeStructSite(StructSite structSite) {</span>
<span class="source-line-no">1085</span><span id="line-1085">        if (params.isHeaderOnly()) {</span>
<span class="source-line-no">1086</span><span id="line-1086">            return;</span>
<span class="source-line-no">1087</span><span id="line-1087">        }</span>
<span class="source-line-no">1088</span><span id="line-1088"></span>
<span class="source-line-no">1089</span><span id="line-1089">        List&lt;Site&gt; sites = structure.getSites();</span>
<span class="source-line-no">1090</span><span id="line-1090">        if (sites == null) {</span>
<span class="source-line-no">1091</span><span id="line-1091">            sites = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1092</span><span id="line-1092">        }</span>
<span class="source-line-no">1093</span><span id="line-1093"></span>
<span class="source-line-no">1094</span><span id="line-1094">        for (int rowIndex = 0; rowIndex &lt; structSite.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">1095</span><span id="line-1095">            Site site = null;</span>
<span class="source-line-no">1096</span><span id="line-1096">            for (Site asite : sites) {</span>
<span class="source-line-no">1097</span><span id="line-1097">                if (asite.getSiteID().equals(structSite.getId().get(rowIndex))) {</span>
<span class="source-line-no">1098</span><span id="line-1098">                    site = asite; // prevent duplicate siteIds</span>
<span class="source-line-no">1099</span><span id="line-1099">                }</span>
<span class="source-line-no">1100</span><span id="line-1100">            }</span>
<span class="source-line-no">1101</span><span id="line-1101"></span>
<span class="source-line-no">1102</span><span id="line-1102">            boolean addSite = false;</span>
<span class="source-line-no">1103</span><span id="line-1103">            if (site == null) {</span>
<span class="source-line-no">1104</span><span id="line-1104">                site = new Site();</span>
<span class="source-line-no">1105</span><span id="line-1105">                addSite = true;</span>
<span class="source-line-no">1106</span><span id="line-1106">            }</span>
<span class="source-line-no">1107</span><span id="line-1107"></span>
<span class="source-line-no">1108</span><span id="line-1108">            site.setSiteID(structSite.getId().get(rowIndex));</span>
<span class="source-line-no">1109</span><span id="line-1109">            site.setDescription(structSite.getDetails().get(rowIndex));</span>
<span class="source-line-no">1110</span><span id="line-1110">            site.setEvCode(structSite.getPdbxEvidenceCode().get(rowIndex));</span>
<span class="source-line-no">1111</span><span id="line-1111"></span>
<span class="source-line-no">1112</span><span id="line-1112">            if (addSite) {</span>
<span class="source-line-no">1113</span><span id="line-1113">                sites.add(site);</span>
<span class="source-line-no">1114</span><span id="line-1114">            }</span>
<span class="source-line-no">1115</span><span id="line-1115">        }</span>
<span class="source-line-no">1116</span><span id="line-1116"></span>
<span class="source-line-no">1117</span><span id="line-1117">        structure.setSites(sites);</span>
<span class="source-line-no">1118</span><span id="line-1118">    }</span>
<span class="source-line-no">1119</span><span id="line-1119"></span>
<span class="source-line-no">1120</span><span id="line-1120">    @Override</span>
<span class="source-line-no">1121</span><span id="line-1121">    public void consumeStructSiteGen(StructSiteGen structSiteGen) {</span>
<span class="source-line-no">1122</span><span id="line-1122">        this.structSiteGen = structSiteGen;</span>
<span class="source-line-no">1123</span><span id="line-1123">    }</span>
<span class="source-line-no">1124</span><span id="line-1124"></span>
<span class="source-line-no">1125</span><span id="line-1125">    @Override</span>
<span class="source-line-no">1126</span><span id="line-1126">    public void consumeSymmetry(Symmetry symmetry) {</span>
<span class="source-line-no">1127</span><span id="line-1127">        for (int rowIndex = 0; rowIndex &lt; symmetry.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">1128</span><span id="line-1128">            String spaceGroupString = symmetry.getSpaceGroupNameH_M().get(rowIndex);</span>
<span class="source-line-no">1129</span><span id="line-1129">            SpaceGroup spaceGroup = SymoplibParser.getSpaceGroup(spaceGroupString);</span>
<span class="source-line-no">1130</span><span id="line-1130">            if (spaceGroup == null) {</span>
<span class="source-line-no">1131</span><span id="line-1131">                logger.warn("Space group '{}' not recognised as a standard space group", spaceGroupString);</span>
<span class="source-line-no">1132</span><span id="line-1132">                structure.getPDBHeader()</span>
<span class="source-line-no">1133</span><span id="line-1133">                        .getCrystallographicInfo()</span>
<span class="source-line-no">1134</span><span id="line-1134">                        .setNonStandardSg(true);</span>
<span class="source-line-no">1135</span><span id="line-1135">            } else {</span>
<span class="source-line-no">1136</span><span id="line-1136">                structure.getPDBHeader()</span>
<span class="source-line-no">1137</span><span id="line-1137">                        .getCrystallographicInfo()</span>
<span class="source-line-no">1138</span><span id="line-1138">                        .setSpaceGroup(spaceGroup);</span>
<span class="source-line-no">1139</span><span id="line-1139">                structure.getPDBHeader()</span>
<span class="source-line-no">1140</span><span id="line-1140">                        .getCrystallographicInfo()</span>
<span class="source-line-no">1141</span><span id="line-1141">                        .setNonStandardSg(false);</span>
<span class="source-line-no">1142</span><span id="line-1142">            }</span>
<span class="source-line-no">1143</span><span id="line-1143">        }</span>
<span class="source-line-no">1144</span><span id="line-1144">    }</span>
<span class="source-line-no">1145</span><span id="line-1145"></span>
<span class="source-line-no">1146</span><span id="line-1146">    @Override</span>
<span class="source-line-no">1147</span><span id="line-1147">    public void finish() {</span>
<span class="source-line-no">1148</span><span id="line-1148">        if (currentChain != null) {</span>
<span class="source-line-no">1149</span><span id="line-1149">            currentChain.addGroup(currentGroup);</span>
<span class="source-line-no">1150</span><span id="line-1150"></span>
<span class="source-line-no">1151</span><span id="line-1151">            Optional&lt;Chain&gt; testChain = currentModel.stream()</span>
<span class="source-line-no">1152</span><span id="line-1152">                    .filter(chain -&gt; chain.getId().equals(currentChain.getId()))</span>
<span class="source-line-no">1153</span><span id="line-1153">                    .findFirst();</span>
<span class="source-line-no">1154</span><span id="line-1154"></span>
<span class="source-line-no">1155</span><span id="line-1155">            if (!testChain.isPresent()) {</span>
<span class="source-line-no">1156</span><span id="line-1156">                currentModel.add(currentChain);</span>
<span class="source-line-no">1157</span><span id="line-1157">            }</span>
<span class="source-line-no">1158</span><span id="line-1158">        } else if (!params.isHeaderOnly()) {</span>
<span class="source-line-no">1159</span><span id="line-1159">            logger.warn("current chain is null at end of document.");</span>
<span class="source-line-no">1160</span><span id="line-1160">        }</span>
<span class="source-line-no">1161</span><span id="line-1161"></span>
<span class="source-line-no">1162</span><span id="line-1162">        allModels.add(currentModel);</span>
<span class="source-line-no">1163</span><span id="line-1163"></span>
<span class="source-line-no">1164</span><span id="line-1164">        initMaps();</span>
<span class="source-line-no">1165</span><span id="line-1165"></span>
<span class="source-line-no">1166</span><span id="line-1166">        for (int rowIndex = 0; rowIndex &lt; structAsym.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">1167</span><span id="line-1167">            String id = structAsym.getId().get(rowIndex);</span>
<span class="source-line-no">1168</span><span id="line-1168">            String entityId = structAsym.getEntityId().get(rowIndex);</span>
<span class="source-line-no">1169</span><span id="line-1169">            logger.debug("Entity {} matches asym_id: {}", entityId, id);</span>
<span class="source-line-no">1170</span><span id="line-1170"></span>
<span class="source-line-no">1171</span><span id="line-1171">            Chain chain = getEntityChain(entityId);</span>
<span class="source-line-no">1172</span><span id="line-1172">            Chain seqRes = (Chain) chain.clone();</span>
<span class="source-line-no">1173</span><span id="line-1173">            // to solve issue #160 (e.g. 3u7t)</span>
<span class="source-line-no">1174</span><span id="line-1174">            seqRes = removeSeqResHeterogeneity(seqRes);</span>
<span class="source-line-no">1175</span><span id="line-1175">            seqRes.setId(id);</span>
<span class="source-line-no">1176</span><span id="line-1176">            seqRes.setName(asymId2authorId.getOrDefault(id, id));</span>
<span class="source-line-no">1177</span><span id="line-1177"></span>
<span class="source-line-no">1178</span><span id="line-1178">            EntityType type = EntityType.entityTypeFromString(getEntityType(entityId));</span>
<span class="source-line-no">1179</span><span id="line-1179">            if (type == null || type == EntityType.POLYMER) {</span>
<span class="source-line-no">1180</span><span id="line-1180">                seqResChains.add(seqRes);</span>
<span class="source-line-no">1181</span><span id="line-1181">            }</span>
<span class="source-line-no">1182</span><span id="line-1182"></span>
<span class="source-line-no">1183</span><span id="line-1183">            logger.debug(" seqres: {} {}&lt;", id, seqRes);</span>
<span class="source-line-no">1184</span><span id="line-1184">            addEntity(rowIndex, entityId, getEntityDescription(entityId), getEntityType(entityId));</span>
<span class="source-line-no">1185</span><span id="line-1185">        }</span>
<span class="source-line-no">1186</span><span id="line-1186"></span>
<span class="source-line-no">1187</span><span id="line-1187">        if (!structAsym.isDefined() || structAsym.getRowCount() == 0) {</span>
<span class="source-line-no">1188</span><span id="line-1188">            logger.warn("No _struct_asym category in file, no SEQRES groups will be added.");</span>
<span class="source-line-no">1189</span><span id="line-1189">        }</span>
<span class="source-line-no">1190</span><span id="line-1190"></span>
<span class="source-line-no">1191</span><span id="line-1191">        // entities</span>
<span class="source-line-no">1192</span><span id="line-1192">        // In addEntities above we created the entities if they were present in the file</span>
<span class="source-line-no">1193</span><span id="line-1193">        // Now we need to make sure that they are linked to chains and also that if they are not present in the file we</span>
<span class="source-line-no">1194</span><span id="line-1194">        // need to add them now</span>
<span class="source-line-no">1195</span><span id="line-1195">        linkEntities();</span>
<span class="source-line-no">1196</span><span id="line-1196"></span>
<span class="source-line-no">1197</span><span id="line-1197">        // now that we know the entities, we can add all chains to structure so that they are stored</span>
<span class="source-line-no">1198</span><span id="line-1198">        // properly as polymer/nonpolymer/water chains inside structure</span>
<span class="source-line-no">1199</span><span id="line-1199">        allModels.forEach(structure::addModel);</span>
<span class="source-line-no">1200</span><span id="line-1200"></span>
<span class="source-line-no">1201</span><span id="line-1201">        // Only align if requested (default) and not when headerOnly mode with no Atoms.</span>
<span class="source-line-no">1202</span><span id="line-1202">        // Otherwise, we store the empty SeqRes Groups unchanged in the right chains.</span>
<span class="source-line-no">1203</span><span id="line-1203">        if (params.isAlignSeqRes() &amp;&amp; !params.isHeaderOnly()){</span>
<span class="source-line-no">1204</span><span id="line-1204">            logger.debug("Parsing mode align_seqres, will parse SEQRES and align to ATOM sequence");</span>
<span class="source-line-no">1205</span><span id="line-1205">            alignSeqRes();</span>
<span class="source-line-no">1206</span><span id="line-1206">        } else {</span>
<span class="source-line-no">1207</span><span id="line-1207">            logger.debug("Parsing mode unalign_seqres, will parse SEQRES but not align it to ATOM sequence");</span>
<span class="source-line-no">1208</span><span id="line-1208">            SeqRes2AtomAligner.storeUnAlignedSeqRes(structure, seqResChains, params.isHeaderOnly());</span>
<span class="source-line-no">1209</span><span id="line-1209">        }</span>
<span class="source-line-no">1210</span><span id="line-1210"></span>
<span class="source-line-no">1211</span><span id="line-1211">        // Now make sure all altlocgroups have all the atoms in all the groups</span>
<span class="source-line-no">1212</span><span id="line-1212">        StructureTools.cleanUpAltLocs(structure);</span>
<span class="source-line-no">1213</span><span id="line-1213"></span>
<span class="source-line-no">1214</span><span id="line-1214">        // NOTE bonds and charges can only be done at this point that the chain id mapping is properly sorted out</span>
<span class="source-line-no">1215</span><span id="line-1215">        if (!params.isHeaderOnly()) {</span>
<span class="source-line-no">1216</span><span id="line-1216">            if (params.shouldCreateAtomBonds()) {</span>
<span class="source-line-no">1217</span><span id="line-1217">                addBonds();</span>
<span class="source-line-no">1218</span><span id="line-1218">            }</span>
<span class="source-line-no">1219</span><span id="line-1219"></span>
<span class="source-line-no">1220</span><span id="line-1220">            if (params.shouldCreateAtomCharges()) {</span>
<span class="source-line-no">1221</span><span id="line-1221">                addCharges();</span>
<span class="source-line-no">1222</span><span id="line-1222">            }</span>
<span class="source-line-no">1223</span><span id="line-1223">        }</span>
<span class="source-line-no">1224</span><span id="line-1224"></span>
<span class="source-line-no">1225</span><span id="line-1225">        if (!params.isHeaderOnly()) {</span>
<span class="source-line-no">1226</span><span id="line-1226">            addSites();</span>
<span class="source-line-no">1227</span><span id="line-1227">        }</span>
<span class="source-line-no">1228</span><span id="line-1228"></span>
<span class="source-line-no">1229</span><span id="line-1229">        // set the oligomeric state info in the header...</span>
<span class="source-line-no">1230</span><span id="line-1230">        if (params.isParseBioAssembly()) {</span>
<span class="source-line-no">1231</span><span id="line-1231">            // the more detailed mapping of chains to rotation operations happens in StructureIO...</span>
<span class="source-line-no">1232</span><span id="line-1232"></span>
<span class="source-line-no">1233</span><span id="line-1233">            Map&lt;Integer, BioAssemblyInfo&gt; bioAssemblies = new LinkedHashMap&lt;&gt;();</span>
<span class="source-line-no">1234</span><span id="line-1234">            for (int i = 0; i &lt; structAssembly.getRowCount(); i++) {</span>
<span class="source-line-no">1235</span><span id="line-1235">                String assemblyId = structAssembly.getId().get(i);</span>
<span class="source-line-no">1236</span><span id="line-1236">                List&lt;Integer&gt; structAssemblyGenIndices = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1237</span><span id="line-1237">                for (int j = 0; j &lt; structAssemblyGen.getRowCount(); j++) {</span>
<span class="source-line-no">1238</span><span id="line-1238">                    if (structAssemblyGen.getAssemblyId().get(j).equals(assemblyId)) {</span>
<span class="source-line-no">1239</span><span id="line-1239">                        structAssemblyGenIndices.add(j);</span>
<span class="source-line-no">1240</span><span id="line-1240">                    }</span>
<span class="source-line-no">1241</span><span id="line-1241">                }</span>
<span class="source-line-no">1242</span><span id="line-1242">                BiologicalAssemblyBuilder builder = new BiologicalAssemblyBuilder();</span>
<span class="source-line-no">1243</span><span id="line-1243">                // these are the transformations that need to be applied to our model</span>
<span class="source-line-no">1244</span><span id="line-1244">                List&lt;BiologicalAssemblyTransformation&gt; transformations = builder.getBioUnitTransformationList(structAssembly,</span>
<span class="source-line-no">1245</span><span id="line-1245">                        i, structAssemblyGen, structOpers);</span>
<span class="source-line-no">1246</span><span id="line-1246"></span>
<span class="source-line-no">1247</span><span id="line-1247">                int bioAssemblyId = -1;</span>
<span class="source-line-no">1248</span><span id="line-1248">                try {</span>
<span class="source-line-no">1249</span><span id="line-1249">                    bioAssemblyId = Integer.parseInt(assemblyId);</span>
<span class="source-line-no">1250</span><span id="line-1250">                } catch (NumberFormatException e) {</span>
<span class="source-line-no">1251</span><span id="line-1251">                    logger.info("Could not parse a numerical bio assembly id from '{}'", assemblyId);</span>
<span class="source-line-no">1252</span><span id="line-1252">                }</span>
<span class="source-line-no">1253</span><span id="line-1253"></span>
<span class="source-line-no">1254</span><span id="line-1254">                // if bioassembly id is not numerical we throw it away</span>
<span class="source-line-no">1255</span><span id="line-1255">                // this happens usually for viral capsid entries, like 1ei7</span>
<span class="source-line-no">1256</span><span id="line-1256">                // see issue #230 in github</span>
<span class="source-line-no">1257</span><span id="line-1257">                if (bioAssemblyId != -1) {</span>
<span class="source-line-no">1258</span><span id="line-1258">                    int mmSize = 0;</span>
<span class="source-line-no">1259</span><span id="line-1259">                    // note that the transforms contain asym ids of both polymers and non-polymers</span>
<span class="source-line-no">1260</span><span id="line-1260">                    // For the mmsize, we are only interested in the polymers</span>
<span class="source-line-no">1261</span><span id="line-1261">                    for (BiologicalAssemblyTransformation transf : transformations) {</span>
<span class="source-line-no">1262</span><span id="line-1262">                        Chain c = structure.getChain(transf.getChainId());</span>
<span class="source-line-no">1263</span><span id="line-1263">                        if (c == null) {</span>
<span class="source-line-no">1264</span><span id="line-1264">                            logger.info("Could not find asym id {} specified in struct_assembly_gen", transf.getChainId());</span>
<span class="source-line-no">1265</span><span id="line-1265">                            continue;</span>
<span class="source-line-no">1266</span><span id="line-1266">                        }</span>
<span class="source-line-no">1267</span><span id="line-1267">                        if (c.getEntityType() == EntityType.POLYMER &amp;&amp;</span>
<span class="source-line-no">1268</span><span id="line-1268">                                // for entries like 4kro, sugars are annotated as polymers but we</span>
<span class="source-line-no">1269</span><span id="line-1269">                                // don't want them in the macromolecularSize count</span>
<span class="source-line-no">1270</span><span id="line-1270">                                !c.getEntityInfo().getDescription().contains("SUGAR")) {</span>
<span class="source-line-no">1271</span><span id="line-1271">                            mmSize++;</span>
<span class="source-line-no">1272</span><span id="line-1272">                        }</span>
<span class="source-line-no">1273</span><span id="line-1273">                    }</span>
<span class="source-line-no">1274</span><span id="line-1274"></span>
<span class="source-line-no">1275</span><span id="line-1275">                    BioAssemblyInfo bioAssembly = new BioAssemblyInfo();</span>
<span class="source-line-no">1276</span><span id="line-1276">                    bioAssembly.setId(bioAssemblyId);</span>
<span class="source-line-no">1277</span><span id="line-1277">                    bioAssembly.setMacromolecularSize(mmSize);</span>
<span class="source-line-no">1278</span><span id="line-1278">                    bioAssembly.setTransforms(transformations);</span>
<span class="source-line-no">1279</span><span id="line-1279">                    bioAssemblies.put(bioAssemblyId, bioAssembly);</span>
<span class="source-line-no">1280</span><span id="line-1280">                }</span>
<span class="source-line-no">1281</span><span id="line-1281"></span>
<span class="source-line-no">1282</span><span id="line-1282">            }</span>
<span class="source-line-no">1283</span><span id="line-1283">            structure.getPDBHeader()</span>
<span class="source-line-no">1284</span><span id="line-1284">                    .setBioAssemblies(bioAssemblies);</span>
<span class="source-line-no">1285</span><span id="line-1285">        }</span>
<span class="source-line-no">1286</span><span id="line-1286"></span>
<span class="source-line-no">1287</span><span id="line-1287">        setStructNcsOps();</span>
<span class="source-line-no">1288</span><span id="line-1288">        setCrystallographicInfoMetadata();</span>
<span class="source-line-no">1289</span><span id="line-1289"></span>
<span class="source-line-no">1290</span><span id="line-1290">        Map&lt;String, List&lt;SeqMisMatch&gt;&gt; misMatchMap = new HashMap&lt;&gt;();</span>
<span class="source-line-no">1291</span><span id="line-1291">        for (int rowIndex = 0; rowIndex &lt; structRefSeqDif.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">1292</span><span id="line-1292">            SeqMisMatch seqMisMatch = new SeqMisMatchImpl();</span>
<span class="source-line-no">1293</span><span id="line-1293">            seqMisMatch.setDetails(structRefSeqDif.getDetails().get(rowIndex));</span>
<span class="source-line-no">1294</span><span id="line-1294"></span>
<span class="source-line-no">1295</span><span id="line-1295">            String insCode = structRefSeqDif.getPdbxPdbInsCode().get(rowIndex);</span>
<span class="source-line-no">1296</span><span id="line-1296">                if ("?".equals(insCode)) {</span>
<span class="source-line-no">1297</span><span id="line-1297">                insCode = null;</span>
<span class="source-line-no">1298</span><span id="line-1298">            }</span>
<span class="source-line-no">1299</span><span id="line-1299">            seqMisMatch.setInsCode(insCode);</span>
<span class="source-line-no">1300</span><span id="line-1300">            seqMisMatch.setOrigGroup(structRefSeqDif.getDbMonId().get(rowIndex));</span>
<span class="source-line-no">1301</span><span id="line-1301">            seqMisMatch.setPdbGroup(structRefSeqDif.getMonId().get(rowIndex));</span>
<span class="source-line-no">1302</span><span id="line-1302">            seqMisMatch.setPdbResNum(structRefSeqDif.getPdbxAuthSeqNum().get(rowIndex));</span>
<span class="source-line-no">1303</span><span id="line-1303">            seqMisMatch.setUniProtId(structRefSeqDif.getPdbxSeqDbAccessionCode().get(rowIndex));</span>
<span class="source-line-no">1304</span><span id="line-1304">            seqMisMatch.setSeqNum(structRefSeqDif.getSeqNum().get(rowIndex));</span>
<span class="source-line-no">1305</span><span id="line-1305"></span>
<span class="source-line-no">1306</span><span id="line-1306">            String strandId = structRefSeqDif.getPdbxPdbStrandId().get(rowIndex);</span>
<span class="source-line-no">1307</span><span id="line-1307">            List&lt;SeqMisMatch&gt; seqMisMatches = misMatchMap.computeIfAbsent(strandId, k -&gt; new ArrayList&lt;&gt;());</span>
<span class="source-line-no">1308</span><span id="line-1308">            seqMisMatches.add(seqMisMatch);</span>
<span class="source-line-no">1309</span><span id="line-1309">        }</span>
<span class="source-line-no">1310</span><span id="line-1310"></span>
<span class="source-line-no">1311</span><span id="line-1311">        for (String chainId : misMatchMap.keySet()){</span>
<span class="source-line-no">1312</span><span id="line-1312">            Chain chain = structure.getPolyChainByPDB(chainId);</span>
<span class="source-line-no">1313</span><span id="line-1313">            if (chain == null) {</span>
<span class="source-line-no">1314</span><span id="line-1314">                logger.warn("Could not set mismatches for chain with author id {}", chainId);</span>
<span class="source-line-no">1315</span><span id="line-1315">                continue;</span>
<span class="source-line-no">1316</span><span id="line-1316">            }</span>
<span class="source-line-no">1317</span><span id="line-1317"></span>
<span class="source-line-no">1318</span><span id="line-1318">            chain.setSeqMisMatches(misMatchMap.get(chainId));</span>
<span class="source-line-no">1319</span><span id="line-1319">        }</span>
<span class="source-line-no">1320</span><span id="line-1320">    }</span>
<span class="source-line-no">1321</span><span id="line-1321"></span>
<span class="source-line-no">1322</span><span id="line-1322">    private String getEntityType(String entityId) {</span>
<span class="source-line-no">1323</span><span id="line-1323">        return IntStream.range(0, entity.getRowCount())</span>
<span class="source-line-no">1324</span><span id="line-1324">                .filter(i -&gt; entity.getId().get(i).equals(entityId))</span>
<span class="source-line-no">1325</span><span id="line-1325">                .mapToObj(i -&gt; entity.getType().get(i))</span>
<span class="source-line-no">1326</span><span id="line-1326">                .findFirst()</span>
<span class="source-line-no">1327</span><span id="line-1327">                .orElseThrow(() -&gt; new NoSuchElementException("could not find entity with id " + entityId));</span>
<span class="source-line-no">1328</span><span id="line-1328">    }</span>
<span class="source-line-no">1329</span><span id="line-1329"></span>
<span class="source-line-no">1330</span><span id="line-1330">    private String getEntityDescription(String entityId) {</span>
<span class="source-line-no">1331</span><span id="line-1331">        return IntStream.range(0, entity.getRowCount())</span>
<span class="source-line-no">1332</span><span id="line-1332">                .filter(i -&gt; entity.getId().get(i).equals(entityId))</span>
<span class="source-line-no">1333</span><span id="line-1333">                .mapToObj(i -&gt; entity.getPdbxDescription().isDefined()? entity.getPdbxDescription().get(i):"")</span>
<span class="source-line-no">1334</span><span id="line-1334">                .findFirst()</span>
<span class="source-line-no">1335</span><span id="line-1335">                .orElseThrow(() -&gt; new NoSuchElementException("could not find entity with id " + entityId));</span>
<span class="source-line-no">1336</span><span id="line-1336">    }</span>
<span class="source-line-no">1337</span><span id="line-1337"></span>
<span class="source-line-no">1338</span><span id="line-1338">    private void addEntity(int asymRowIndex, String entityId, String pdbxDescription, String type) {</span>
<span class="source-line-no">1339</span><span id="line-1339">        int eId = 0;</span>
<span class="source-line-no">1340</span><span id="line-1340">        try {</span>
<span class="source-line-no">1341</span><span id="line-1341">            eId = Integer.parseInt(entityId);</span>
<span class="source-line-no">1342</span><span id="line-1342">        } catch (NumberFormatException e) {</span>
<span class="source-line-no">1343</span><span id="line-1343">            logger.warn("Could not parse mol_id from string {}. Will use 0 for creating Entity", entityId);</span>
<span class="source-line-no">1344</span><span id="line-1344">        }</span>
<span class="source-line-no">1345</span><span id="line-1345"></span>
<span class="source-line-no">1346</span><span id="line-1346">        int entityRowIndex = IntStream.range(0, entity.getRowCount())</span>
<span class="source-line-no">1347</span><span id="line-1347">                .filter(i -&gt; entity.getId().get(i).equals(entityId))</span>
<span class="source-line-no">1348</span><span id="line-1348">                .findFirst()</span>
<span class="source-line-no">1349</span><span id="line-1349">                .orElse(-1);</span>
<span class="source-line-no">1350</span><span id="line-1350"></span>
<span class="source-line-no">1351</span><span id="line-1351">        EntityInfo entityInfo = structure.getEntityById(eId);</span>
<span class="source-line-no">1352</span><span id="line-1352"></span>
<span class="source-line-no">1353</span><span id="line-1353">        if (entityInfo == null) {</span>
<span class="source-line-no">1354</span><span id="line-1354">            entityInfo = new EntityInfo();</span>
<span class="source-line-no">1355</span><span id="line-1355">            entityInfo.setMolId(eId);</span>
<span class="source-line-no">1356</span><span id="line-1356">            // we only add the compound if a polymeric one (to match what the PDB parser does)</span>
<span class="source-line-no">1357</span><span id="line-1357">            if (entityRowIndex != -1) {</span>
<span class="source-line-no">1358</span><span id="line-1358">                entityInfo.setDescription(pdbxDescription);</span>
<span class="source-line-no">1359</span><span id="line-1359"></span>
<span class="source-line-no">1360</span><span id="line-1360">                EntityType eType = EntityType.entityTypeFromString(type);</span>
<span class="source-line-no">1361</span><span id="line-1361">                if (eType != null) {</span>
<span class="source-line-no">1362</span><span id="line-1362">                    entityInfo.setType(eType);</span>
<span class="source-line-no">1363</span><span id="line-1363">                } else {</span>
<span class="source-line-no">1364</span><span id="line-1364">                    logger.warn("Type '{}' is not recognised as a valid entity type for entity {}", type, eId);</span>
<span class="source-line-no">1365</span><span id="line-1365">                }</span>
<span class="source-line-no">1366</span><span id="line-1366">                addAncilliaryEntityData(asymRowIndex, entityInfo);</span>
<span class="source-line-no">1367</span><span id="line-1367">                structure.addEntityInfo(entityInfo);</span>
<span class="source-line-no">1368</span><span id="line-1368">                logger.debug("Adding Entity with entity id {} from _entity, with name: {}", eId,</span>
<span class="source-line-no">1369</span><span id="line-1369">                        entityInfo.getDescription());</span>
<span class="source-line-no">1370</span><span id="line-1370">            }</span>
<span class="source-line-no">1371</span><span id="line-1371">        }</span>
<span class="source-line-no">1372</span><span id="line-1372">    }</span>
<span class="source-line-no">1373</span><span id="line-1373"></span>
<span class="source-line-no">1374</span><span id="line-1374">    private void addAncilliaryEntityData(int asymRowIndex, EntityInfo entityInfo) {</span>
<span class="source-line-no">1375</span><span id="line-1375">        // Loop through each of the entity types and add the corresponding data</span>
<span class="source-line-no">1376</span><span id="line-1376">        // We're assuming if data is duplicated between sources it is consistent</span>
<span class="source-line-no">1377</span><span id="line-1377">        // This is a potentially huge assumption...</span>
<span class="source-line-no">1378</span><span id="line-1378"></span>
<span class="source-line-no">1379</span><span id="line-1379">        for (int rowIndex = 0; rowIndex &lt; entitySrcGen.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">1380</span><span id="line-1380">            if (!entitySrcGen.getEntityId().get(rowIndex).equals(structAsym.getEntityId().get(asymRowIndex))) {</span>
<span class="source-line-no">1381</span><span id="line-1381">                continue;</span>
<span class="source-line-no">1382</span><span id="line-1382">            }</span>
<span class="source-line-no">1383</span><span id="line-1383"></span>
<span class="source-line-no">1384</span><span id="line-1384">            addInformationFromEntitySrcGen(rowIndex, entityInfo);</span>
<span class="source-line-no">1385</span><span id="line-1385">        }</span>
<span class="source-line-no">1386</span><span id="line-1386"></span>
<span class="source-line-no">1387</span><span id="line-1387">        for (int rowIndex = 0; rowIndex &lt; entitySrcNat.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">1388</span><span id="line-1388">            if (!entitySrcNat.getEntityId().get(rowIndex).equals(structAsym.getEntityId().get(asymRowIndex))) {</span>
<span class="source-line-no">1389</span><span id="line-1389">                continue;</span>
<span class="source-line-no">1390</span><span id="line-1390">            }</span>
<span class="source-line-no">1391</span><span id="line-1391"></span>
<span class="source-line-no">1392</span><span id="line-1392">            addInformationFromEntitySrcNat(rowIndex, entityInfo);</span>
<span class="source-line-no">1393</span><span id="line-1393">        }</span>
<span class="source-line-no">1394</span><span id="line-1394"></span>
<span class="source-line-no">1395</span><span id="line-1395">        for (int rowIndex = 0; rowIndex &lt; entitySrcSyn.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">1396</span><span id="line-1396">            if (!entitySrcSyn.getEntityId().get(rowIndex).equals(structAsym.getEntityId().get(asymRowIndex))) {</span>
<span class="source-line-no">1397</span><span id="line-1397">                continue;</span>
<span class="source-line-no">1398</span><span id="line-1398">            }</span>
<span class="source-line-no">1399</span><span id="line-1399"></span>
<span class="source-line-no">1400</span><span id="line-1400">            addInformationFromEntitySrcSyn(rowIndex, entityInfo);</span>
<span class="source-line-no">1401</span><span id="line-1401">        }</span>
<span class="source-line-no">1402</span><span id="line-1402">    }</span>
<span class="source-line-no">1403</span><span id="line-1403"></span>
<span class="source-line-no">1404</span><span id="line-1404">    private void addInformationFromEntitySrcSyn(int rowIndex, EntityInfo entityInfo) {</span>
<span class="source-line-no">1405</span><span id="line-1405">        entityInfo.setOrganismCommon(getCifFieldNullAware(entitySrcSyn.getOrganismCommonName(), rowIndex, null));</span>
<span class="source-line-no">1406</span><span id="line-1406">        entityInfo.setOrganismScientific(getCifFieldNullAware(entitySrcSyn.getOrganismScientific(), rowIndex, null));</span>
<span class="source-line-no">1407</span><span id="line-1407">        entityInfo.setOrganismTaxId(getCifFieldNullAware(entitySrcSyn.getNcbiTaxonomyId(), rowIndex, null));</span>
<span class="source-line-no">1408</span><span id="line-1408">    }</span>
<span class="source-line-no">1409</span><span id="line-1409"></span>
<span class="source-line-no">1410</span><span id="line-1410">    private void addInformationFromEntitySrcNat(int rowIndex, EntityInfo entityInfo) {</span>
<span class="source-line-no">1411</span><span id="line-1411">        entityInfo.setAtcc(getCifFieldNullAware(entitySrcNat.getPdbxAtcc(), rowIndex, null));</span>
<span class="source-line-no">1412</span><span id="line-1412">        entityInfo.setCell(getCifFieldNullAware(entitySrcNat.getPdbxCell(), rowIndex, null));</span>
<span class="source-line-no">1413</span><span id="line-1413">        entityInfo.setOrganismCommon(getCifFieldNullAware(entitySrcNat.getCommonName(), rowIndex, null));</span>
<span class="source-line-no">1414</span><span id="line-1414">        entityInfo.setOrganismScientific(getCifFieldNullAware(entitySrcNat.getPdbxOrganismScientific(), rowIndex, null));</span>
<span class="source-line-no">1415</span><span id="line-1415">        entityInfo.setOrganismTaxId(getCifFieldNullAware(entitySrcNat.getPdbxNcbiTaxonomyId(), rowIndex, null));</span>
<span class="source-line-no">1416</span><span id="line-1416">    }</span>
<span class="source-line-no">1417</span><span id="line-1417"></span>
<span class="source-line-no">1418</span><span id="line-1418">    private void addInformationFromEntitySrcGen(int rowIndex, EntityInfo entityInfo) {</span>
<span class="source-line-no">1419</span><span id="line-1419">        entityInfo.setAtcc(getCifFieldNullAware(entitySrcGen.getPdbxGeneSrcAtcc(), rowIndex, null));</span>
<span class="source-line-no">1420</span><span id="line-1420">        entityInfo.setCell(getCifFieldNullAware(entitySrcGen.getPdbxGeneSrcCell(), rowIndex, null));</span>
<span class="source-line-no">1421</span><span id="line-1421">        entityInfo.setOrganismCommon(getCifFieldNullAware(entitySrcGen.getGeneSrcCommonName(), rowIndex, null));</span>
<span class="source-line-no">1422</span><span id="line-1422">        entityInfo.setOrganismScientific(getCifFieldNullAware(entitySrcGen.getPdbxGeneSrcScientificName(), rowIndex, null));</span>
<span class="source-line-no">1423</span><span id="line-1423">        entityInfo.setOrganismTaxId(getCifFieldNullAware(entitySrcGen.getPdbxGeneSrcNcbiTaxonomyId(), rowIndex, null));</span>
<span class="source-line-no">1424</span><span id="line-1424">        entityInfo.setExpressionSystemTaxId(getCifFieldNullAware(entitySrcGen.getPdbxHostOrgNcbiTaxonomyId(), rowIndex, null));</span>
<span class="source-line-no">1425</span><span id="line-1425">        entityInfo.setExpressionSystem(getCifFieldNullAware(entitySrcGen.getPdbxHostOrgScientificName(), rowIndex, null));</span>
<span class="source-line-no">1426</span><span id="line-1426">    }</span>
<span class="source-line-no">1427</span><span id="line-1427"></span>
<span class="source-line-no">1428</span><span id="line-1428">    private String getCifFieldNullAware(StrColumn column, int rowIndex, String defaultValue) {</span>
<span class="source-line-no">1429</span><span id="line-1429">        if (column.isDefined())</span>
<span class="source-line-no">1430</span><span id="line-1430">            return column.get(rowIndex);</span>
<span class="source-line-no">1431</span><span id="line-1431">        else</span>
<span class="source-line-no">1432</span><span id="line-1432">            return defaultValue;</span>
<span class="source-line-no">1433</span><span id="line-1433">    }</span>
<span class="source-line-no">1434</span><span id="line-1434"></span>
<span class="source-line-no">1435</span><span id="line-1435">    private void setStructNcsOps() {</span>
<span class="source-line-no">1436</span><span id="line-1436">        List&lt;Matrix4d&gt; ncsOperators = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1437</span><span id="line-1437"></span>
<span class="source-line-no">1438</span><span id="line-1438">        for (int rowIndex = 0; rowIndex &lt; structNcsOper.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">1439</span><span id="line-1439">            if (!"generate".equals(structNcsOper.getCode().get(rowIndex))) {</span>
<span class="source-line-no">1440</span><span id="line-1440">                continue;</span>
<span class="source-line-no">1441</span><span id="line-1441">            }</span>
<span class="source-line-no">1442</span><span id="line-1442"></span>
<span class="source-line-no">1443</span><span id="line-1443">            try {</span>
<span class="source-line-no">1444</span><span id="line-1444">                Matrix4d operator = new Matrix4d();</span>
<span class="source-line-no">1445</span><span id="line-1445"></span>
<span class="source-line-no">1446</span><span id="line-1446">                operator.setElement(0, 0, structNcsOper.getMatrix11().get(rowIndex));</span>
<span class="source-line-no">1447</span><span id="line-1447">                operator.setElement(0, 1, structNcsOper.getMatrix12().get(rowIndex));</span>
<span class="source-line-no">1448</span><span id="line-1448">                operator.setElement(0, 2, structNcsOper.getMatrix13().get(rowIndex));</span>
<span class="source-line-no">1449</span><span id="line-1449">                operator.setElement(0, 3, structNcsOper.getVector1().get(rowIndex));</span>
<span class="source-line-no">1450</span><span id="line-1450"></span>
<span class="source-line-no">1451</span><span id="line-1451">                operator.setElement(1, 0, structNcsOper.getMatrix21().get(rowIndex));</span>
<span class="source-line-no">1452</span><span id="line-1452">                operator.setElement(1, 1, structNcsOper.getMatrix22().get(rowIndex));</span>
<span class="source-line-no">1453</span><span id="line-1453">                operator.setElement(1, 2, structNcsOper.getMatrix23().get(rowIndex));</span>
<span class="source-line-no">1454</span><span id="line-1454">                operator.setElement(1, 3, structNcsOper.getVector2().get(rowIndex));</span>
<span class="source-line-no">1455</span><span id="line-1455"></span>
<span class="source-line-no">1456</span><span id="line-1456">                operator.setElement(2, 0, structNcsOper.getMatrix31().get(rowIndex));</span>
<span class="source-line-no">1457</span><span id="line-1457">                operator.setElement(2, 1, structNcsOper.getMatrix32().get(rowIndex));</span>
<span class="source-line-no">1458</span><span id="line-1458">                operator.setElement(2, 2, structNcsOper.getMatrix33().get(rowIndex));</span>
<span class="source-line-no">1459</span><span id="line-1459">                operator.setElement(2, 3, structNcsOper.getVector3().get(rowIndex));</span>
<span class="source-line-no">1460</span><span id="line-1460"></span>
<span class="source-line-no">1461</span><span id="line-1461">                operator.setElement(3, 0, 0);</span>
<span class="source-line-no">1462</span><span id="line-1462">                operator.setElement(3, 1, 0);</span>
<span class="source-line-no">1463</span><span id="line-1463">                operator.setElement(3, 2, 0);</span>
<span class="source-line-no">1464</span><span id="line-1464">                operator.setElement(3, 3, 1);</span>
<span class="source-line-no">1465</span><span id="line-1465"></span>
<span class="source-line-no">1466</span><span id="line-1466">                ncsOperators.add(operator);</span>
<span class="source-line-no">1467</span><span id="line-1467">            } catch (NumberFormatException e) {</span>
<span class="source-line-no">1468</span><span id="line-1468">                logger.warn("Error parsing doubles in NCS operator list, skipping operator {}", rowIndex + 1);</span>
<span class="source-line-no">1469</span><span id="line-1469">            }</span>
<span class="source-line-no">1470</span><span id="line-1470">        }</span>
<span class="source-line-no">1471</span><span id="line-1471"></span>
<span class="source-line-no">1472</span><span id="line-1472">        if (ncsOperators.size() &gt; 0) {</span>
<span class="source-line-no">1473</span><span id="line-1473">            structure.getCrystallographicInfo()</span>
<span class="source-line-no">1474</span><span id="line-1474">                    .setNcsOperators(ncsOperators.toArray(new Matrix4d[0]));</span>
<span class="source-line-no">1475</span><span id="line-1475">        }</span>
<span class="source-line-no">1476</span><span id="line-1476">    }</span>
<span class="source-line-no">1477</span><span id="line-1477"></span>
<span class="source-line-no">1478</span><span id="line-1478">    private void setCrystallographicInfoMetadata() {</span>
<span class="source-line-no">1479</span><span id="line-1479">        if (parsedScaleMatrix != null) {</span>
<span class="source-line-no">1480</span><span id="line-1480">            PDBCrystallographicInfo crystalInfo = structure.getCrystallographicInfo();</span>
<span class="source-line-no">1481</span><span id="line-1481">            boolean nonStd = false;</span>
<span class="source-line-no">1482</span><span id="line-1482">            if (crystalInfo.getCrystalCell() != null &amp;&amp; !crystalInfo.getCrystalCell().checkScaleMatrix(parsedScaleMatrix)) {</span>
<span class="source-line-no">1483</span><span id="line-1483">                nonStd = true;</span>
<span class="source-line-no">1484</span><span id="line-1484">            }</span>
<span class="source-line-no">1485</span><span id="line-1485"></span>
<span class="source-line-no">1486</span><span id="line-1486">            crystalInfo.setNonStandardCoordFrameConvention(nonStd);</span>
<span class="source-line-no">1487</span><span id="line-1487">        }</span>
<span class="source-line-no">1488</span><span id="line-1488">    }</span>
<span class="source-line-no">1489</span><span id="line-1489"></span>
<span class="source-line-no">1490</span><span id="line-1490">    private void addSites() {</span>
<span class="source-line-no">1491</span><span id="line-1491">        List&lt;Site&gt; sites = structure.getSites();</span>
<span class="source-line-no">1492</span><span id="line-1492">        if (sites == null) sites = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1493</span><span id="line-1493"></span>
<span class="source-line-no">1494</span><span id="line-1494">        for (int rowIndex = 0; rowIndex &lt; structSiteGen.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">1495</span><span id="line-1495">            // For each StructSiteGen, find the residues involved, if they exist then</span>
<span class="source-line-no">1496</span><span id="line-1496">            String site_id = structSiteGen.getSiteId().get(rowIndex); // multiple could be in same site.</span>
<span class="source-line-no">1497</span><span id="line-1497">            if (site_id == null) {</span>
<span class="source-line-no">1498</span><span id="line-1498">                site_id = "";</span>
<span class="source-line-no">1499</span><span id="line-1499">            }</span>
<span class="source-line-no">1500</span><span id="line-1500">            String comp_id = structSiteGen.getLabelCompId().get(rowIndex);  // PDBName</span>
<span class="source-line-no">1501</span><span id="line-1501"></span>
<span class="source-line-no">1502</span><span id="line-1502">            // Assumption: the author chain ID and residue number for the site is consistent with the original</span>
<span class="source-line-no">1503</span><span id="line-1503">            // author chain id and residue numbers.</span>
<span class="source-line-no">1504</span><span id="line-1504"></span>
<span class="source-line-no">1505</span><span id="line-1505">            String asymId = structSiteGen.getLabelAsymId().get(rowIndex); // chain name</span>
<span class="source-line-no">1506</span><span id="line-1506">            String authId = structSiteGen.getAuthAsymId().get(rowIndex); // chain Id</span>
<span class="source-line-no">1507</span><span id="line-1507">            String auth_seq_id = structSiteGen.getAuthSeqId().get(rowIndex); // Res num</span>
<span class="source-line-no">1508</span><span id="line-1508"></span>
<span class="source-line-no">1509</span><span id="line-1509">            String insCode = structSiteGen.getPdbxAuthInsCode().get(rowIndex);</span>
<span class="source-line-no">1510</span><span id="line-1510">            if ("?".equals(insCode)) {</span>
<span class="source-line-no">1511</span><span id="line-1511">                insCode = null;</span>
<span class="source-line-no">1512</span><span id="line-1512">            }</span>
<span class="source-line-no">1513</span><span id="line-1513"></span>
<span class="source-line-no">1514</span><span id="line-1514">            // Look for asymID = chainID and seqID = seq_ID.  Check that comp_id matches the resname.</span>
<span class="source-line-no">1515</span><span id="line-1515">            Group g = null;</span>
<span class="source-line-no">1516</span><span id="line-1516">            try {</span>
<span class="source-line-no">1517</span><span id="line-1517">                Chain chain = structure.getChain(asymId);</span>
<span class="source-line-no">1518</span><span id="line-1518"></span>
<span class="source-line-no">1519</span><span id="line-1519">                if (null != chain) {</span>
<span class="source-line-no">1520</span><span id="line-1520">                    try {</span>
<span class="source-line-no">1521</span><span id="line-1521">                        Character insChar = null;</span>
<span class="source-line-no">1522</span><span id="line-1522">                        if (null != insCode &amp;&amp; insCode.length() &gt; 0) {</span>
<span class="source-line-no">1523</span><span id="line-1523">                            insChar = insCode.charAt(0);</span>
<span class="source-line-no">1524</span><span id="line-1524">                        }</span>
<span class="source-line-no">1525</span><span id="line-1525">                        g = chain.getGroupByPDB(new ResidueNumber(null, Integer.parseInt(auth_seq_id), insChar));</span>
<span class="source-line-no">1526</span><span id="line-1526">                    } catch (NumberFormatException e) {</span>
<span class="source-line-no">1527</span><span id="line-1527">                        logger.warn("Could not lookup residue : {}{}", authId, auth_seq_id);</span>
<span class="source-line-no">1528</span><span id="line-1528">                    }</span>
<span class="source-line-no">1529</span><span id="line-1529">                }</span>
<span class="source-line-no">1530</span><span id="line-1530">            } catch (StructureException e) {</span>
<span class="source-line-no">1531</span><span id="line-1531">                logger.warn("Problem finding residue in site entry {} - {}",</span>
<span class="source-line-no">1532</span><span id="line-1532">                        structSiteGen.getSiteId().get(rowIndex), e.getMessage());</span>
<span class="source-line-no">1533</span><span id="line-1533">            }</span>
<span class="source-line-no">1534</span><span id="line-1534"></span>
<span class="source-line-no">1535</span><span id="line-1535">            if (g != null) {</span>
<span class="source-line-no">1536</span><span id="line-1536">                // 2. find the site_id, if not existing, create anew.</span>
<span class="source-line-no">1537</span><span id="line-1537">                Site site = null;</span>
<span class="source-line-no">1538</span><span id="line-1538">                for (Site asite : sites) {</span>
<span class="source-line-no">1539</span><span id="line-1539">                    if (site_id.equals(asite.getSiteID())) {</span>
<span class="source-line-no">1540</span><span id="line-1540">                        site = asite;</span>
<span class="source-line-no">1541</span><span id="line-1541">                    }</span>
<span class="source-line-no">1542</span><span id="line-1542">                }</span>
<span class="source-line-no">1543</span><span id="line-1543"></span>
<span class="source-line-no">1544</span><span id="line-1544">                boolean addSite = false;</span>
<span class="source-line-no">1545</span><span id="line-1545"></span>
<span class="source-line-no">1546</span><span id="line-1546">                // 3. add this residue to the site.</span>
<span class="source-line-no">1547</span><span id="line-1547">                if (site == null) {</span>
<span class="source-line-no">1548</span><span id="line-1548">                    addSite = true;</span>
<span class="source-line-no">1549</span><span id="line-1549">                    site = new Site();</span>
<span class="source-line-no">1550</span><span id="line-1550">                    site.setSiteID(site_id);</span>
<span class="source-line-no">1551</span><span id="line-1551">                }</span>
<span class="source-line-no">1552</span><span id="line-1552"></span>
<span class="source-line-no">1553</span><span id="line-1553">                List&lt;Group&gt; groups = site.getGroups();</span>
<span class="source-line-no">1554</span><span id="line-1554">                if (groups == null) {</span>
<span class="source-line-no">1555</span><span id="line-1555">                    groups = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1556</span><span id="line-1556">                }</span>
<span class="source-line-no">1557</span><span id="line-1557"></span>
<span class="source-line-no">1558</span><span id="line-1558">                // Check the self-consistency of the residue reference from auth_seq_id and chain_id</span>
<span class="source-line-no">1559</span><span id="line-1559">                if (!comp_id.equals(g.getPDBName())) {</span>
<span class="source-line-no">1560</span><span id="line-1560">                    logger.warn("comp_id doesn't match the residue at {} {} - skipping", authId, auth_seq_id);</span>
<span class="source-line-no">1561</span><span id="line-1561">                } else {</span>
<span class="source-line-no">1562</span><span id="line-1562">                    groups.add(g);</span>
<span class="source-line-no">1563</span><span id="line-1563">                    site.setGroups(groups);</span>
<span class="source-line-no">1564</span><span id="line-1564">                }</span>
<span class="source-line-no">1565</span><span id="line-1565">                if (addSite) {</span>
<span class="source-line-no">1566</span><span id="line-1566">                    sites.add(site);</span>
<span class="source-line-no">1567</span><span id="line-1567">                }</span>
<span class="source-line-no">1568</span><span id="line-1568">            }</span>
<span class="source-line-no">1569</span><span id="line-1569">        }</span>
<span class="source-line-no">1570</span><span id="line-1570">        structure.setSites(sites);</span>
<span class="source-line-no">1571</span><span id="line-1571">    }</span>
<span class="source-line-no">1572</span><span id="line-1572"></span>
<span class="source-line-no">1573</span><span id="line-1573">    private void addCharges() {</span>
<span class="source-line-no">1574</span><span id="line-1574">        ChargeAdder.addCharges(structure);</span>
<span class="source-line-no">1575</span><span id="line-1575">    }</span>
<span class="source-line-no">1576</span><span id="line-1576"></span>
<span class="source-line-no">1577</span><span id="line-1577">    /**</span>
<span class="source-line-no">1578</span><span id="line-1578">     * The method will return a new reference to a Chain with any consecutive groups</span>
<span class="source-line-no">1579</span><span id="line-1579">     * having same residue numbers removed.</span>
<span class="source-line-no">1580</span><span id="line-1580">     * This is necessary to solve the microheterogeneity issue in entries like 3u7t (see github issue #160)</span>
<span class="source-line-no">1581</span><span id="line-1581">     */</span>
<span class="source-line-no">1582</span><span id="line-1582">    private static Chain removeSeqResHeterogeneity(Chain c) {</span>
<span class="source-line-no">1583</span><span id="line-1583">        Chain trimmedChain = new ChainImpl();</span>
<span class="source-line-no">1584</span><span id="line-1584">        ResidueNumber lastResNum = null;</span>
<span class="source-line-no">1585</span><span id="line-1585"></span>
<span class="source-line-no">1586</span><span id="line-1586">        for (Group g : c.getAtomGroups()) {</span>
<span class="source-line-no">1587</span><span id="line-1587">            // note we have to deep copy this, otherwise they stay linked and would get altered in addGroup(g)</span>
<span class="source-line-no">1588</span><span id="line-1588">            ResidueNumber currentResNum = new ResidueNumber(</span>
<span class="source-line-no">1589</span><span id="line-1589">                    g.getResidueNumber().getChainName(),</span>
<span class="source-line-no">1590</span><span id="line-1590">                    g.getResidueNumber().getSeqNum(),</span>
<span class="source-line-no">1591</span><span id="line-1591">                    g.getResidueNumber().getInsCode());</span>
<span class="source-line-no">1592</span><span id="line-1592"></span>
<span class="source-line-no">1593</span><span id="line-1593">            if (lastResNum == null || !lastResNum.equals(currentResNum)) {</span>
<span class="source-line-no">1594</span><span id="line-1594">                trimmedChain.addGroup(g);</span>
<span class="source-line-no">1595</span><span id="line-1595">            } else {</span>
<span class="source-line-no">1596</span><span id="line-1596">                logger.debug("Removing seqres group because it seems to be repeated in entity_poly_seq, most likely has hetero='y': {}", g);</span>
<span class="source-line-no">1597</span><span id="line-1597">            }</span>
<span class="source-line-no">1598</span><span id="line-1598">            lastResNum = currentResNum;</span>
<span class="source-line-no">1599</span><span id="line-1599"></span>
<span class="source-line-no">1600</span><span id="line-1600">        }</span>
<span class="source-line-no">1601</span><span id="line-1601">        return trimmedChain;</span>
<span class="source-line-no">1602</span><span id="line-1602">    }</span>
<span class="source-line-no">1603</span><span id="line-1603"></span>
<span class="source-line-no">1604</span><span id="line-1604">    private void addBonds() {</span>
<span class="source-line-no">1605</span><span id="line-1605">        BondMaker maker = new BondMaker(structure, params);</span>
<span class="source-line-no">1606</span><span id="line-1606">        maker.makeBonds();</span>
<span class="source-line-no">1607</span><span id="line-1607">        maker.formBondsFromStructConn(structConn);</span>
<span class="source-line-no">1608</span><span id="line-1608">    }</span>
<span class="source-line-no">1609</span><span id="line-1609"></span>
<span class="source-line-no">1610</span><span id="line-1610">    private void alignSeqRes() {</span>
<span class="source-line-no">1611</span><span id="line-1611">        logger.debug("Parsing mode align_seqres, will align to ATOM to SEQRES sequence");</span>
<span class="source-line-no">1612</span><span id="line-1612"></span>
<span class="source-line-no">1613</span><span id="line-1613">        // fix SEQRES residue numbering for all models</span>
<span class="source-line-no">1614</span><span id="line-1614"></span>
<span class="source-line-no">1615</span><span id="line-1615">        for (int model = 0; model &lt; structure.nrModels(); model++) {</span>
<span class="source-line-no">1616</span><span id="line-1616">            List&lt;Chain&gt; atomList   = structure.getPolyChains(model);</span>
<span class="source-line-no">1617</span><span id="line-1617"></span>
<span class="source-line-no">1618</span><span id="line-1618">            if (seqResChains.isEmpty()) {</span>
<span class="source-line-no">1619</span><span id="line-1619">                // in files without _entity, seqResChains object is empty: we replace by atomChains resulting below in a trivial alignment and a copy of atom groups to seqres groups</span>
<span class="source-line-no">1620</span><span id="line-1620">                seqResChains = atomList;</span>
<span class="source-line-no">1621</span><span id="line-1621">            }</span>
<span class="source-line-no">1622</span><span id="line-1622"></span>
<span class="source-line-no">1623</span><span id="line-1623">            for (Chain seqResChain : seqResChains){</span>
<span class="source-line-no">1624</span><span id="line-1624"></span>
<span class="source-line-no">1625</span><span id="line-1625">                // this extracts the matching atom chain from atomList</span>
<span class="source-line-no">1626</span><span id="line-1626">                Chain atomChain = SeqRes2AtomAligner.getMatchingAtomRes(seqResChain, atomList, true);</span>
<span class="source-line-no">1627</span><span id="line-1627"></span>
<span class="source-line-no">1628</span><span id="line-1628">                if (atomChain == null) {</span>
<span class="source-line-no">1629</span><span id="line-1629">                    // most likely there's no observed residues at all for the seqres chain: can't map</span>
<span class="source-line-no">1630</span><span id="line-1630">                    // e.g. 3zyb: chains with asym_id L,M,N,O,P have no observed residues</span>
<span class="source-line-no">1631</span><span id="line-1631">                    logger.info("Could not map SEQRES chain with asym_id={} to any ATOM chain. Most likely there's " +</span>
<span class="source-line-no">1632</span><span id="line-1632">                            "no observed residues in the chain.", seqResChain.getId());</span>
<span class="source-line-no">1633</span><span id="line-1633">                    continue;</span>
<span class="source-line-no">1634</span><span id="line-1634">                }</span>
<span class="source-line-no">1635</span><span id="line-1635"></span>
<span class="source-line-no">1636</span><span id="line-1636">                //map the atoms to the seqres...</span>
<span class="source-line-no">1637</span><span id="line-1637"></span>
<span class="source-line-no">1638</span><span id="line-1638">                // we need to first clone the seqres so that they stay independent for different models</span>
<span class="source-line-no">1639</span><span id="line-1639">                List&lt;Group&gt; seqResGroups = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1640</span><span id="line-1640">                for (int i = 0; i &lt; seqResChain.getAtomGroups().size(); i++) {</span>
<span class="source-line-no">1641</span><span id="line-1641">                    seqResGroups.add((Group)seqResChain.getAtomGroups().get(i).clone());</span>
<span class="source-line-no">1642</span><span id="line-1642">                }</span>
<span class="source-line-no">1643</span><span id="line-1643"></span>
<span class="source-line-no">1644</span><span id="line-1644">                for (int seqResPos = 0 ; seqResPos &lt; seqResGroups.size(); seqResPos++) {</span>
<span class="source-line-no">1645</span><span id="line-1645">                    Group seqresG = seqResGroups.get(seqResPos);</span>
<span class="source-line-no">1646</span><span id="line-1646">                    boolean found = false;</span>
<span class="source-line-no">1647</span><span id="line-1647">                    for (Group atomG : atomChain.getAtomGroups()) {</span>
<span class="source-line-no">1648</span><span id="line-1648"></span>
<span class="source-line-no">1649</span><span id="line-1649">                        int internalNr = getInternalNr(atomG);</span>
<span class="source-line-no">1650</span><span id="line-1650"></span>
<span class="source-line-no">1651</span><span id="line-1651">                        if (seqresG.getResidueNumber().getSeqNum() == internalNr) {</span>
<span class="source-line-no">1652</span><span id="line-1652">                            seqResGroups.set(seqResPos, atomG);</span>
<span class="source-line-no">1653</span><span id="line-1653">                            found = true;</span>
<span class="source-line-no">1654</span><span id="line-1654">                            break;</span>
<span class="source-line-no">1655</span><span id="line-1655">                        }</span>
<span class="source-line-no">1656</span><span id="line-1656">                    }</span>
<span class="source-line-no">1657</span><span id="line-1657"></span>
<span class="source-line-no">1658</span><span id="line-1658">                    if (!found)</span>
<span class="source-line-no">1659</span><span id="line-1659">                        // so far the residue number has tracked internal numbering.</span>
<span class="source-line-no">1660</span><span id="line-1660">                        // however there are no atom records, as such this can't be a PDB residue number...</span>
<span class="source-line-no">1661</span><span id="line-1661">                        seqresG.setResidueNumber(null);</span>
<span class="source-line-no">1662</span><span id="line-1662">                }</span>
<span class="source-line-no">1663</span><span id="line-1663">                atomChain.setSeqResGroups(seqResGroups);</span>
<span class="source-line-no">1664</span><span id="line-1664">            }</span>
<span class="source-line-no">1665</span><span id="line-1665">        }</span>
<span class="source-line-no">1666</span><span id="line-1666">    }</span>
<span class="source-line-no">1667</span><span id="line-1667"></span>
<span class="source-line-no">1668</span><span id="line-1668">    private int getInternalNr(Group atomG) {</span>
<span class="source-line-no">1669</span><span id="line-1669">        if (atomG.getType().equals(GroupType.AMINOACID)) {</span>
<span class="source-line-no">1670</span><span id="line-1670">            AminoAcidImpl aa = (AminoAcidImpl) atomG;</span>
<span class="source-line-no">1671</span><span id="line-1671">            return (int) aa.getId();</span>
<span class="source-line-no">1672</span><span id="line-1672">        } else if (atomG.getType().equals(GroupType.NUCLEOTIDE)) {</span>
<span class="source-line-no">1673</span><span id="line-1673">            NucleotideImpl nu = (NucleotideImpl) atomG;</span>
<span class="source-line-no">1674</span><span id="line-1674">            return (int) nu.getId();</span>
<span class="source-line-no">1675</span><span id="line-1675">        } else {</span>
<span class="source-line-no">1676</span><span id="line-1676">            HetatomImpl he = (HetatomImpl) atomG;</span>
<span class="source-line-no">1677</span><span id="line-1677">            return (int) he.getId();</span>
<span class="source-line-no">1678</span><span id="line-1678">        }</span>
<span class="source-line-no">1679</span><span id="line-1679">    }</span>
<span class="source-line-no">1680</span><span id="line-1680"></span>
<span class="source-line-no">1681</span><span id="line-1681">    private void linkEntities() {</span>
<span class="source-line-no">1682</span><span id="line-1682">        for (List&lt;Chain&gt; allModel : allModels) {</span>
<span class="source-line-no">1683</span><span id="line-1683">            for (Chain chain : allModel) {</span>
<span class="source-line-no">1684</span><span id="line-1684">                //logger.info("linking entities for " + chain.getId() + " "  + chain.getName());</span>
<span class="source-line-no">1685</span><span id="line-1685">                String entityId = asymId2entityId.get(chain.getId());</span>
<span class="source-line-no">1686</span><span id="line-1686"></span>
<span class="source-line-no">1687</span><span id="line-1687">                if (entityId == null) {</span>
<span class="source-line-no">1688</span><span id="line-1688">                    // this can happen for instance if the cif file didn't have _struct_asym category at all</span>
<span class="source-line-no">1689</span><span id="line-1689">                    // and thus we have no asymId2entityId mapping at all</span>
<span class="source-line-no">1690</span><span id="line-1690">                    logger.info("No entity id could be found for chain {}", chain.getId());</span>
<span class="source-line-no">1691</span><span id="line-1691">                    continue;</span>
<span class="source-line-no">1692</span><span id="line-1692">                }</span>
<span class="source-line-no">1693</span><span id="line-1693"></span>
<span class="source-line-no">1694</span><span id="line-1694">                int eId = Integer.parseInt(entityId);</span>
<span class="source-line-no">1695</span><span id="line-1695"></span>
<span class="source-line-no">1696</span><span id="line-1696">                // Entities are not added for non-polymeric entities, if a chain is non-polymeric its entity won't be found.</span>
<span class="source-line-no">1697</span><span id="line-1697">                // TODO: add all entities and unique compounds and add methods to directly get polymer or non-polymer</span>
<span class="source-line-no">1698</span><span id="line-1698">                // asyms (chains).  Either create a unique StructureImpl or modify existing for a better representation of the</span>
<span class="source-line-no">1699</span><span id="line-1699">                // mmCIF internal data structures but is compatible with Structure interface.</span>
<span class="source-line-no">1700</span><span id="line-1700">                // Some examples of PDB entries with this kind of problem:</span>
<span class="source-line-no">1701</span><span id="line-1701">                //   - 2uub: asym_id X, chainName Z, entity_id 24: fully non-polymeric but still with its own chainName</span>
<span class="source-line-no">1702</span><span id="line-1702">                //   - 3o6j: asym_id K, chainName Z, entity_id 6 : a single water molecule</span>
<span class="source-line-no">1703</span><span id="line-1703">                //   - 1dz9: asym_id K, chainName K, entity_id 6 : a potassium ion alone</span>
<span class="source-line-no">1704</span><span id="line-1704"></span>
<span class="source-line-no">1705</span><span id="line-1705">                EntityInfo entityInfo = structure.getEntityById(eId);</span>
<span class="source-line-no">1706</span><span id="line-1706">                if (entityInfo == null) {</span>
<span class="source-line-no">1707</span><span id="line-1707">                    // Supports the case where the only chain members were from non-polymeric entity that is missing.</span>
<span class="source-line-no">1708</span><span id="line-1708">                    // Solved by creating a new Compound(entity) to which this chain will belong.</span>
<span class="source-line-no">1709</span><span id="line-1709">                    logger.info("Could not find an Entity for entity_id {}, for chain id {}, creating a new Entity.",</span>
<span class="source-line-no">1710</span><span id="line-1710">                            eId, chain.getId());</span>
<span class="source-line-no">1711</span><span id="line-1711">                    entityInfo = new EntityInfo();</span>
<span class="source-line-no">1712</span><span id="line-1712">                    entityInfo.setMolId(eId);</span>
<span class="source-line-no">1713</span><span id="line-1713">                    entityInfo.addChain(chain);</span>
<span class="source-line-no">1714</span><span id="line-1714">                    if (chain.isWaterOnly()) {</span>
<span class="source-line-no">1715</span><span id="line-1715">                        entityInfo.setType(EntityType.WATER);</span>
<span class="source-line-no">1716</span><span id="line-1716">                    } else {</span>
<span class="source-line-no">1717</span><span id="line-1717">                        entityInfo.setType(EntityType.NONPOLYMER);</span>
<span class="source-line-no">1718</span><span id="line-1718">                    }</span>
<span class="source-line-no">1719</span><span id="line-1719">                    chain.setEntityInfo(entityInfo);</span>
<span class="source-line-no">1720</span><span id="line-1720">                    structure.addEntityInfo(entityInfo);</span>
<span class="source-line-no">1721</span><span id="line-1721">                } else {</span>
<span class="source-line-no">1722</span><span id="line-1722">                    logger.debug("Adding chain with chain id {} (auth id {}) to Entity with entity_id {}",</span>
<span class="source-line-no">1723</span><span id="line-1723">                            chain.getId(), chain.getName(), eId);</span>
<span class="source-line-no">1724</span><span id="line-1724">                    entityInfo.addChain(chain);</span>
<span class="source-line-no">1725</span><span id="line-1725">                    chain.setEntityInfo(entityInfo);</span>
<span class="source-line-no">1726</span><span id="line-1726">                }</span>
<span class="source-line-no">1727</span><span id="line-1727"></span>
<span class="source-line-no">1728</span><span id="line-1728">            }</span>
<span class="source-line-no">1729</span><span id="line-1729"></span>
<span class="source-line-no">1730</span><span id="line-1730">        }</span>
<span class="source-line-no">1731</span><span id="line-1731"></span>
<span class="source-line-no">1732</span><span id="line-1732">        // if no entity information was present in file we then go and find the entities heuristically with EntityFinder</span>
<span class="source-line-no">1733</span><span id="line-1733">        List&lt;EntityInfo&gt; entityInfos = structure.getEntityInfos();</span>
<span class="source-line-no">1734</span><span id="line-1734">        if (entityInfos == null || entityInfos.isEmpty()) {</span>
<span class="source-line-no">1735</span><span id="line-1735">            List&lt;List&lt;Chain&gt;&gt; polyModels = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1736</span><span id="line-1736">            List&lt;List&lt;Chain&gt;&gt; nonPolyModels = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1737</span><span id="line-1737">            List&lt;List&lt;Chain&gt;&gt; waterModels = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1738</span><span id="line-1738"></span>
<span class="source-line-no">1739</span><span id="line-1739">            for (List&lt;Chain&gt; model : allModels) {</span>
<span class="source-line-no">1740</span><span id="line-1740">                List&lt;Chain&gt; polyChains = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1741</span><span id="line-1741">                List&lt;Chain&gt; nonPolyChains = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1742</span><span id="line-1742">                List&lt;Chain&gt; waterChains = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1743</span><span id="line-1743"></span>
<span class="source-line-no">1744</span><span id="line-1744">                polyModels.add(polyChains);</span>
<span class="source-line-no">1745</span><span id="line-1745">                nonPolyModels.add(nonPolyChains);</span>
<span class="source-line-no">1746</span><span id="line-1746">                waterModels.add(waterChains);</span>
<span class="source-line-no">1747</span><span id="line-1747"></span>
<span class="source-line-no">1748</span><span id="line-1748">                for (Chain chain : model) {</span>
<span class="source-line-no">1749</span><span id="line-1749">                    // we only have entities for polymeric chains, all others are ignored for assigning entities</span>
<span class="source-line-no">1750</span><span id="line-1750">                    if (chain.isWaterOnly()) {</span>
<span class="source-line-no">1751</span><span id="line-1751">                        waterChains.add(chain);</span>
<span class="source-line-no">1752</span><span id="line-1752">                    } else if (chain.isPureNonPolymer()) {</span>
<span class="source-line-no">1753</span><span id="line-1753">                        nonPolyChains.add(chain);</span>
<span class="source-line-no">1754</span><span id="line-1754">                    } else {</span>
<span class="source-line-no">1755</span><span id="line-1755">                        polyChains.add(chain);</span>
<span class="source-line-no">1756</span><span id="line-1756">                    }</span>
<span class="source-line-no">1757</span><span id="line-1757">                }</span>
<span class="source-line-no">1758</span><span id="line-1758">            }</span>
<span class="source-line-no">1759</span><span id="line-1759"></span>
<span class="source-line-no">1760</span><span id="line-1760">            entityInfos = EntityFinder.findPolyEntities(polyModels);</span>
<span class="source-line-no">1761</span><span id="line-1761">            EntityFinder.createPurelyNonPolyEntities(nonPolyModels, waterModels, entityInfos);</span>
<span class="source-line-no">1762</span><span id="line-1762"></span>
<span class="source-line-no">1763</span><span id="line-1763">            structure.setEntityInfos(entityInfos);</span>
<span class="source-line-no">1764</span><span id="line-1764">        }</span>
<span class="source-line-no">1765</span><span id="line-1765"></span>
<span class="source-line-no">1766</span><span id="line-1766">        // final sanity check: it can happen that from the annotated entities some are not linked to any chains</span>
<span class="source-line-no">1767</span><span id="line-1767">        // e.g. 3s26: a sugar entity does not have any chains associated to it (it seems to be happening with many sugar compounds)</span>
<span class="source-line-no">1768</span><span id="line-1768">        // we simply log it, this can sign some other problems if the entities are used down the line</span>
<span class="source-line-no">1769</span><span id="line-1769">        for (EntityInfo e : entityInfos) {</span>
<span class="source-line-no">1770</span><span id="line-1770">            if (e.getChains().isEmpty()) {</span>
<span class="source-line-no">1771</span><span id="line-1771">                logger.info("Entity {} '{}' has no chains associated to it",</span>
<span class="source-line-no">1772</span><span id="line-1772">                        e.getMolId() &lt; 0 ? "with no entity id" : e.getMolId(), e.getDescription());</span>
<span class="source-line-no">1773</span><span id="line-1773">            }</span>
<span class="source-line-no">1774</span><span id="line-1774">        }</span>
<span class="source-line-no">1775</span><span id="line-1775">    }</span>
<span class="source-line-no">1776</span><span id="line-1776"></span>
<span class="source-line-no">1777</span><span id="line-1777">    private void initMaps() {</span>
<span class="source-line-no">1778</span><span id="line-1778">        if (structAsym == null || !structAsym.isDefined() || structAsym.getRowCount() == 0) {</span>
<span class="source-line-no">1779</span><span id="line-1779">            logger.info("No _struct_asym category found in file. No asym id to entity_id mapping will be available");</span>
<span class="source-line-no">1780</span><span id="line-1780">            return;</span>
<span class="source-line-no">1781</span><span id="line-1781">        }</span>
<span class="source-line-no">1782</span><span id="line-1782"></span>
<span class="source-line-no">1783</span><span id="line-1783">        Map&lt;String, List&lt;String&gt;&gt; entityId2asymId = new HashMap&lt;&gt;();</span>
<span class="source-line-no">1784</span><span id="line-1784">        for (int rowIndex = 0; rowIndex &lt; structAsym.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">1785</span><span id="line-1785">            String id = structAsym.getId().get(rowIndex);</span>
<span class="source-line-no">1786</span><span id="line-1786">            String entityId = structAsym.getEntityId().get(rowIndex);</span>
<span class="source-line-no">1787</span><span id="line-1787"></span>
<span class="source-line-no">1788</span><span id="line-1788">            logger.debug("Entity {} matches asym_id: {}", entityId, id);</span>
<span class="source-line-no">1789</span><span id="line-1789"></span>
<span class="source-line-no">1790</span><span id="line-1790">            asymId2entityId.put(id, entityId);</span>
<span class="source-line-no">1791</span><span id="line-1791"></span>
<span class="source-line-no">1792</span><span id="line-1792">            if (entityId2asymId.containsKey(entityId)) {</span>
<span class="source-line-no">1793</span><span id="line-1793">                List&lt;String&gt; asymIds = entityId2asymId.get(entityId);</span>
<span class="source-line-no">1794</span><span id="line-1794">                asymIds.add(id);</span>
<span class="source-line-no">1795</span><span id="line-1795">            } else {</span>
<span class="source-line-no">1796</span><span id="line-1796">                List&lt;String&gt; asymIds = new ArrayList&lt;&gt;();</span>
<span class="source-line-no">1797</span><span id="line-1797">                asymIds.add(id);</span>
<span class="source-line-no">1798</span><span id="line-1798">                entityId2asymId.put(entityId, asymIds);</span>
<span class="source-line-no">1799</span><span id="line-1799">            }</span>
<span class="source-line-no">1800</span><span id="line-1800">        }</span>
<span class="source-line-no">1801</span><span id="line-1801"></span>
<span class="source-line-no">1802</span><span id="line-1802">        if (entityPoly == null || !entityPoly.isDefined() || entityPoly.getRowCount() == 0) {</span>
<span class="source-line-no">1803</span><span id="line-1803">            logger.info("No _entity_poly category found in file. No asym id to author id mapping will be available " +</span>
<span class="source-line-no">1804</span><span id="line-1804">                    "for header only parsing");</span>
<span class="source-line-no">1805</span><span id="line-1805">            return;</span>
<span class="source-line-no">1806</span><span id="line-1806">        }</span>
<span class="source-line-no">1807</span><span id="line-1807"></span>
<span class="source-line-no">1808</span><span id="line-1808">        for (int rowIndex = 0; rowIndex &lt; entityPoly.getRowCount(); rowIndex++) {</span>
<span class="source-line-no">1809</span><span id="line-1809">            if (!entityPoly.getPdbxStrandId().isDefined()) {</span>
<span class="source-line-no">1810</span><span id="line-1810">                logger.info("_entity_poly.pdbx_strand_id is null for entity {}. Won't be able to map asym ids to " +</span>
<span class="source-line-no">1811</span><span id="line-1811">                        "author ids for this entity.", entityPoly.getEntityId().get(rowIndex));</span>
<span class="source-line-no">1812</span><span id="line-1812">                break;</span>
<span class="source-line-no">1813</span><span id="line-1813">            }</span>
<span class="source-line-no">1814</span><span id="line-1814"></span>
<span class="source-line-no">1815</span><span id="line-1815">            String[] chainNames = entityPoly.getPdbxStrandId().get(rowIndex).split(",");</span>
<span class="source-line-no">1816</span><span id="line-1816">            List&lt;String&gt; asymIds = entityId2asymId.get(entityPoly.getEntityId().get(rowIndex));</span>
<span class="source-line-no">1817</span><span id="line-1817">            if (chainNames.length != asymIds.size()) {</span>
<span class="source-line-no">1818</span><span id="line-1818">                logger.warn("The list of asym ids (from _struct_asym) and the list of author ids (from _entity_poly) " +</span>
<span class="source-line-no">1819</span><span id="line-1819">                        "for entity {} have different lengths! Can't provide a mapping from asym ids to author chain " +</span>
<span class="source-line-no">1820</span><span id="line-1820">                        "ids", entityPoly.getEntityId().get(rowIndex));</span>
<span class="source-line-no">1821</span><span id="line-1821">                break;</span>
<span class="source-line-no">1822</span><span id="line-1822">            }</span>
<span class="source-line-no">1823</span><span id="line-1823"></span>
<span class="source-line-no">1824</span><span id="line-1824">            for (int i = 0; i &lt; chainNames.length; i++) {</span>
<span class="source-line-no">1825</span><span id="line-1825">                asymId2authorId.put(asymIds.get(i), chainNames[i]);</span>
<span class="source-line-no">1826</span><span id="line-1826">            }</span>
<span class="source-line-no">1827</span><span id="line-1827">        }</span>
<span class="source-line-no">1828</span><span id="line-1828">    }</span>
<span class="source-line-no">1829</span><span id="line-1829"></span>
<span class="source-line-no">1830</span><span id="line-1830">    @Override</span>
<span class="source-line-no">1831</span><span id="line-1831">    public Structure getContainer() {</span>
<span class="source-line-no">1832</span><span id="line-1832">        return structure;</span>
<span class="source-line-no">1833</span><span id="line-1833">    }</span>
<span class="source-line-no">1834</span><span id="line-1834">}</span>




























































</pre>
</div>
</main>
</body>
</html>
